<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/><link rel="alternate" href="/rss.xml" title="何必要叹气呢？" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="何必要叹气呢？" type="application/atom+xml"><link rel="alternate" type="application/json" title="何必要叹气呢？" href="https://www.htired.top/feed.json"/><link rel="preconnect" href="https://s4.zstatic.net"/><link rel="preconnect" href="https://at.alicdn.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.11"><link rel="modulepreload" href="/js/chunk-6AROBX2M.js"></link><link rel="modulepreload" href="/js/chunk-CDFWGKAZ.js"></link><link rel="modulepreload" href="/js/chunk-NGTPZFEZ.js"></link><link rel="modulepreload" href="/js/chunk-T5KHDXD7.js"></link><link rel="modulepreload" href="/js/chunk-UCNSAKJE.js"></link><link rel="modulepreload" href="/js/chunk-WIQECBEN.js"></link><link rel="modulepreload" href="/js/comments-YMZC2DEK.js"></link><link rel="modulepreload" href="/js/copy-tex-5ZQCB5LC.js"></link><link rel="modulepreload" href="/js/index.esm-UQTDDMFT.js"></link><link rel="modulepreload" href="/js/post-GXBO3POO.js"></link><link rel="modulepreload" href="/js/quicklink-Q3LCUN34.js"></link><link rel="modulepreload" href="/js/search-HYBAVWN7.js"></link><link rel="modulepreload" href="/js/siteInit.js"></link><link rel="modulepreload" href="/js/waline-2AUA5EA7.js"></link><link rel="stylesheet" href="/css/comments-SJZAII77.css" media="none" onload="this.media&#x3D;&#39;all&#39;"></link><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media&#x3D;&#39;all&#39;"></link><link rel="stylesheet" href="/css/waline-ZFRMIHOE.css" media="none" onload="this.media&#x3D;&#39;all&#39;"></link><link rel="preload" href="https://github.com/htired/MyPic/blob/main/img/t1.png?raw=true" as="image" fetchpriority="high"><link rel="preload" href="https://github.com/htired/MyPic/blob/main/img/6c1bc1deb312449195a8c6a802e916c1.jpg?raw=true" as="image" fetchpriority="high"><link rel="preload" href="https://github.com/htired/MyPic/blob/main/img/4fc551ee880a11ebb6edd017c2d2eca2.jpg?raw=true" as="image" fetchpriority="high"><link rel="preload" href="https://github.com/htired/MyPic/blob/main/img/81d1da7e1ba142629967fea196c73e0e.jpg?raw=true" as="image" fetchpriority="high"><link rel="preload" href="https://github.com/htired/MyPic/blob/main/img/792a4b6934fc491b81342206e3192e59.png?raw=true" as="image" fetchpriority="high"><link rel="preload" href="https://github.com/htired/MyPic/blob/main/img/a47a423f9d1c42f8895c53c72f27ff87.jpg?raw=true" as="image" fetchpriority="high"><meta name="description" content="送君南浦，伤如之何？"/><link rel="canonical" href="https://www.htired.top/2023/06/02/os/2%E3%80%81%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/"><title>2、进程管理</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">2、进程管理</h1><div class="meta"><span class="item" title="创建时间：2023-06-02 15:59:38"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2023-06-02T15:59:38+08:00">2023-06-02</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>115k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>1:44</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Htired Love</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" style="background-image: url(&quot;https://github.com/htired/MyPic/blob/main/img/t1.png?raw=true&quot;);"></li><li class="item" style="background-image: url(&quot;https://github.com/htired/MyPic/blob/main/img/6c1bc1deb312449195a8c6a802e916c1.jpg?raw=true&quot;);"></li><li class="item" style="background-image: url(&quot;https://github.com/htired/MyPic/blob/main/img/4fc551ee880a11ebb6edd017c2d2eca2.jpg?raw=true&quot;);"></li><li class="item" style="background-image: url(&quot;https://github.com/htired/MyPic/blob/main/img/81d1da7e1ba142629967fea196c73e0e.jpg?raw=true&quot;);"></li><li class="item" style="background-image: url(&quot;https://github.com/htired/MyPic/blob/main/img/792a4b6934fc491b81342206e3192e59.png?raw=true&quot;);"></li><li class="item" style="background-image: url(&quot;https://github.com/htired/MyPic/blob/main/img/a47a423f9d1c42f8895c53c72f27ff87.jpg?raw=true&quot;);"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/os/" itemprop="item" rel="index" title="分类于操作系统"><span itemprop="name">操作系统<meta itemprop="position" content="0"/></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.htired.top/2023/06/02/os/2%E3%80%81%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"/><meta itemprop="name" content="htired"/><meta itemprop="description" content="路还很长，这不是最终的结果, 送君南浦，伤如之何？"/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="何必要叹气呢？"/></span><div class="body md" itemprop="articleBody"><h1 id="进程的定义-组成-组织方式-特征"><a class="anchor" href="#进程的定义-组成-组织方式-特征">#</a> 进程的定义、组成、组织方式、特征</h1>
<p><strong>整体框架</strong></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117215111334.png" alt="image-20230117215111334" /></p>
<h2 id="进程的定义"><a class="anchor" href="#进程的定义">#</a> 进程的定义</h2>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>程序</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}程序</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">程序</span></span></span></span>：就是一个指令序列</p>
<p>早期的计算机（只支持<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>单道</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}单道</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">单道</span></span></span></span>程序）</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117002208545.png" alt="image-20230117002208545" /></p>
<hr />
<p>引入<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>多道</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}多道</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">多道</span></span></span></span>程序之后：</p>
<p>为了方便操作操作系统管理，完成各个程序并发执行、</p>
<ul>
<li>引入了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程、进程实体</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程、进程实体</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程、进程实体</span></span></span></span>的概念</li>
</ul>
<p><strong>PCB</strong>、程序段、数据段三部分构成了</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程实体</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程实体</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程实体</span></span></span></span>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程映像</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程映像</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程映像</span></span></span></span>）</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117002527274.png" alt="image-20230117002527274" /></p>
<hr />
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>程序段、数据段、</mtext><mtext mathvariant="monospace">PCB</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}程序段、数据段、\texttt{PCB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">程序段、数据段、</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">PCB</span></span></span></span></span> 三部分组成了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程实体</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程实体</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程实体</span></span></span></span>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程映像</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程映像</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程映像</span></span></span></span>）。</p>
<ul>
<li>
<p>一般情况下，我们把进程实体就简称为进程，</p>
<p>例如，所谓<strong>创建</strong>进程，实质上是创建进程实体中的 <strong>PCB</strong> ;</p>
<p>而<strong>撤销</strong>进程，实质上是撤销进程实体中的 <strong>PCB</strong>。</p>
</li>
</ul>
<p>注意：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext mathvariant="monospace">PCB</mtext><mtext>是进程存在的唯一标志</mtext><mo stretchy="false">!</mo></mstyle></mrow><annotation encoding="application/x-tex">\color{red}\texttt{PCB}是进程存在的唯一标志!</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">PCB</span></span><span class="mord cjk_fallback" style="color:red;">是进程存在的唯一标志</span><span class="mclose" style="color:red;">!</span></span></span></span></p>
<p>从不同的角度，进程可以有不同的定义，比较传统典型的定义有:</p>
<ol>
<li>
<p>进程是程序的一次<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="blue"><mtext>执行过程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{blue}执行过程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:blue;">执行过程</span></span></span></span>。</p>
</li>
<li>
<p>进程是一个程序及其数据在处理机上顺序执行时所<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="blue"><mtext>发生的活动</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{blue}发生的活动</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:blue;">发生的活动</span></span></span></span>。</p>
</li>
<li>
<p>进程是具有独立功能的程序在数据集合上运行的过程，</p>
<p>它是系统进行资源分配和调度的一个独立单位</p>
</li>
</ol>
<p>上述都是强调进程的 “<strong>动态性</strong>”</p>
<p>引入进程实体的概念后，可把进程定义为:</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程</span></span></span></span>是进程实体的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="blue"><mtext>运行过程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{blue}运行过程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:blue;">运行过程</span></span></span></span>，</p>
<ul>
<li>是系统进行<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>资源分配</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}资源分配</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">资源分配</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>调度</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}调度</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">调度</span></span></span></span>的一个独立单位。</li>
</ul>
<p><strong>注</strong>：严格来说，进程实体和进程并不一样，</p>
<ul>
<li>
<p>进程实体是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>静态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}静态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">静态</span></span></span></span>的，</p>
<p>进程则是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>动态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}动态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">动态</span></span></span></span>的。</p>
</li>
<li>
<p>不过，除非题目专门考察二者区别，否则可以认为进程实体就是进程。</p>
<p>因此我们也可以说 “进程由程序段、数据段、<strong>PCB</strong> 三部分组成”</p>
</li>
</ul>
<hr />
<h2 id="进程的组成"><a class="anchor" href="#进程的组成">#</a> 进程的组成</h2>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程实体</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程实体</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程实体</span></span></span></span>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程映像</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程映像</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程映像</span></span></span></span>）由<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>程序段、数据段、</mtext><mtext mathvariant="monospace">PCB</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}程序段、数据段、\texttt{PCB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">程序段、数据段、</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">PCB</span></span></span></span></span> 三部分组成。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117211512854.png" alt="image-20230117211512854" /></p>
<hr />
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117212141173.png" alt="image-20230117212141173" /></p>
<p>不同的书籍，分类方式可能不同</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117212443678.png" alt="image-20230117212443678" /></p>
<hr />
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117212829049.png" alt="image-20230117212829049" /></p>
<h2 id="进程的组织"><a class="anchor" href="#进程的组织">#</a> 进程的组织</h2>
<p>在一个系统中，通常有数十、数百乃至数千个 <strong>PCB</strong> 。为了能对他们加以有效的管理，应该用适当的方式把这些 PCB 组织起来。</p>
<p><strong>注</strong>：进程的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>组成</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}组成</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">组成</span></span></span></span>讨论的是一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程内部</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程内部</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程内部</span></span></span></span>由哪些部分构成的问题，</p>
<ul>
<li>而进程的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>组织</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}组织</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">组织</span></span></span></span>讨论的是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>多个进程之间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}多个进程之间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">多个进程之间</span></span></span></span>的组织方式问题</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117213233841.png" alt="image-20230117213233841" /></p>
<hr />
<h3 id="链接方式"><a class="anchor" href="#链接方式">#</a> 链接方式</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117213419831.png" alt="image-20230117213419831" /></p>
<h3 id="索引方式"><a class="anchor" href="#索引方式">#</a> 索引方式</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117213449777.png" alt="image-20230117213449777" /></p>
<h2 id="进程的特征"><a class="anchor" href="#进程的特征">#</a> 进程的特征</h2>
<p>进程和程序是两个截然不同的概念，相比于程序，进程拥有以下特征:</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117214312658.png" alt="image-20230117214312658" /></p>
<p><strong>动态性</strong>是进程最基本的特征</p>
<p><strong>进程</strong>是资源分配、接受调度的基本单位</p>
<p><strong>异步性</strong>会导致并发程序执行结果的不确定性。</p>
<ul>
<li>具体在 &quot;进程同步&quot;</li>
</ul>
<hr />
<h2 id="整体框架"><a class="anchor" href="#整体框架">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117215057478.png" alt="image-20230117215057478" /></p>
<h1 id="进程的状态与转换"><a class="anchor" href="#进程的状态与转换">#</a> 进程的状态与转换</h1>
<p><strong>整体框架</strong></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117230245740.png" alt="image-20230117230245740" /></p>
<h2 id="三种基本状态"><a class="anchor" href="#三种基本状态">#</a> 三种基本状态</h2>
<p>进程是程序的一次执行。在这个执行过程中，有时进程正在被 <strong>CPU</strong> 处理，有时又需要等待 <strong>CPU</strong> 服务，</p>
<ul>
<li>可见进程的状态是会有各种变化。</li>
</ul>
<p>为了方便对各个进程的管理，操作系统需要将进程合理地划分为几种状态</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117220117707.png" alt="image-20230117220117707" /></p>
<p>① 运行态：</p>
<p><strong>注意</strong>：单核处理机的环境下，每一个时刻最多只有一个进程处于运行态</p>
<p>（双核环境下可以同时有两个进程处于运行态）</p>
<p>② 就绪态：</p>
<p>进程已经拥有除处理机之外所有需要的组员，一旦获得处理机。即可立即进入运行态开始运行<br />
即：万事具备，只欠 <strong>CPU</strong></p>
<p>③ 阻塞态：</p>
<p>如：等待操作系统分配打印机、等待读磁盘操作的结果。</p>
<p><strong>CPU</strong> 是计算机中最昂贵的部件，为了提高 <strong>CPU</strong> 的利用率，需要先将其他进程需要的资源分配到位，才能得到 <strong>CPU</strong> 的服务</p>
<ul>
<li>例如：运行态中的某个进程向请求 <strong>I/O</strong> 设备，就需要进入阻塞态，等待这些资源的分配完成再进入就绪态，等待 <strong>CPU</strong> 的服务</li>
</ul>
<hr />
<h2 id="另外两种状态"><a class="anchor" href="#另外两种状态">#</a> 另外两种状态</h2>
<p>操作系统需要完成创建进程。</p>
<ul>
<li>
<p>操作系统为该进程分配所需的内存空间等系统资源，</p>
<p>并为其创建、初始化 <strong>PCB</strong>（如：为进程分配 <strong>PID</strong>）</p>
</li>
</ul>
<p>进程运行结束（或者由于 <strong>bug</strong> 导致进程无法继续执行下去，比如数组越界错误），</p>
<ul>
<li>需要撤销进程。</li>
</ul>
<p>操作系统需要完成<strong>撤销进程</strong>相关的工作。</p>
<ul>
<li>完成将分配给进程的<strong>资源回收</strong>，撤销进程 <strong>PCB</strong> 等工作</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117224723360.png" alt="image-20230117224723360" /></p>
<h2 id="进程状态的转换"><a class="anchor" href="#进程状态的转换">#</a> 进程状态的转换</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117225258230.png" alt="image-20230117225258230" /></p>
<h2 id="整体框架-2"><a class="anchor" href="#整体框架-2">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117230239298.png" alt="image-20230117230239298" /></p>
<h1 id="进程控制"><a class="anchor" href="#进程控制">#</a> 进程控制</h1>
<p><strong>整体框架</strong></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118000302814.png" alt="image-20230118000302814" /></p>
<h2 id="什么是进程控制"><a class="anchor" href="#什么是进程控制">#</a> 什么是进程控制？</h2>
<p>进程控制的<strong>主要功能</strong>是对系统中的所有进程实施<strong>有效的管理</strong>，</p>
<ul>
<li>它具有创建新进程、撤销已有进程、实现进程状态转换等功能。</li>
</ul>
<p>简单来说：进程控制就是要实现进程状态转换</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117230603946.png" alt="image-20230117230603946" /></p>
<h2 id="如何实现进程控制"><a class="anchor" href="#如何实现进程控制">#</a> 如何实现进程控制？</h2>
<h3 id="进程控制-2"><a class="anchor" href="#进程控制-2">#</a> 进程控制</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117230722966.png" alt="image-20230117230722966" /></p>
<hr />
<p>① 创建进程：需要初始化 <strong>PCB</strong>、分配系统资源</p>
<ul>
<li>创建态 -&gt; 就绪态，需要修改 <strong>PCB</strong> 内容和相应队列</li>
</ul>
<p>② 就绪态 -&gt; 运行态 需要<strong>恢复</strong>进程运行环境、修改 <strong>PCB</strong> 内容和相应队列</p>
<ul>
<li>恢复进程运行环境因为进程可能在运行中就因为某个原因让出了 <strong>CPU</strong>，这一次又抢到了 <strong>CPU</strong> 时间片，需要从之前中断的地方开始执行</li>
</ul>
<p>③ 运行态 -&gt; 阻塞态 需要<strong>保存</strong>进程运行环境、修改 <strong>PCB</strong> 内容和相应队列</p>
<ul>
<li>保存进程运行环境因为进程因为某个原因让出了 <strong>CPU</strong>，在某段时间后可能还会再次抢到 <strong>CPU</strong>，需要从之前中断的地方开始执行</li>
</ul>
<p>④ 阻塞态 -&gt; 就绪态 需要修改 <strong>PCB</strong> 内容和相应队列。</p>
<ul>
<li>如果等待的是资源，则还需为进程分配系统资源</li>
</ul>
<p>⑤ 运行态 -&gt; 就绪态（进程切换）需要<strong>保存</strong>进程运行环境、修改 <strong>PCB</strong> 内容和相应队列</p>
<p>⑥ 运行态 -&gt; 终止态 需回收进程拥有的资源，撤销 <strong>CPU</strong></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117231942791.png" alt="image-20230117231942791" /></p>
<h3 id="原语"><a class="anchor" href="#原语">#</a> 原语</h3>
<p>原语是一种<strong>特殊的程序</strong>，处于操作系统最顶层，是最接近硬件的部分</p>
<p>用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>原语</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}原语</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">原语</span></span></span></span>实现进程控制。</p>
<p>原语的<strong>特点</strong>是执行期间<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不允许中断</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不允许中断</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不允许中断</span></span></span></span>，</p>
<ul>
<li>只能一气呵成。</li>
</ul>
<p>这种不可被中断的操作即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>原子操作</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}原子操作</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">原子操作</span></span></span></span>。</p>
<p>原语采用 “<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>关中断</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}关中断</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">关中断</span></span></span></span>指令” 和 “<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>开中断</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}开中断</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">开中断</span></span></span></span>指令” 实现</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117232406577.png" alt="image-20230117232406577" /></p>
<p>显然，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>关</mtext><mi mathvariant="normal">/</mi><mtext>开中断指令</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}关/开中断指令</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord cjk_fallback" style="color:red;">关</span><span class="mord" style="color:red;">/</span><span class="mord cjk_fallback" style="color:red;">开中断指令</span></span></span></span>的权限非常大，</p>
<ul>
<li>必然是只允许在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>核心态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}核心态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">核心态</span></span></span></span>下执行的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>特权指令</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}特权指令</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">特权指令</span></span></span></span></li>
</ul>
<p>原语属于操作系统内核的一部分</p>
<hr />
<h3 id="进程控制相关的原语"><a class="anchor" href="#进程控制相关的原语">#</a> 进程控制相关的原语</h3>
<p>学习技巧：进程控制会导致进程状态的转换。无论哪个原语，要做的无非三类事情:</p>
<ol>
<li>
<p>更新 <strong>PCB</strong> 中的信息（如修改进程状态标志、将运行环境保存到 <strong>PCB</strong> 、从 <strong>PCB</strong> 恢复运行环境)</p>
<p>a. 所有的进程控制原语一定都会<strong>修改进程状态标志</strong></p>
<p>b. 剥夺当前运行进程的 <strong>CPU</strong> 使用权必然需要保存其运行环境</p>
<p>c. 某进程开始运行前必然要恢复期运行环境</p>
</li>
<li>
<p>将 <strong>PCB</strong> 插入合适的队列</p>
</li>
<li>
<p>分配 / 回收资源</p>
</li>
</ol>
<h4 id="进程的创建原语"><a class="anchor" href="#进程的创建原语">#</a> 进程的创建原语</h4>
<p>无 -&gt; 创建态 -&gt; 就绪态</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117235534164.png" alt="image-20230117235534164" /></p>
<hr />
<h4 id="进程的终止原语"><a class="anchor" href="#进程的终止原语">#</a> 进程的终止原语</h4>
<p>就绪态 / 阻塞态 / 运行态 -&gt; 终止态 -&gt; 无</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117235508349.png" alt="image-20230117235508349" /></p>
<h4 id="进程的阻塞和唤醒原语"><a class="anchor" href="#进程的阻塞和唤醒原语">#</a> 进程的阻塞和唤醒原语</h4>
<p>阻塞原语与唤醒原语必须<strong>成对使用</strong></p>
<p>阻塞原语：运行态 -&gt; 阻塞态</p>
<p>唤醒原语：阻塞态 -&gt; 运行态</p>
<p>因何事阻塞，就应何事唤醒</p>
<p>即：解铃还须系铃人</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117235347280.png" alt="image-20230117235347280" /></p>
<h4 id="进程的切换原语"><a class="anchor" href="#进程的切换原语">#</a> 进程的切换原语</h4>
<p>运行态 -&gt; 阻塞态 / 就绪态</p>
<p>就绪态 -&gt; 运行态</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230117235832204.png" alt="image-20230117235832204" /></p>
<h2 id="整体框架-3"><a class="anchor" href="#整体框架-3">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118000302814.png" alt="image-20230118000302814" /></p>
<p>各原语可以实现怎样的状态转换</p>
<p>各原语大概做了哪些事情</p>
<h1 id="进程通信"><a class="anchor" href="#进程通信">#</a> 进程通信</h1>
<p><strong>整体框架</strong></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118222146010.png" alt="image-20230118222146010" /></p>
<h2 id="什么是进程通信"><a class="anchor" href="#什么是进程通信">#</a> 什么是进程通信？</h2>
<p>顾名思义，进程通信就是指进程之间的信息交换。</p>
<p>进程是分配系统资源的单位（包括内存地址空间)，</p>
<ul>
<li>因此<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>各进程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}各进程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">各进程</span></span></span></span>拥有的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>内存地址空间相互独立</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}内存地址空间相互独立</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">内存地址空间相互独立</span></span></span></span>。</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118214914239.png" alt="image-20230118214914239" /></p>
<p>为了保证安全，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>一个进程不能直接访问另一个进程的地址空间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}一个进程不能直接访问另一个进程的地址空间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">一个进程不能直接访问另一个进程的地址空间</span></span></span></span></p>
<p>但是进程之间的信息交换又是必须实现的。</p>
<p>为了保证进程间的安全通信，操作系统提供了一些方法。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118215015724.png" alt="image-20230118215015724" /></p>
<h2 id="共享存储"><a class="anchor" href="#共享存储">#</a> 共享存储</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118215242272.png" alt="image-20230118215242272" /></p>
<p>两个进程对共享空间的<strong>访问</strong>必须是<strong>互斥</strong>的（互斥访问通过操作系统提供的工具实现）。</p>
<p>操作系统只负责提供共享空间和同步互斥工具（如 <strong>P</strong>、<strong>V</strong> 操作）</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118215558218.png" alt="image-20230118215558218" /></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>基于数据结构</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}基于数据结构</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">基于数据结构</span></span></span></span>的共享：</p>
<ul>
<li>
<p>比如共享空间里只能放一个长度为 10 的数组。</p>
</li>
<li>
<p>这种共享方式速度慢、限制多，</p>
</li>
<li>
<p>是一种<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>低级通信</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}低级通信</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">低级通信</span></span></span></span>方式</p>
</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>基于存储区</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}基于存储区</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">基于存储区</span></span></span></span>的共享：</p>
<ul>
<li>
<p>在内存中画出一块共享存储区，数据的形式、存放位置都由<strong>进程控制</strong>，而不是操作系统。</p>
</li>
<li>
<p>相比之下，这种共享方式速度更快，</p>
</li>
<li>
<p>是一种<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>高级通信</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}高级通信</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">高级通信</span></span></span></span>方式。</p>
</li>
</ul>
<h2 id="管道通信"><a class="anchor" href="#管道通信">#</a> 管道通信</h2>
<p>“管道” 是指用于连接读写进程的一个<strong>共享文件</strong>，</p>
<ul>
<li>又名  <code>pipe</code>  文件。</li>
<li>其实就是在内存中开辟一个大小固定的<strong>缓冲区</strong></li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118215739247.png" alt="image-20230118215739247" /></p>
<p>管道只能采用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>半双工通信</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}半双工通信</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">半双工通信</span></span></span></span>，某一时间段内只能实现单向的传输。</p>
<ul>
<li>如果要实现双向同时通信，则需要设置<strong>两个管道</strong>。</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118215947722.png" alt="image-20230118215947722" /></p>
<p>首先进程 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 会往管道中写数据， 当管道中的数据写满了之后进程 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> 才可以开始往外读数据</p>
<p>只有这个数据全部被读出后，进程 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 才可以继续往里面写数据</p>
<hr />
<p>数据以字符流的形式写入管道，当<strong>管道写满</strong>时，<strong>写进程</strong>的  <code> write()</code>  系统调用将被<strong>阻塞</strong>，等待读进程将数据取走。</p>
<p>当读进程将数据全部取走后 **，管道变空 **，此时<strong>读进程</strong>的  <code>read()</code>  系统调用将被<strong>阻塞</strong>。</p>
<hr />
<p>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>没写满</mtext><mo separator="true">,</mo><mtext>就不允许读</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}没写满,就不允许读</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord cjk_fallback" style="color:red;">没写满</span><span class="mpunct" style="color:red;">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord cjk_fallback" style="color:red;">就不允许读</span></span></span></span>。</p>
<p>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>没读空</mtext><mo separator="true">,</mo><mtext>就不允许写</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}没读空,就不允许写</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord cjk_fallback" style="color:red;">没读空</span><span class="mpunct" style="color:red;">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord cjk_fallback" style="color:red;">就不允许写</span></span></span></span>。</p>
<p>数据一旦被读出，就从管道中被抛弃，</p>
<ul>
<li>
<p>这就意味着<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>读进程最多只能有一个</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}读进程最多只能有一个</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">读进程最多只能有一个</span></span></span></span>，</p>
<p>否则可能会有读错数据的情况。</p>
</li>
</ul>
<h2 id="消息传递"><a class="anchor" href="#消息传递">#</a> 消息传递</h2>
<p>进程间的数据交换以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>格式化的消息</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}格式化的消息</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">格式化的消息</span></span></span></span>（ <code>Message</code> ）为单位。</p>
<p>进程通过操作系统提供的 “发送消息 / 接收消息” 两个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>原语</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}原语</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">原语</span></span></span></span>进行数据交换。</p>
<p>例如： <code>TCP</code>  报文段的首部就是消息头，数据载荷就是消息体</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118220813617.png" alt="image-20230118220813617" /></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118221019141.png" alt="image-20230118221019141" /></p>
<h3 id="直接通信方式"><a class="anchor" href="#直接通信方式">#</a> 直接通信方式</h3>
<p>消息直接挂到<strong>接收进程</strong>的消息缓存队列上</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118221051455.png" alt="image-20230118221051455" /></p>
<h3 id="间接通信方式"><a class="anchor" href="#间接通信方式">#</a> 间接通信方式</h3>
<p>消息要先发送到<strong>中间实体</strong>（信箱）中，因此也称 “信箱通信方式” 。</p>
<ul>
<li>Eg：计网中的电子邮件系统</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118221353103.png" alt="image-20230118221353103" /></p>
<h2 id="整体框架-4"><a class="anchor" href="#整体框架-4">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118222138424.png" alt="image-20230118222138424" /></p>
<h1 id="线程概念和多线程模型"><a class="anchor" href="#线程概念和多线程模型">#</a> 线程概念和多线程模型</h1>
<p><strong>整体框架</strong></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230119002426983.png" alt="image-20230119002426983" /></p>
<h2 id="什么是线程为什么要引入线程"><a class="anchor" href="#什么是线程为什么要引入线程">#</a> 什么是线程，为什么要引入线程？</h2>
<p>还没有引入进程之前，各个程序只能串行执行</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118222749992.png" alt="image-20230118222749992" /></p>
<p>进程是程序的一次执行过程，但这些功能显然<strong>不可能</strong>是由一个程序顺序处理就能实现的</p>
<hr />
<p>有的进程可能需要 “同时” 做很多事，而传统的进程只能串行地执行一系列程序。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118223919994.png" alt="image-20230118223919994" /></p>
<p>为此，引入了 “线程”，来增加并发度。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118224436180.png" alt="image-20230118224436180" /></p>
<p>引入线程后，<strong>线程成为了程序执行流的最小单位</strong></p>
<hr />
<p>可以把线程理解为 “轻量级进程” 。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>线程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}线程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">线程</span></span></span></span>是一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>基本的</mtext><mtext mathvariant="monospace">CPU</mtext><mtext>执行单元</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}基本的\texttt{CPU}执行单元</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">基本的</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">CPU</span></span><span class="mord cjk_fallback" style="color:red;">执行单元</span></span></span></span>，</p>
<ul>
<li>也是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>程序执行流的最小单位</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}程序执行流的最小单位</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">程序执行流的最小单位</span></span></span></span>。</li>
</ul>
<p>引入线程之后，不仅是进程之间可以并发，</p>
<ul>
<li>
<p>进程内的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>各线程之间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}各线程之间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">各线程之间</span></span></span></span>也可以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>并发</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}并发</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">并发</span></span></span></span>，</p>
<p>从而进一步<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>提升了系统的并发度</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}提升了系统的并发度</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">提升了系统的并发度</span></span></span></span>，</p>
<p>使得一个进程内也可以并发处理各种任务（如 QQ 视频、文字聊天、传文件)</p>
</li>
</ul>
<hr />
<p>引入线程后，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程</span></span></span></span>只作为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>除</mtext><mtext mathvariant="monospace">CPU</mtext><mtext>之外的系统资源的分配单元</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}除\texttt{CPU}之外的系统资源的分配单元</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">除</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">CPU</span></span><span class="mord cjk_fallback" style="color:red;">之外的系统资源的分配单元</span></span></span></span></p>
<ul>
<li>（如打印机、内存地址空间等都是分配给进程的）。</li>
</ul>
<p>即：进程只作为分配资源的基本单位，而将线程作为调度的基本单位</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118225004543.png" alt="image-20230118225004543" /></p>
<hr />
<h2 id="引入线程带来的变化"><a class="anchor" href="#引入线程带来的变化">#</a> 引入线程带来的变化</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118231907308.png" alt="image-20230118231907308" /></p>
<h2 id="线程的属性"><a class="anchor" href="#线程的属性">#</a> 线程的属性</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118232159853.png" alt="image-20230118232159853" /></p>
<p>例如：从 QQ 聊天窗口跳到 b 站视频就是不同进程之间线程的切换</p>
<h2 id="线程的实现方式"><a class="anchor" href="#线程的实现方式">#</a> 线程的实现方式</h2>
<h3 id="用户级线程user-level-threadult"><a class="anchor" href="#用户级线程user-level-threadult">#</a> 用户级线程 (User-Level Thread,ULT)</h3>
<p>用户级线程由应用程序通过线程库实现。</p>
<p>所有的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>线程管理工作</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}线程管理工作</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">线程管理工作</span></span></span></span>都由<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>应用程序负责</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}应用程序负责</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">应用程序负责</span></span></span></span>（包括线程切换)</p>
<p>用户级线程中，</p>
<ul>
<li>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>线程切换</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}线程切换</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">线程切换</span></span></span></span>可以在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>用户态下即可完成</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}用户态下即可完成</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">用户态下即可完成</span></span></span></span>，</p>
<p><strong>无需操作系统干预</strong>。</p>
</li>
</ul>
<p>在用户看来，是有多个线程。但是在操作系统内核看来，并意识不到线程的存在。</p>
<ul>
<li>（用户级线程对用户不透明，对<strong>操作系统透明</strong>)</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118233615063.png" alt="image-20230118233615063" /></p>
<p>可以这样理解，“<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>用户级线程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}用户级线程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">用户级线程</span></span></span></span>” 就是 “<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>从用户视角看能看到的线程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}从用户视角看能看到的线程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">从用户视角看能看到的线程</span></span></span></span>”</p>
<h3 id="内核级线程kernel-level-thread-klt"><a class="anchor" href="#内核级线程kernel-level-thread-klt">#</a> 内核级线程 (Kernel-Level Thread, KLT)</h3>
<p>又称 &quot;内核支持的线程&quot;</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118233911343.png" alt="image-20230118233911343" /></p>
<p>内核级<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>线程的管理工作</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}线程的管理工作</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">线程的管理工作</span></span></span></span>由<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>操作系统内核</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}操作系统内核</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">操作系统内核</span></span></span></span>完成。</p>
<p>线程调度、切换等工作都由<strong>内核负责</strong>，</p>
<ul>
<li>因此<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>内核级线程的切换</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}内核级线程的切换</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">内核级线程的切换</span></span></span></span>必然需要在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>核心态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}核心态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">核心态</span></span></span></span>下才能完成。</li>
</ul>
<p>可以这样理解，“<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>内核级线程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}内核级线程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">内核级线程</span></span></span></span>” 就是 “<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>从操作系统内核视角看能看到的线程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}从操作系统内核视角看能看到的线程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">从操作系统内核视角看能看到的线程</span></span></span></span>”</p>
<h3 id="二者组合"><a class="anchor" href="#二者组合">#</a> 二者组合</h3>
<p>在同时支持用户级线程和内核级线程的系统中，可采用二者组合的方式:</p>
<p>将  <code>n</code>  个用户级线程映射到  <code>m</code>  个内核级线程上（  <code>n &gt;= m</code> ）</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>重点重点重点</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}重点重点重点</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">重点重点重点</span></span></span></span>：</p>
<p>操作系统只 “看得见” 内核级线程，</p>
<ul>
<li>因此只有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>内核级线程才是处理机分配的单位</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}内核级线程才是处理机分配的单位</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">内核级线程才是处理机分配的单位</span></span></span></span>。</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118234210320.png" alt="image-20230118234210320" /></p>
<p>例如：</p>
<p>上述这个模型中，该进程由两个内核级线程，三个用户级线程，在用户看来，这个进程中有三个线程。</p>
<ul>
<li>但即使该进程在一个 4 核处理机的计算机上运行，也最多只能被分配到<strong>两个核</strong>，最多只能有两个用户线程<strong>并行</strong>执行。</li>
</ul>
<h2 id="多线程模型"><a class="anchor" href="#多线程模型">#</a> 多线程模型</h2>
<p>在同时支持用户级线程和内核级线程的系统中，由几个用户级线程映射到几个内核级线程的问题引出了 “多线程模型” 问题。</p>
<h3 id="多对一模型"><a class="anchor" href="#多对一模型">#</a> 多对一模型</h3>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>多对一</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}多对一</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">多对一</span></span></span></span>模型：</p>
<ul>
<li>多个用户及线程映射到一个内核级线程。每个用户进程只对应一个内核级线程。</li>
</ul>
<p>优点：</p>
<ul>
<li>用户级线程的切换在用户空间即可完成，不需要切换到核心态，</li>
<li>线程管理的系统开销小，效率高</li>
</ul>
<p>缺点：</p>
<ul>
<li>当一个用户级线程被阻塞后，整个进程都会被阻塞，并发度不高。</li>
<li>多个线程不可在多核处理机上并行运行</li>
</ul>
<p><strong>因为</strong>线程是处理机调度的基本单位，而不是资源分配的基本单位。多个用户级映射在一个内核级线程，内核认为仅有一个线程，当一个用户级线程被阻塞，内核认为所映射的内核级线程也被阻塞，故所有映射到该内核级的用户级线程都被阻塞</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118235614879.png" alt="image-20230118235614879" /></p>
<h3 id="一对一模型"><a class="anchor" href="#一对一模型">#</a> 一对一模型</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230119000642332.png" alt="image-20230119000642332" /></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>一对一</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}一对一</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">一对一</span></span></span></span>模型：</p>
<ul>
<li>一个用户及线程映射到一个内核级线程。</li>
<li>每个用户进程有与用户级线程同数量的内核级线程。</li>
</ul>
<p>优点：</p>
<ul>
<li>当一个线程被阻塞后，别的线程还可以继续执行，并发能力强</li>
<li>多线程可在多核处理机上并行执行。</li>
</ul>
<p>缺点：</p>
<ul>
<li><strong>一个用户进程会占用多个内核级线程</strong>，线程切换由操作系统内核完成，需要切换到核心态，</li>
<li>因此线程管理的成本高，开销大。</li>
</ul>
<h3 id="多对多模型"><a class="anchor" href="#多对多模型">#</a> 多对多模型</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230118234210320.png" alt="image-20230118234210320" /></p>
<p>多对多模型： <code>n</code>  用户及线程映射到  <code>m</code>  个内核级线程（ <code>n &gt;= m</code> ）。</p>
<ul>
<li>每个用户进程对应  <code>m</code>  个内核级线程。</li>
</ul>
<p>克服了多对一模型并发度不高的缺点，</p>
<ul>
<li>又克服了一对一模型中一个用户进程占用太多内核级线程，开销太大的缺点。</li>
</ul>
<h2 id="整体框架-5"><a class="anchor" href="#整体框架-5">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230119002416974.png" alt="image-20230119002416974" /></p>
<h1 id="处理机调度的概念-层次"><a class="anchor" href="#处理机调度的概念-层次">#</a> 处理机调度的概念、层次</h1>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230121195943127.png" alt="image-20230121195943127" /></p>
<h2 id="调度的基本概念"><a class="anchor" href="#调度的基本概念">#</a> 调度的基本概念</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230121200121995.png" alt="image-20230121200121995" /></p>
<p>当有一堆任务要处理，但由于资源有限，这些事情没法同时处理。、</p>
<p>这就需要确定<strong>某种规则</strong>来决定<strong>处理</strong>这些任务的<strong>顺序</strong>，这就是 “调度” 研究的问题。</p>
<p>在多道程序系统中，进程的数量往往是多于处理机的个数的，这样不可能同时并行地处理各个进程。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>处理机调度</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}处理机调度</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">处理机调度</span></span></span></span>，</p>
<ul>
<li>
<p>就是从就绪队列中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>按照一定的算法选择一个进程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}按照一定的算法选择一个进程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">按照一定的算法选择一个进程</span></span></span></span>并将<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>处理机分配给它</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}处理机分配给它</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">处理机分配给它</span></span></span></span>运行，</p>
<p>以实现进程的并发执行。</p>
</li>
</ul>
<h2 id="调度的三个层次"><a class="anchor" href="#调度的三个层次">#</a> 调度的三个层次</h2>
<h3 id="高级调度"><a class="anchor" href="#高级调度">#</a> 高级调度</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230121201216432.png" alt="image-20230121201216432" /></p>
<p>由于内存空间有限，有时无法将用户提交的作业全部放入内存，因此就需要确定某种规则来决定将作业调入内存的顺序。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>高级调度（作业调度</mtext><mo stretchy="false">)</mo></mstyle></mrow><annotation encoding="application/x-tex">\color{red}高级调度（作业调度)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord cjk_fallback" style="color:red;">高级调度（作业调度</span><span class="mclose" style="color:red;">)</span></span></span></span>。按一定的原则从外存上处于后备队列的作业中挑选一个 (或多个）作业，给他们分配内存等必要资源，</p>
<ul>
<li>并<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>建立相应的进程</mtext><mo stretchy="false">(</mo><mtext>建立</mtext><mtext mathvariant="monospace">PCB</mtext><mo stretchy="false">)</mo></mstyle></mrow><annotation encoding="application/x-tex">\color{red}建立相应的进程(建立\texttt{PCB})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord cjk_fallback" style="color:red;">建立相应的进程</span><span class="mopen" style="color:red;">(</span><span class="mord cjk_fallback" style="color:red;">建立</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">PCB</span></span><span class="mclose" style="color:red;">)</span></span></span></span>，</li>
<li>以使它（们）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>获得竞争处理机的权利</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}获得竞争处理机的权利</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">获得竞争处理机的权利</span></span></span></span>。</li>
</ul>
<p>高级调度是<strong>辅存（外存）与内存之间的调度</strong>。每个作业只调入一次，调出一次。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>作业调入时会建立相应的</mtext><mtext mathvariant="monospace">PCB</mtext><mtext>，作业调出时才撤销</mtext><mtext mathvariant="monospace">PCB</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}作业调入时会建立相应的\texttt{PCB}，作业调出时才撤销\texttt{PCB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">作业调入时会建立相应的</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">PCB</span></span><span class="mord cjk_fallback" style="color:red;">，作业调出时才撤销</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">PCB</span></span></span></span></span>。</p>
<p>高级调度主要是指 <code>调入</code> 的问题，因为只有调入的时机需要操作系统来确定，</p>
<ul>
<li>但调出的时机必然是作业运行结束才调出。</li>
</ul>
<h3 id="中级调度"><a class="anchor" href="#中级调度">#</a> 中级调度</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230121202025591.png" alt="image-20230121202025591" /></p>
<p>引入了虚拟存储技术之后，可将<strong>暂时不能运行的进程</strong>调至外存等待。</p>
<ul>
<li>等它重新具备了运行条件且内存又稍有空闲时，再重新调入内存。</li>
</ul>
<p>这么做的目的：</p>
<ul>
<li>是为了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>提高内存利用率</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}提高内存利用率</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">提高内存利用率</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>系统吞吐量</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}系统吞吐量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">系统吞吐量</span></span></span></span>。</li>
</ul>
<p>暂时调到外存等待的进程状态为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>挂起状态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}挂起状态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">挂起状态</span></span></span></span>。</p>
<p>值得<strong>注意</strong>的是， <code>PCB</code>  并不会一起调到外存，而是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>会常驻内存</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}会常驻内存</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">会常驻内存</span></span></span></span>。</p>
<ul>
<li><code>PCB</code>  中会记录进程数据在外存中的存放位置，进程状态等信息，操作系统通过内存中的  <code>PCB</code>  来保持对各个进程的监控、管理。</li>
<li>被挂起的进程  <code>PCB</code>  会被放到的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>挂起队列</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}挂起队列</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">挂起队列</span></span></span></span>中。</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>中级调度（内存调度）</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}中级调度（内存调度）</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">中级调度（内存调度）</span></span></span></span>，</p>
<ul>
<li>就是要决定将哪个处于<strong>挂起状态</strong>的进程<strong>重新调入内存</strong>。</li>
</ul>
<p>一个进程可能会被多次调出、调入内存，</p>
<ul>
<li>因此<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>中级调度</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}中级调度</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">中级调度</span></span></span></span>发生的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>频率</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}频率</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">频率</span></span></span></span>要比高级调度<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>更高</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}更高</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">更高</span></span></span></span>。</li>
</ul>
<h3 id="进程的挂起态与七状态模型"><a class="anchor" href="#进程的挂起态与七状态模型">#</a> 进程的挂起态与七状态模型</h3>
<p>暂时调到外存等待的进程状态为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>挂起状态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}挂起状态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">挂起状态</span></span></span></span>（挂起态，suspend）</p>
<p>挂起态又可以进一步细分为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>就绪挂起</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}就绪挂起</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">就绪挂起</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>阻塞挂起</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}阻塞挂起</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">阻塞挂起</span></span></span></span>两种状态</p>
<p>五状态模型→七状态模型</p>
<hr />
<p>就是内存不够用了，将进程挂到<strong>就绪挂起</strong>或者<strong>挂到阻塞</strong>挂起</p>
<p>等到内存空间空闲，这个进程需要继续执行，这个进程就会被<strong>激活</strong>，相应的数据就会被移到内存中</p>
<p>一个处于创建态的进程，当它创建  <code>PCB</code>  之后，有可能出现内存空间不够的情况，就会先进入到就绪挂起状态</p>
<p>当阻塞挂起中的进程等待某一事件发生时候，这个进程就会进入到就绪挂起状态</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230121203748888.png" alt="image-20230121203748888" /></p>
<hr />
<p><strong>注意</strong> “挂起” 和 “阻塞” 的区别，两种状态都是暂时不能获得  <code>CPU</code>  的服务，</p>
<ul>
<li>但挂起态是将进程映像（程序段、数据段）调到外存去了，</li>
<li>而阻塞态下进程映像还在内存中。</li>
</ul>
<p>有的操作系统会把就绪挂起、阻塞挂起分为两个挂起队列，甚至会根据阻塞原因不同再把阻塞挂起进程进一步细分为多个队列。</p>
<h3 id="低级调度"><a class="anchor" href="#低级调度">#</a> 低级调度</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230121204201005.png" alt="image-20230121204201005" /></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>低级调度（进程调度）</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}低级调度（进程调度）</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">低级调度（进程调度）</span></span></span></span>，</p>
<ul>
<li>其主要任务是<strong>按照某种方法和策略从就绪队列中选取一个进程</strong>，将处理机分配给它。</li>
</ul>
<p>进程调度是操作系统中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>最基本的一种调度</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}最基本的一种调度</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">最基本的一种调度</span></span></span></span>，</p>
<ul>
<li>在一般的操作系统中都必须配置进程调度。</li>
</ul>
<p>进程调度的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>频率很高</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}频率很高</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">频率很高</span></span></span></span>，一般几十毫秒一次。</p>
<h2 id="三层调度的联系-对比"><a class="anchor" href="#三层调度的联系-对比">#</a> 三层调度的联系、对比</h2>
<table>
<thead>
<tr>
<th></th>
<th>要做什么</th>
<th>调度发生在...</th>
<th>发生频率</th>
<th>队进程状态的影响</th>
</tr>
</thead>
<tbody>
<tr>
<td>高级调度（作业调度）</td>
<td>按照某种规则，从后备队列中选择合适的作业（类似于程序段和数据段）将其调入内存，并为其创建进程</td>
<td>外存 -&gt; 内存（面向作业）</td>
<td>最低</td>
<td>无 -&gt; 创建态 -&gt; 就绪态</td>
</tr>
<tr>
<td>中级调度（内存调度）</td>
<td>按照某种规则，从挂起队列中选择合适的进程将其数据调回内存</td>
<td>外存 -&gt; 内存（面向进程）</td>
<td>中等</td>
<td>就绪挂起 -&gt; 就绪态（阻塞挂起 -&gt; 阻塞态）</td>
</tr>
<tr>
<td>低级调度（进程调度）</td>
<td>按照某种规则，从就绪队列中选择一个进程为其分配处理机</td>
<td>内存 -&gt; CPU</td>
<td>最高</td>
<td>就绪态 -&gt; 运行态</td>
</tr>
</tbody>
</table>
<h2 id="整体框架-6"><a class="anchor" href="#整体框架-6">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230121205705858.png" alt="image-20230121205705858" /></p>
<h1 id="进程调度的时机-切换与过程-方式"><a class="anchor" href="#进程调度的时机-切换与过程-方式">#</a> 进程调度的时机、切换与过程、方式</h1>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230121215554355.png" alt="image-20230121215554355" /></p>
<h2 id="进程调度的时机"><a class="anchor" href="#进程调度的时机">#</a> 进程调度的时机</h2>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程调度</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程调度</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程调度</span></span></span></span>（低级调度），就是按照某种算法从就绪队列中选择一个进程为其分配处理机</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230121220734318.png" alt="image-20230121220734318" /></p>
<hr />
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230121221322773.png" alt="image-20230121221322773" /></p>
<p>进程在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>操作系统内核程序临界区</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}操作系统内核程序临界区</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">操作系统内核程序临界区</span></span></span></span>中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不能</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不能</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不能</span></span></span></span>进行调度与切换 √</p>
<p>（2012 年联考真题）进程处于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>临界区</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}临界区</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">临界区</span></span></span></span>时<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不能</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不能</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不能</span></span></span></span>进行处理机调度 ❌</p>
<p><code>临界资源</code> ：一个时间段内只允许一个进程使用的资源。</p>
<ul>
<li>各进程需要<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>互斥地</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}互斥地</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">互斥地</span></span></span></span>访问临界资源。</li>
</ul>
<p><code>临界区</code> ：访问临界资源的那段代码。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>内核程序临界区</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}内核程序临界区</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">内核程序临界区</span></span></span></span>一般是用来访问<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>某种内核数据结构</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}某种内核数据结构</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">某种内核数据结构</span></span></span></span>的，</p>
<ul>
<li>比如进程的就绪队列（由各就绪进程的  <code>PCB</code>  组成)</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230121222330829.png" alt="image-20230121222330829" /></p>
<p>若还没有退出内核程序临界区（还没解锁）就进行进程调度（访问就绪队列），</p>
<ul>
<li>
<p>但是进程调度的相关程序也需要访问就绪队列，</p>
<p>但此时就绪队列被锁住了，因此又无法顺利进行进程调度</p>
</li>
</ul>
<hr />
<p>若此时进程访问的是普通的临界资源，例如：打印机</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128173651595.png" alt="image-20230128173651595" /></p>
<p>在打印机打印完成之前，进程一直处于临界区内，临界资源不会解锁。</p>
<ul>
<li>但打印机又是慢速设备，此时如果一直不允许进程调度的话就会导致  <code>CPU</code>  一直空闲</li>
</ul>
<p>普通 I 临界区访问的临界资源不会直接影响操作系统内核的管理工作。</p>
<ul>
<li>因此在访问普通临界区时可以进行调度与切换。</li>
</ul>
<hr />
<h2 id="进程调度的方式"><a class="anchor" href="#进程调度的方式">#</a> 进程调度的方式</h2>
<p>有的系统中，只允许进程<strong>主动放弃</strong>处理机</p>
<p>有的系统中，进程可以<strong>主动放弃</strong>处理机，</p>
<ul>
<li>当有更紧急的任务需要处理时，也会强行剥夺处理机（<strong>被动放弃</strong>)</li>
</ul>
<hr />
<h3 id="非剥夺方式非抢占方式"><a class="anchor" href="#非剥夺方式非抢占方式">#</a> 非剥夺方式（非抢占方式）</h3>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>非剥夺调度方式</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}非剥夺调度方式</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">非剥夺调度方式</span></span></span></span>，又称<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>非抢占方式</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}非抢占方式</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">非抢占方式</span></span></span></span>。</p>
<ul>
<li>即，只允许进程主动放弃处理机。</li>
</ul>
<p>在运行过程中即便有更紧迫的任务到达，当前进程依然会继续使用处理机，</p>
<ul>
<li>直到该进程终止或主动要求进入阻塞态。</li>
</ul>
<p>实现简单，系统开销小但是无法及时处理紧急任务，适合于早期的批处理系统</p>
<hr />
<h3 id="剥夺调度方式抢占方式"><a class="anchor" href="#剥夺调度方式抢占方式">#</a> 剥夺调度方式（抢占方式）</h3>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>剥夺调度方式</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}剥夺调度方式</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">剥夺调度方式</span></span></span></span>，又称<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>抢占方式</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}抢占方式</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">抢占方式</span></span></span></span>。</p>
<ul>
<li>当一个进程正在处理机上执行时，如果有一个更重要或更紧迫的进程需要使用处理机，则立即暂停正在执行的进程，将处理机分配给更重要紧迫的那个进程。</li>
</ul>
<p>可以优先处理更紧急的进程，也可实现让各进程按时间片轮流执行的功能（通过时钟中断）。</p>
<ul>
<li>适合于分时操作系统、实时操作系统</li>
</ul>
<h2 id="进程的切换与过程"><a class="anchor" href="#进程的切换与过程">#</a> 进程的切换与过程</h2>
<h3 id="狭义的进程调度-与-进程切换-的区别"><a class="anchor" href="#狭义的进程调度-与-进程切换-的区别">#</a> &quot;狭义的进程调度&quot; 与 &quot;进程切换&quot; 的区别</h3>
<p>“狭义的进程调度” 与 “进程切换” 的区别:</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>狭义的进程调度</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}狭义的进程调度</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">狭义的进程调度</span></span></span></span>指的是从就绪队列中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>选中一个要运行的进程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}选中一个要运行的进程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">选中一个要运行的进程</span></span></span></span>。</p>
<ul>
<li>这个进程可以是<strong>刚刚被暂停执行的进程</strong>，也可能是<strong>另一个进程</strong>，后一种情况就需要进程切换</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程切换</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程切换</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程切换</span></span></span></span>是指一个进程让出处理机，由另一个进程占用处理机的过程。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>广义的进程调度</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}广义的进程调度</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">广义的进程调度</span></span></span></span>包含了选择一个进程和进程切换<strong>两个步骤</strong>。</p>
<hr />
<p>进程切换的过程主要完成了:</p>
<ol>
<li>
<p>对原来运行进程各种数据的保存（信息一般保存在  <code>PCB</code>  中）</p>
</li>
<li>
<p>对新的进程各种数据的恢复</p>
<p>（如：程序计数器、程序状态字、各种数据寄存器等处理机现场信息，这些信息一般保存在进程控制块）</p>
</li>
</ol>
<p><strong>注意</strong>：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程切换是有代价的</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程切换是有代价的</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程切换是有代价的</span></span></span></span></p>
<ul>
<li>因此如果<strong>过于频繁</strong>的进行进程<strong>调度</strong>、<strong>切换</strong>，必然会使整个<strong>系统的效率降低</strong>，使系统大部分时间都花在了进程切换上，而真正用于执行进程的时间减少。</li>
</ul>
<h2 id="整体框架-7"><a class="anchor" href="#整体框架-7">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128180821686.png" alt="image-20230128180821686" /></p>
<h1 id="调度算法的评价指标"><a class="anchor" href="#调度算法的评价指标">#</a> 调度算法的评价指标</h1>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128220142618.png" alt="image-20230128220142618" /></p>
<h2 id="cpu-利用率"><a class="anchor" href="#cpu-利用率">#</a> CPU 利用率</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128220233811.png" alt="image-20230128220233811" /></p>
<p>由于早期的  <code>CPU</code>  造价极其昂贵，</p>
<ul>
<li>因此人们会<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>希望让</mtext><mtext mathvariant="monospace">CPU</mtext><mtext>尽可能多地工作</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}希望让 \texttt{CPU} 尽可能多地工作</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">希望让</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">CPU</span></span><span class="mord cjk_fallback" style="color:red;">尽可能多地工作</span></span></span></span></li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext mathvariant="monospace">CPU</mtext><mtext>利用率</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}\texttt{CPU}利用率</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">CPU</span></span><span class="mord cjk_fallback" style="color:red;">利用率</span></span></span></span>：指  <code>CPU</code>  “忙碌” 的时间占总时间的比例。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>利用率</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}{利用率}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord" style="color:red;"><span class="mord cjk_fallback" style="color:red;">利用率</span></span></span></span></span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mstyle mathsize="1.2em"><mfrac><mtext>忙碌的时间</mtext><mtext>总时间</mtext></mfrac><mtext> </mtext></mstyle></mrow><annotation encoding="application/x-tex">=\large\frac{忙碌的时间}{总时间} \,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.4335em;vertical-align:-0.414em;"></span><span class="mord sizing reset-size6 size7"><span class="mopen nulldelimiter sizing reset-size7 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8496em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">总时间</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">忙碌的时间</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size7 size6"></span></span><span class="mspace sizing reset-size6 size7" style="margin-right:0.1667em;"></span></span></span></span></p>
<ul>
<li>有的题目还会要求计算某种设备的利用率</li>
</ul>
<p><code>Eg</code> ：某计算机只支持单道程序，某个作业刚开始需要在  <code>CPU</code>  上运行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 秒，再用打印机打印输出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 秒，之后再执行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 秒，才能结束。在此过程中， <code>CPU</code>  利用率、打印机利用率分别是多少？</p>
<ul>
<li>
<p><code>CPU</code>  利用率 = <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mn>5</mn><mo>+</mo><mn>5</mn></mrow><mrow><mn>5</mn><mo>+</mo><mn>5</mn><mo>+</mo><mn>5</mn></mrow></mfrac><mo>=</mo><mn>66.66</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">\frac{5+5}{5+5+5}=66.66\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2484em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">5</span><span class="mbin mtight">+</span><span class="mord mtight">5</span><span class="mbin mtight">+</span><span class="mord mtight">5</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">5</span><span class="mbin mtight">+</span><span class="mord mtight">5</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">66.66%</span></span></span></span></p>
</li>
<li>
<p>打印机利用率 = <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>5</mn><mrow><mn>5</mn><mo>+</mo><mn>5</mn><mo>+</mo><mn>5</mn></mrow></mfrac><mo>=</mo><mn>33.33</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">\frac{5}{5+5+5}=33.33\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2484em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">5</span><span class="mbin mtight">+</span><span class="mord mtight">5</span><span class="mbin mtight">+</span><span class="mord mtight">5</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">5</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">33.33%</span></span></span></span></p>
</li>
</ul>
<p>通常会考察多道程序并发执行的情况，可以用 “<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%94%98%E7%89%B9%E5%9B%BE/113232">甘特图</a>” 来辅助计算</p>
<hr />
<h2 id="系统吞吐量"><a class="anchor" href="#系统吞吐量">#</a> 系统吞吐量</h2>
<p>对于计算机来说，希望能用尽可能少的时间处理完尽可能多的作业</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>系统吞吐量</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}系统吞吐量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">系统吞吐量</span></span></span></span>：</p>
<ul>
<li>单位时间内完成作业的数量</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>系统吞吐量</mtext></mstyle><mo>=</mo><mstyle mathsize="1.2em"><mfrac><mtext>总共完成了多少道作业</mtext><mtext>总共花了多少时间</mtext></mfrac><mtext> </mtext></mstyle></mrow><annotation encoding="application/x-tex">\textcolor{red}{系统吞吐量}=\large\frac{总共完成了多少道作业}{总共花了多少时间}\,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">系统吞吐量</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.4335em;vertical-align:-0.414em;"></span><span class="mord sizing reset-size6 size7"><span class="mopen nulldelimiter sizing reset-size7 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8496em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">总共花了多少时间</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">总共完成了多少道作业</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size7 size6"></span></span><span class="mspace sizing reset-size6 size7" style="margin-right:0.1667em;"></span></span></span></span></p>
<p><code>Eg</code> ：某计算机系统处理完 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span> 道作业，共花费 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn></mrow><annotation encoding="application/x-tex">100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">100</span></span></span></span> 秒，则系统吞吐量为？</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>10</mn><mn>100</mn></mfrac><mo>=</mo><mn>0.1</mn><mtext>道</mtext><mi mathvariant="normal">/</mi><mtext>秒</mtext></mrow><annotation encoding="application/x-tex">\frac{10}{100}= 0.1道/秒</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">100</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0.1</span><span class="mord cjk_fallback">道</span><span class="mord">/</span><span class="mord cjk_fallback">秒</span></span></span></span></li>
</ul>
<h2 id="周转时间4个指标"><a class="anchor" href="#周转时间4个指标">#</a> 周转时间 (4 个指标)</h2>
<p>对于计算机的用户来说，他很关心自己的作业从提交到完成花了多少时间。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>周转时间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}周转时间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">周转时间</span></span></span></span>，</p>
<ul>
<li>是指从<strong>作业被提交给系统开始</strong>，到<strong>作业完成为止</strong>的这段时间间隔。</li>
</ul>
<p>它包括四个部分:</p>
<ul>
<li>作业在外存后备队列上等待作业调度（高级调度）的时间、</li>
<li>进程在就绪队列上等待进程调度（低级调度）的时间（就绪态）、</li>
<li>进程在  <code>CPU</code>  上执行的时间（运行态）、</li>
<li>进程等待  <code>I/0</code>  操作完成的时间（阻塞态）。</li>
</ul>
<p>后三项在一个作业的整个处理过程中，可能发生多次。</p>
<hr />
<p>（作业）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>周转时间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}周转时间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">周转时间</span></span></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mtext>作业完成时间</mtext><mo>−</mo><mtext>作业提交时间</mtext></mrow><annotation encoding="application/x-tex">=作业完成时间-作业提交时间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord cjk_fallback">作业完成时间</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback">作业提交时间</span></span></span></span></p>
<ul>
<li>上述对于用户来说，更关心自己的单个作业的周转时间</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>平均周转时间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}平均周转时间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">平均周转时间</span></span></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mstyle mathsize="1.2em"><mfrac><mtext>各作业周转时间之和</mtext><mtext>作业数</mtext></mfrac><mtext> </mtext></mstyle></mrow><annotation encoding="application/x-tex">=\large\frac {各作业周转时间之和}{作业数}\,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.4335em;vertical-align:-0.414em;"></span><span class="mord sizing reset-size6 size7"><span class="mopen nulldelimiter sizing reset-size7 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8496em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">作业数</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">各作业周转时间之和</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size7 size6"></span></span><span class="mspace sizing reset-size6 size7" style="margin-right:0.1667em;"></span></span></span></span></p>
<ul>
<li>对于操作系统来说，更关心系统的整体表现，因此更关心所有作业周转时间的平均值</li>
</ul>
<hr />
<p><strong>思考</strong>：有的作业运行时间短，有的作业运行时间长，因此在周转时间相同的情况下，运行时间不同的作业，给用户的感觉肯定是不一样的</p>
<ul>
<li>例如：排队上厕所，另外个人只需等待一分钟，上十分钟，而你却等待十分钟，上一分钟</li>
</ul>
<hr />
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>带权周转时间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}带权周转时间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">带权周转时间</span></span></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mstyle mathsize="1.2em"><mfrac><mtext>作业周转时间</mtext><mtext>作业实际运行的时间</mtext></mfrac><mtext> </mtext><mo>=</mo><mfrac><mrow><mtext>作业完成时间</mtext><mo>−</mo><mtext>作业提交时间</mtext></mrow><mtext>作业实际运行的时间</mtext></mfrac><mtext> </mtext></mstyle></mrow><annotation encoding="application/x-tex">=\large\frac {作业周转时间}{作业实际运行的时间}\, = \frac {作业完成时间-作业提交时间}{作业实际运行的时间}\,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.4335em;vertical-align:-0.414em;"></span><span class="mord sizing reset-size6 size7"><span class="mopen nulldelimiter sizing reset-size7 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8496em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">作业实际运行的时间</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">作业周转时间</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size7 size6"></span></span><span class="mspace sizing reset-size6 size7" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel sizing reset-size6 size7">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.4335em;vertical-align:-0.414em;"></span><span class="mord sizing reset-size6 size7"><span class="mopen nulldelimiter sizing reset-size7 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8496em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">作业实际运行的时间</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">作业完成时间</span><span class="mbin mtight">−</span><span class="mord cjk_fallback mtight">作业提交时间</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size7 size6"></span></span><span class="mspace sizing reset-size6 size7" style="margin-right:0.1667em;"></span></span></span></span></p>
<ul>
<li>
<p>对于周转时间相同的两个作业，实际运行时间长的作业在相同时间内被服务的时间更多，带权周转时间更小，用户满意度更高。</p>
</li>
<li>
<p>对于实际运行时间相同的两个作业，周转时间短的带权周转时间更小，用户满意度更高。</p>
</li>
</ul>
<p>带权周转时间必然 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≥</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">≥1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></p>
<p>带权周转时间与周转时间都是越小越好</p>
<hr />
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>平均带权周转时间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}平均带权周转时间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">平均带权周转时间</span></span></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mstyle mathsize="1.2em"><mfrac><mtext>各作业带权周转时间之和</mtext><mtext>作业数</mtext></mfrac><mtext> </mtext></mstyle></mrow><annotation encoding="application/x-tex">=\large\frac {各作业带权周转时间之和}{作业数}\,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.4335em;vertical-align:-0.414em;"></span><span class="mord sizing reset-size6 size7"><span class="mopen nulldelimiter sizing reset-size7 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8496em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">作业数</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">各作业带权周转时间之和</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size7 size6"></span></span><span class="mspace sizing reset-size6 size7" style="margin-right:0.1667em;"></span></span></span></span></p>
<h2 id="等待时间"><a class="anchor" href="#等待时间">#</a> 等待时间</h2>
<p>计算机的用户希望自己的作业尽可能少的等待处理机</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>等待时间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}等待时间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">等待时间</span></span></span></span>，</p>
<ul>
<li>指进程 / 作业<strong>处于等待处理机状态时间之和</strong>，等待时间越长，用户满意度越低。</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128223121470.png" alt="image-20230128223121470" /></p>
<p>对于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程</span></span></span></span>来说，</p>
<ul>
<li>等待时间就是指进程建立后<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>等待被服务的时间之和</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}等待被服务的时间之和</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">等待被服务的时间之和</span></span></span></span></li>
<li>在等待  <code>I/O</code>  完成的期间其实进程也是在被服务的，所以不计入等待时间。</li>
</ul>
<p>对于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>作业</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}作业</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">作业</span></span></span></span>来说，</p>
<ul>
<li>不仅要考虑<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>建立进程后的等待时间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}建立进程后的等待时间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">建立进程后的等待时间</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>还要加上作业在外存后备队列中等待的时间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}还要加上作业在外存后备队列中等待的时间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">还要加上作业在外存后备队列中等待的时间</span></span></span></span>。</li>
</ul>
<p>一个作业总共需要被  <code>CPU</code>  服务多久，被  <code>l/O</code>  设备服务多久一般是确定不变的，</p>
<ul>
<li>因此调度算法其实只会影响作业 / 进程的等待时间。</li>
</ul>
<p>当然，与前面指标类似，也有 “<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>平均等待时间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}平均等待时间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">平均等待时间</span></span></span></span>” 来评价整体性能。</p>
<h2 id="响应时间"><a class="anchor" href="#响应时间">#</a> 响应时间</h2>
<p>对于计算机用户来说，会希望自己的提交的请求（比如通过键盘输入了一个调试命令）尽早地开始被系统服务、回应。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>响应时间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}响应时间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">响应时间</span></span></span></span>：</p>
<ul>
<li>指从用户<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>提交请求</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}提交请求</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">提交请求</span></span></span></span>到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>首次产生响应</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}首次产生响应</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">首次产生响应</span></span></span></span>所用的时间。</li>
</ul>
<h2 id="整体框架-8"><a class="anchor" href="#整体框架-8">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128224807642.png" alt="image-20230128224807642" /></p>
<h1 id="fcfs-sjf-hrrn-调度算法"><a class="anchor" href="#fcfs-sjf-hrrn-调度算法">#</a> FCFS、SJF、HRRN 调度算法</h1>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128225021061.png" alt="image-20230128225021061" /></p>
<p><code>Tips</code> ：各种调度算法的学习思路</p>
<ol>
<li>
<p>算法思想</p>
</li>
<li>
<p>算法规则</p>
</li>
<li>
<p>这种调度算法是用于作业调度还是进程调度？</p>
</li>
<li>
<p>抢占式？非抢占式？</p>
</li>
<li>
<p>优点和缺点</p>
</li>
<li>
<p>是否会导致<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>饥饿</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}饥饿</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">饥饿</span></span></span></span></p>
<p>某 进程 / 作业 长期得不到服务</p>
</li>
</ol>
<hr />
<table>
<thead>
<tr>
<th>算法</th>
<th>可抢占？</th>
<th>优点</th>
<th>缺点</th>
<th>考虑到等待时间 &amp; 运行时间</th>
<th>会导致饥饿？</th>
</tr>
</thead>
<tbody>
<tr>
<td>FCFS</td>
<td>非抢占式</td>
<td>公平；实现简单；利于长作业</td>
<td>不利于短作业</td>
<td>等待时间 ✔；&lt;br /&gt; 运行时间 ❌</td>
<td>不会</td>
</tr>
<tr>
<td>SJF/SPF</td>
<td>默认为非抢占式；也有 SJF 抢占式版本最短剩余时间优先算法（SRTN）</td>
<td>&quot;最短的&quot; 平均等待 / 周转时间；利于短作业</td>
<td>不利于长作业，可能会导致饥饿；难以做到正真的短作业优先</td>
<td>等待时间 ❌；&lt;br /&gt; 运行时间 ✔</td>
<td>会（导致长作业饥饿）</td>
</tr>
<tr>
<td>HRRN</td>
<td>非抢占式</td>
<td>上述两种算法的均衡考虑，综合考虑的等待时间和运行时间</td>
<td></td>
<td>等待时间 ✔；&lt;br /&gt; 运行时间 ✔</td>
<td>不会</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="fcfs"><a class="anchor" href="#fcfs">#</a> FCFS</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128235228419.png" alt="image-20230128235228419" /></p>
<hr />
<p>例题：各进程到达就绪队列的时间、需要的运行时间如下表所示。使用<strong>先来先服务</strong>调度算法，计算各进程的等待时间、平均等待时间、周转时间、平均周转时间、带权周转时间、平均带权周转时间。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128232811470.png" alt="image-20230128232811470" /></p>
<hr />
<h2 id="sjf"><a class="anchor" href="#sjf">#</a> SJF</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128235300494.png" alt="image-20230128235300494" /></p>
<h3 id="非抢占式的-sjf"><a class="anchor" href="#非抢占式的-sjf">#</a> 非抢占式的 SJF</h3>
<p>例题：各进程到达就绪队列的时间、需要的运行时间如下表所示。使用<strong>非抢占式</strong>的<strong>短作业优先</strong>（严格来说，用于进程调度应该称为<strong>短进程优先调度</strong>  <code>SPF</code> ）调度算法，计算各进程的等待时间、平均等待时间、周转时间、平均周转时间、带权周转时间、平均带权周转时间。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128233735530.png" alt="image-20230128233735530" /></p>
<h3 id="抢占式的-sjf最短剩余时间优先算法srtn"><a class="anchor" href="#抢占式的-sjf最短剩余时间优先算法srtn">#</a> 抢占式的 SJF（最短剩余时间优先算法 SRTN）</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128234226912.png" alt="image-20230128234226912" /></p>
<hr />
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230128234342677.png" alt="image-20230128234342677" /></p>
<h3 id="注意"><a class="anchor" href="#注意">#</a> 注意</h3>
<p>1 . 如果题目中未特别说明，所提到的 “短作业 / 进程优先算法” <strong>默认是非抢占式的</strong></p>
<p>2 . 很多书上都会说 “  <code>SJF</code>  调度算法的平均等待时间、平均周转时间最少”</p>
<p>严格来说，这个表述是错误的，不严谨的。之前的例子表明，最短剩余时间优先算法得到的平均等代时间、平均周转时间还要更少</p>
<p>应该加上一个条件 “在 <code>所有进程同时可运行</code> 时，采用  <code>SJF</code>  调度算法的平均等待时间、平均周转时间最少”;</p>
<p>或者说 “在 <code>所有进程都几乎同时到达时</code> ，采用  <code>SJF</code>  调度算法的平均等待时间、平均周转时间最少” ;</p>
<p>如果不加上述前提条件，则应该说 “ <code>抢占式的</code> 短作业 / 进程优先调度算法（ <code>最短剩余时间优先, SRTN</code>  算法）的平均等待时间、平均周转时间最少”</p>
<p>3．虽然严格来说， <code>SJF</code>  的平均等待时间、平均周转时间并不一定最少，</p>
<ul>
<li>但相比于其他算法（如  <code>FCFS</code> ) ， <code>SJF</code>  依然可以获得较少的平均等待时间、平均周转时间</li>
</ul>
<p>4 ．如果选择题中遇到 “  <code>SIF</code>  算法的平均等待时间、平均周转时间最少” 的选项，那最好判断其他选项是不是有很明显的错误，如果没有更合适的选项，那也应该选择该选项</p>
<h2 id="二者思考"><a class="anchor" href="#二者思考">#</a> 二者思考</h2>
<p><code>FCFS</code>  算法是在每次调度的时候选择一个等待时间最长的作业（进程）为其服务。</p>
<ul>
<li>但是没有考虑到作业的运行时间，因此导致了对短作业不友好的问题</li>
</ul>
<p><code>SJF</code>  算法是选择一个执行时间最短的作业为其服务。</p>
<ul>
<li>但是又完全不考虑各个作业的等待时间，因此导致了对长作业不友好的问题，甚至还会造成饥饿问题</li>
</ul>
<p>能不能设计一个算法，即考虑到各个作业的等待时间，也能兼顾运行时间呢？</p>
<ul>
<li>高响应比优先算法</li>
</ul>
<hr />
<h2 id="hrrn"><a class="anchor" href="#hrrn">#</a> HRRN</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129000427215.png" alt="image-20230129000427215" /></p>
<hr />
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>响应比</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}响应比</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">响应比</span></span></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mstyle mathsize="1.2em"><mfrac><mrow><mtext>等待时间</mtext><mo>+</mo><mtext>要求服务时间</mtext></mrow><mtext>要求服务时间</mtext></mfrac><mtext> </mtext></mstyle></mrow><annotation encoding="application/x-tex">=\large\frac{等待时间+要求服务时间}{要求服务时间}\,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.4335em;vertical-align:-0.414em;"></span><span class="mord sizing reset-size6 size7"><span class="mopen nulldelimiter sizing reset-size7 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8496em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">要求服务时间</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">等待时间</span><span class="mbin mtight">+</span><span class="mord cjk_fallback mtight">要求服务时间</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size7 size6"></span></span><span class="mspace sizing reset-size6 size7" style="margin-right:0.1667em;"></span></span></span></span></p>
<p>例题：各进程到达就绪队列的时间、需要的运行时间如下表所示。使用<strong>高响应比优先</strong>调度算法，计算各进程的等待时间、平均等待时间、周转时间、平均周转时间、带权周转时间、平均带权周转时间。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129000222019.png" alt="image-20230129000222019" /></p>
<h2 id="总结"><a class="anchor" href="#总结">#</a> 总结</h2>
<table>
<thead>
<tr>
<th>算法</th>
<th>可抢占？</th>
<th>优点</th>
<th>缺点</th>
<th>考虑到等待时间 &amp; 运行时间</th>
<th>会导致饥饿？</th>
</tr>
</thead>
<tbody>
<tr>
<td>FCFS</td>
<td>非抢占式</td>
<td>公平；实现简单；利于长作业</td>
<td>不利于短作业</td>
<td>等待时间 ✔；&lt;br /&gt; 运行时间 ❌</td>
<td>不会</td>
</tr>
<tr>
<td>SJF/SPF</td>
<td>默认为非抢占式；也有 SJF 抢占式版本最短剩余时间优先算法（SRTN）</td>
<td>&quot;最短的&quot; 平均等待 / 周转时间；利于短作业</td>
<td>不利于长作业，可能会导致饥饿；难以做到正真的短作业优先</td>
<td>等待时间 ❌；&lt;br /&gt; 运行时间 ✔</td>
<td>会（导致长作业饥饿）</td>
</tr>
<tr>
<td>HRRN</td>
<td>非抢占式</td>
<td>上述两种算法的均衡考虑，综合考虑的等待时间和运行时间</td>
<td></td>
<td>等待时间 ✔；&lt;br /&gt; 运行时间 ✔</td>
<td>不会</td>
</tr>
</tbody>
</table>
<p><strong>注</strong>：这几种算法主要关心对用户的公平性、平均周转时间、平均等待时间等评价系统整体性能的指标，但是不关心 “响应时间”，也并不区分任务的紧急程度，因此对于用户来说，交互性很糟糕。</p>
<p>因此这三种算法一般适合用于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>早期的批处理系统</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}早期的批处理系统</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">早期的批处理系统</span></span></span></span>，</p>
<p>当然， <code>FCFS</code>  算法也常结合其他的算法使用，在现在也扮演着很重要的角色。</p>
<ul>
<li>而适合用于交互式系统的调度算法将在下个小节介绍...</li>
</ul>
<h1 id="时间片轮转-优先级调度算法-多级反馈队列调度算法"><a class="anchor" href="#时间片轮转-优先级调度算法-多级反馈队列调度算法">#</a> 时间片轮转、优先级调度算法、多级反馈队列调度算法</h1>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129183902251.png" alt="image-20230129183902251" /></p>
<p><code>Tips</code> ：各种调度算法的学习思路</p>
<ol>
<li>
<p>算法思想</p>
</li>
<li>
<p>算法规则</p>
</li>
<li>
<p>这种调度算法是用于作业调度还是进程调度？</p>
</li>
<li>
<p>抢占式？非抢占式？</p>
</li>
<li>
<p>优点和缺点</p>
</li>
<li>
<p>是否会导致<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>饥饿</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}饥饿</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">饥饿</span></span></span></span></p>
<p>某 进程 / 作业 长期得不到服务</p>
</li>
</ol>
<hr />
<h2 id="时间片轮转rr-round-robin"><a class="anchor" href="#时间片轮转rr-round-robin">#</a> 时间片轮转（RR, Round-Robin）</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129190722131.png" alt="image-20230129190722131" /></p>
<hr />
<h3 id="例子"><a class="anchor" href="#例子">#</a> 例子</h3>
<p>常用于分时操作系统，更注重 &quot;响应时间&quot;，因而此处不计算周转时间</p>
<p>例题：各进程到达就绪队列的时间、需要的运行时间如下表所示。使用<strong>时间片轮转</strong>调度算法，计算各进程的等待时间、平均等待时间、周转时间、平均周转时间、带权周转时间、平均带权周转时间。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129184754195.png" alt="image-20230129184754195" /></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129185103652.png" alt="image-20230129185103652" /></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129185248581.png" alt="image-20230129185248581" /></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129185315688.png" alt="image-20230129185315688" /></p>
<hr />
<p><strong>时间片为 5 的情况</strong></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129185611326.png" alt="image-20230129185611326" /></p>
<hr />
<p>若按照<strong>先来先服务</strong>调度算法</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129185644418.png" alt="image-20230129185644418" /></p>
<hr />
<h3 id="时间片太大小的影响"><a class="anchor" href="#时间片太大小的影响">#</a> 时间片太大 / 小的影响</h3>
<p>如果<strong>时间片太大</strong>，使得每个进程都可以在一个时间片内就完成，</p>
<ul>
<li>
<p>则时间片轮转调度算法 <code>退化</code> 为<strong>先来先服务</strong>调度算法，</p>
<p>并且<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>会增大进程响应时间</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}会增大进程响应时间</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">会增大进程响应时间</span></span></span></span>。</p>
<p>比如：系统中有 10 个进程在并发执行，如果时间片为 1 秒，则一个进程被响应可能需要等 9 秒...</p>
<ul>
<li>
<p>也就是说，如果用户在自己进程的时间片外通过键盘发出调试命令，</p>
<p>可能需要等待 9 秒才能被系统响应</p>
</li>
<li>
<p>其实就是时间片太长了，导致后面的进程等待时间也会太长</p>
</li>
</ul>
</li>
<li>
<p>因此<strong>时间片不能太大</strong>。</p>
</li>
</ul>
<p>另一方面，进程调度、切换是有时间代价的（保存、恢复运行环境)，</p>
<ul>
<li>
<p>因此如果<strong>时间片太小</strong>，会导致 <code>进程切换过于频繁</code> （不断地频繁切换用户态与内核态），系统会花大量的时间来处理进程切换，</p>
<p>从而导致实际用于进程执行的时间比例减少。</p>
</li>
<li>
<p>可见<strong>时间片也不能太小</strong>。</p>
</li>
</ul>
<p>一般来说，设计时间片时要让切换进程的开销占比不超过 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">1\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">1%</span></span></span></span></p>
<h2 id="优先级调度算法"><a class="anchor" href="#优先级调度算法">#</a> 优先级调度算法</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129194948005.png" alt="image-20230129194948005" /></p>
<hr />
<p>例题：各进程到达就绪队列的时间、需要的运行时间、进程优先数如下表所示。使用<strong>非抢占式</strong>的<strong>优先级</strong>调度算法，分析进程运行情况。（注：<strong>优先数</strong>越大，<strong>优先级</strong>越高)</p>
<h3 id="非抢占式的"><a class="anchor" href="#非抢占式的">#</a> 非抢占式的</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129191523357.png" alt="image-20230129191523357" /></p>
<h3 id="抢占式的"><a class="anchor" href="#抢占式的">#</a> 抢占式的</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129193143525.png" alt="image-20230129193143525" /></p>
<h3 id="静态动态优先级"><a class="anchor" href="#静态动态优先级">#</a> 静态 / 动态优先级</h3>
<p>就绪队列未必只有一个，可以按照不同优先级来组织。</p>
<ul>
<li>另外，也可以把优先级高的进程排在更靠近队头的位置</li>
</ul>
<p>根据优先级是否可以动态改变，可将优先级分为<strong>静态优先级</strong>和<strong>动态优先级</strong>两种。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>静态优先级</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}静态优先级</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">静态优先级</span></span></span></span>：</p>
<ul>
<li>创建进程时确定，之后一直不变。</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>动态优先级</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}动态优先级</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">动态优先级</span></span></span></span>：</p>
<ul>
<li>创建进程时有一个初始值，之后会根据情况动态地调整优先级。</li>
</ul>
<hr />
<p><strong>如何合理地设置各类进程地优先级？</strong></p>
<p>通常：</p>
<ul>
<li>系统进程优先级 <strong>高于</strong> 用户进程</li>
<li>前台进程优先级 <strong>高于</strong> 后台进程</li>
<li>操作系统更偏好  <code>I/O</code>  型进程（或称  <code>I/O</code>  繁忙型进程）</li>
</ul>
<p>注：与  <code>I/O</code>  型进程相对的是<strong>计算型进程</strong>（或称  <code>CPU</code>  繁忙型进程）</p>
<p><code>I/O</code>  设备和  <code>CPU</code>  可以<strong>并行</strong>工作。如果优先让  <code>I/O</code>  繁忙型进程优先运行的话，</p>
<ul>
<li>则越有可能让  <code>I/O</code>  设备尽早地投入工作，则资源利用率、系统吞吐量都会得到提升</li>
<li><code>I/O</code>  花费的时间一般比较长，尽早处理完  <code>I/O</code></li>
</ul>
<p>若采用  <code>CPU</code>  繁忙型进程的话，</p>
<ul>
<li><code>CPU</code>  优先于  <code>I/O</code> ，则  <code>CPU</code>  运行完之后，此时后备队列中没有队列了，需要等待  <code>I/O</code>  设备输入</li>
</ul>
<hr />
<p><strong>如果采用的是动态优先级，什么时候应该调整？</strong></p>
<p>可以从追求公平、提升资源利用率等角度考虑</p>
<ul>
<li>
<p>如果某进程在就绪队列中等待了很长时间，则可以适当提升其优先级</p>
</li>
<li>
<p>如果某进程占用处理机运行了很长时间，则可适当降低其优先级</p>
</li>
<li>
<p>如果发现一个进程频繁地进行  <code>I/O</code>  操作，则可适当提升其优先级</p>
</li>
</ul>
<p><code>HRRN</code>  高响应比优先调度算法，可以认为是动态地优先级调度算法</p>
<h2 id="多级反馈队列调度算法"><a class="anchor" href="#多级反馈队列调度算法">#</a> 多级反馈队列调度算法</h2>
<p><code>FCFS</code>  算法的优点是公平</p>
<p><code>SJF</code>  算法的优点是能尽快处理完短作业，平均等待 / 周转时间等参数很优秀</p>
<p>时间片轮转调度算法可以让各个进程得到及时的响应</p>
<p>优先级调度算法可以灵活地调整各种进程被服务的机会</p>
<p>能否对其他算法做个折中权衡？得到一个综合表现优秀平衡的算法呢？</p>
<ul>
<li>多级反馈队列调度算法</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129204837476.png" alt="image-20230129204837476" /></p>
<p>由于进程源源不断地到来会使得高优先级的队列始终非空，而低优先级的队列需要等待高优先级的队列为空时才能使用，导致低优先级队列中的进程饥饿</p>
<hr />
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129204010547.png" alt="image-20230129204010547" /></p>
<h2 id="总结-2"><a class="anchor" href="#总结-2">#</a> 总结</h2>
<table>
<thead>
<tr>
<th>算法</th>
<th>可抢占？</th>
<th>优点</th>
<th>缺点</th>
<th>会导致饥饿？</th>
<th>补充</th>
</tr>
</thead>
<tbody>
<tr>
<td>时间片轮转</td>
<td>抢占式</td>
<td>公平；适用于分时系统</td>
<td>频繁切换有开销；不区分优先级</td>
<td>不会</td>
<td>时间片太大或太小导致的影响</td>
</tr>
<tr>
<td>优先级调度</td>
<td>有的抢占式的，有的非抢占式的</td>
<td>区分优先级；适用于实时系统</td>
<td>可能导致饥饿</td>
<td>会</td>
<td>动态 / 静态优先级。各类型型进程如何设置优先级？如何调整优先级</td>
</tr>
<tr>
<td>多级反馈队列</td>
<td>抢占式</td>
<td>平衡优秀；6（9 翻了）</td>
<td>一般不说它优缺点；不过可能导致饥饿</td>
<td>会</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>注</strong>：比起早期的批处理操作系统来说，由于计算机造价大幅降低，因此之后出现的交互式操作系统（包括分时操作系统、实时操作系统等）更注重系统的响应时间、公平性、平衡性等指标。</p>
<ul>
<li>而这几种算法恰好也能较好地满足交互式系统的需求。</li>
</ul>
<p>因此这三种算法适合用于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>交互式系统</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}交互式系统</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">交互式系统</span></span></span></span></p>
<ul>
<li>比如  <code>UNIX</code>  使用的就是多级反馈队列调度算法</li>
</ul>
<h1 id="进程同步与互斥"><a class="anchor" href="#进程同步与互斥">#</a> 进程同步与互斥</h1>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129205753999.png" alt="image-20230129205753999" /></p>
<h2 id="什么是进程同步"><a class="anchor" href="#什么是进程同步">#</a> 什么是进程同步</h2>
<h3 id="回顾异步性"><a class="anchor" href="#回顾异步性">#</a> 回顾异步性</h3>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>异步</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}异步</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">异步</span></span></span></span>是指，</p>
<ul>
<li>在多道程序环境下，允许多个程序并发执行，但由于资源有限，进程的执行不是一贯到底的，而是<strong>走走停停</strong>，以不可预知的速度向前推进，这就是进程的异步性。</li>
</ul>
<p>由于系统的<strong>有限资源导致的</strong></p>
<p>例如：老渣要和两个女孩并发约会</p>
<p>一号的指令 1 ：老渣陪我吃饭</p>
<p>一号的指令 2 ：老渣把心给我</p>
<p>二号的指令 1 ：老渣把心给我</p>
<p>二号的指令 2 ：老渣陪我吃饭</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230112195333739.png" alt="image-20230112195333739" /></p>
<p>与一号、二号的约会相当于对两个进程的处理，每个进程都有各自需要执行的指令。</p>
<p>老渣的心相当于<strong>有限的系统资源</strong>。</p>
<hr />
<p>若女一号只想做老渣的初恋</p>
<p>女二号只想交一个有恋爱经验的渣男</p>
<p>那么，老渣在并发执行这两个约会进程的时候，就必须保证 “一号的指令 2” 一定要在 二号的指令 1” <strong>之前执行</strong>。</p>
<p>操作系统需要提供 &quot;进程同步机制&quot; 来实现上述需求</p>
<hr />
<h3 id="回顾进程通信-管道通信"><a class="anchor" href="#回顾进程通信-管道通信">#</a> 回顾进程通信 -- 管道通信</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129212810491.png" alt="image-20230129212810491" /></p>
<p>读进程和写进程并发地运行，由于并发必然导致异步性，</p>
<ul>
<li>因此 “写数据” 和 “读数据” 两个操作执行的先后顺序是不确定的。</li>
</ul>
<p>而实际应用中，又必须按照 “<strong>写数据→读数据</strong>” 的顺序来执行的。</p>
<p>如何解决这种<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>异步</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}异步</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">异步</span></span></span></span>问题，</p>
<ul>
<li>就是 “进程<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>同步</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}同步</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">同步</span></span></span></span>” 所讨论的内容。</li>
</ul>
<h3 id="同步直接制约关系"><a class="anchor" href="#同步直接制约关系">#</a> 同步（直接制约关系）</h3>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>同步</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}同步</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">同步</span></span></span></span>亦称<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>直接制约关系</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}直接制约关系</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">直接制约关系</span></span></span></span>，</p>
<ul>
<li>它是指为完成某种任务而建立的两个或多个进程，这些进程因为需要在某些位置上<strong>协调</strong>它们的<strong>工作次序</strong>而产生的制约关系。</li>
<li>进程间的直接制约关系就是源于它们之间的相互合作。</li>
</ul>
<h2 id="进程互斥间接制约关系"><a class="anchor" href="#进程互斥间接制约关系">#</a> 进程互斥（间接制约关系）</h2>
<p>进程的 “并发” 需要 “共享” 的支持。各个并发执行的进程不可避免的需要共享一些系统资源</p>
<ul>
<li>比如内存，又比如打印机、摄像头这样的  <code>I/O</code>  设备</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230112191158930.png" alt="image-20230112191158930" /></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>临界资源</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}临界资源</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">临界资源</span></span></span></span></p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>一个时间段内只允许一个进程使用</mtext></mstyle></mrow><annotation encoding="application/x-tex">\textcolor{red}{一个时间段内只允许一个进程使用}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">一个时间段内只允许一个进程使用</span></span></span></span> 的资源</li>
</ul>
<p>许多物理设备（比如摄像头、打印机）都属于临界资源。</p>
<p>此外还有许多变量、数据、内存缓冲区等都属于临界资源。</p>
<p>对临界资源的访问，必须<strong>互斥</strong>地进行。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>互斥</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}互斥</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">互斥</span></span></span></span>，亦称<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>间接制约关系</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}间接制约关系</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">间接制约关系</span></span></span></span>。</p>
<ul>
<li><strong>进程互斥</strong>指当一个进程访问某临界资源时，另一个想要访问该临界资源的进程<strong>必须等待</strong>。当前访问临界资源的进程访问结束，释放该资源之后另一个进程才能去访问临界资源。</li>
</ul>
<h3 id="对临界资源的互斥访问四个部分"><a class="anchor" href="#对临界资源的互斥访问四个部分">#</a> 对临界资源的互斥访问（四个部分）</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129213940492.png" alt="image-20230129213940492" /></p>
<p><strong>注意</strong>：</p>
<ul>
<li>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>临界区</mtext></mstyle></mrow><annotation encoding="application/x-tex">\textcolor{red}{临界区}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">临界区</span></span></span></span> 是进程中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>访问临界资源</mtext></mstyle></mrow><annotation encoding="application/x-tex">\textcolor{red}{访问临界资源}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">访问临界资源</span></span></span></span> 的代码段。</p>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进入区</mtext></mstyle></mrow><annotation encoding="application/x-tex">\textcolor{red}{进入区}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进入区</span></span></span></span> 和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>退出区</mtext></mstyle></mrow><annotation encoding="application/x-tex">\textcolor{red}{退出区}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">退出区</span></span></span></span> 是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>负责实现互斥</mtext></mstyle></mrow><annotation encoding="application/x-tex">\textcolor{red}{负责实现互斥}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">负责实现互斥</span></span></span></span> 的代码段。</p>
</li>
<li>
<p>临界区也可以称为 &quot;临界段&quot;</p>
</li>
</ul>
<hr />
<p>如果一个进程暂时不能进入临界区，</p>
<ul>
<li>
<p>那么该进程是否应该一直占着处理机？</p>
</li>
<li>
<p>该进程有没有可能一直进不了临界区？</p>
</li>
</ul>
<h3 id="遵循的原则"><a class="anchor" href="#遵循的原则">#</a> 遵循的原则</h3>
<ol>
<li>
<p><strong>空闲让进</strong>。临界区空闲时，可以允许一个请求进入临界区的进程立即进入临界区；</p>
</li>
<li>
<p><strong>忙则等待</strong>。当已有进程进入临界区时，其他试图进入临界区的进程必须等待；</p>
</li>
<li>
<p><strong>有限等待</strong>。对请求访问的进程，应保证能在有限时间内进入临界区（保证不会饥饿）;</p>
</li>
<li>
<p><strong>让权等待</strong>。当进程不能进入临界区时，应立即释放处理机，防止进程忙等待。</p>
</li>
</ol>
<h2 id="整体框架-9"><a class="anchor" href="#整体框架-9">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129215102372.png" alt="image-20230129215102372" /></p>
<h1 id="进程互斥的软件实现方法"><a class="anchor" href="#进程互斥的软件实现方法">#</a> 进程互斥的软件实现方法</h1>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129215232588.png" alt="image-20230129215232588" /></p>
<p>学习提示:</p>
<ol>
<li>理解各个算法的思想、原理</li>
<li>结合上小节学习的 “实现互斥的四个逻辑部分”，重点理解各算法在进入区、退出区都做了什么</li>
<li>分析各算法存在的缺陷（结合 “实现互斥要遵循的四个原则” 进行分析）</li>
</ol>
<h2 id="单标志法"><a class="anchor" href="#单标志法">#</a> 单标志法</h2>
<p>算法思想：两个进程在<strong>访问完临界区后</strong>会把使用临界区的权限转交给另一个进程。</p>
<ul>
<li>也就是说<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>每个进程进入临界区的权限只能被另一个进程赋予</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}每个进程进入临界区的权限只能被另一个进程赋予</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">每个进程进入临界区的权限只能被另一个进程赋予</span></span></span></span></li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129223624058.png" alt="image-20230129223624058" /></p>
<p>turn 的初值为 0，即刚开始只允许 0 号进程进入临界区。</p>
<p>若  <code>P1</code>  先上处理机运行，则会一直卡在 ⑤。直到  <code>P1</code>  的时间片用完，发生调度，切换  <code>P0</code>  上处理机运行。</p>
<p>代码 ① 不会卡住  <code>P0</code> ， <code>P0</code>  可以正常访问临界区，在  <code>P0</code>  访问临界区期间即时切换回  <code>P1</code> ， <code>P1</code>  依然会卡在⑤。</p>
<p>只有  <code>P0</code>  在退出区将 turn 改为 1 后， <code>P1</code>  才能进入临界区。</p>
<p>因此，该算法可以实现 “<strong>同一时刻最多只允许一个进程访问临界区</strong>”</p>
<hr />
<p>turn 表示当前允许进入临界区的进程号，而只有当前允许进入临界区的进程在访问了临界区之后，才会修改 turn 的值。</p>
<ul>
<li>也就是说，对于临界区的访问，一定是按 P0→P1→P0→P1→...... 这样轮流访问。</li>
</ul>
<hr />
<p>这种必须 “轮流访问” 带来的<strong>问题</strong>是，</p>
<ul>
<li>如果此时允许进入临界区的进程是  <code>P0</code> ，而  <code>P0</code>  一直<strong>不访问临界区</strong>，那么虽然此时临界区空闲，但是并不允许  <code>P1</code>  访问。</li>
</ul>
<p>因此，<strong>单标志法</strong>存在的<strong>主要问题</strong>是：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>违背空闲让进原则</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}违背空闲让进原则</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">违背空闲让进原则</span></span></span></span>。</li>
</ul>
<h2 id="双标志先检查法"><a class="anchor" href="#双标志先检查法">#</a> 双标志先检查法</h2>
<p>算法思想：设置一个布尔型数组 flag [] ，数组中各个元素用来<strong>标记各进程想进入临界区的意愿</strong>，</p>
<ul>
<li>比如 “flag [0] = true” 意味着 0 号进程  <code>P0</code>  现在想要进入临界区。</li>
</ul>
<p>每个进程在进入临界区之前先检查当前有没有别的进程想进入临界区，</p>
<ul>
<li>如果没有，则把自身对应的标志 flag [i] 设为 true，之后开始访问临界区。</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129225120954.png" alt="image-20230129225120954" /></p>
<p>若按照 ①⑤②⑥③⑦.... 顺序执行， <code>P0</code>  和  <code>P1</code>  将会同时访问临界区。</p>
<p>因此，<strong>双标志先检查法</strong>存在的<strong>主要问题</strong>是：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>违背忙则等待原则</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}违背忙则等待原则</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">违背忙则等待原则</span></span></span></span>。</li>
</ul>
<p>原因在于，<strong>进入区</strong>的 “检查” 和 “上锁” <strong>两个处理不是一气呵成的</strong>。“检查” 后，“上锁” 前可能发生讲程切换</p>
<h2 id="双标志后检查法"><a class="anchor" href="#双标志后检查法">#</a> 双标志后检查法</h2>
<p>算法思想：双标志先检查法的改版。前一个算法的问题是先 “检查” 后 “上锁” ，但是这两个操作又无法一气呵成，因此导致了两个进程同时进入临界区的问题。</p>
<ul>
<li>因此，人们又想到先 “上锁” 后 “检查” 的方法，来避免上述问题。</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129225707180.png" alt="image-20230129225707180" /></p>
<p>若按照 ①⑤②⑥.... 的顺序执行， <code>P0</code>  和  <code>P1</code>  将都无法进入临界区</p>
<ul>
<li>相当于<strong>死锁</strong>，两方都一直等待对方</li>
</ul>
<p>因此，双标志后检查法虽然<strong>解决了 “忙则等待”</strong> 的问题，</p>
<ul>
<li>但是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>又违背了空闲让进和有限等待原则</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}又违背了空闲让进和有限等待原则</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">又违背了空闲让进和有限等待原则</span></span></span></span></li>
</ul>
<p>会因各进程都长期无法访问临界资源而产生 “ <code>饥饿</code> ” 现象。</p>
<p>两个进程都争着想进入临界区，但是谁也不让谁，最后谁都无法进入临界区。</p>
<h2 id="peterson-算法"><a class="anchor" href="#peterson-算法">#</a> Peterson 算法</h2>
<p>算法思想：双标志后检查法中，两个进程都争着想进入临界区，但是谁也不让谁，最后谁都无法进入临界区。</p>
<p><code>Gary L.Peterson</code>  想到了一种方法，如果双方都争着想进入临界区，那可以让进程尝试 “孔融让梨” ，主动让对方先使用临界区。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129230951082.png" alt="image-20230129230951082" /></p>
<p>两种双标志法的问题都是由于进入区的几个操作不能一气呵成导致的。</p>
<p>我们可以推理验证在  <code>Peterson</code>  算法中，两个进程进入区中的各个操作按不同的顺序穿插执行会发生什么情况:</p>
<ul>
<li>
<p>①②③⑥⑦⑧...</p>
</li>
<li>
<p>①⑥②③...</p>
</li>
</ul>
<p>因为 turn 只有一个，必然有一个判断是 false，所以不会产生死锁</p>
<p>抛开 turn 不谈，就回到了双标志后检查法，所以不会出现<strong>单标志法的问题</strong></p>
<ul>
<li>单标志法的问题：如果此时允许进入临界区的进程是  <code>P0</code> ，而  <code>P0</code>  一直<strong>不访问临界区</strong>，那么虽然此时临界区空闲，但是并不允许  <code>P1</code>  访问。</li>
</ul>
<hr />
<p><strong>进入区</strong>:</p>
<ol>
<li>主动争取；</li>
<li>主动谦让；</li>
<li>检查对方是否也想使用，且最后一次是不是自己说了 “客气话”</li>
</ol>
<hr />
<p><strong>例如</strong>：</p>
<ul>
<li>
<p>香香想用马桶，如果需要的话，可以先让臭臭用，</p>
<p>检查发现臭臭不需要，于是香香访问临界区 —―马桶。</p>
</li>
<li>
<p>臭臭想用马桶，可以让香香先用</p>
<p>香香想用马桶，可以让臭臭先用</p>
<p>经检查发现香香也要使用，但最后是臭臭说了 &quot;客气话&quot;，因此臭臭循环等待</p>
</li>
</ul>
<hr />
<p><code>Peterson</code>  算法用软件方法解决了进程互斥问题，</p>
<ul>
<li>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>遵循了空闲让进、忙则等待、有限等待三个原则</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}遵循了空闲让进、忙则等待、有限等待三个原则</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">遵循了空闲让进、忙则等待、有限等待三个原则</span></span></span></span></p>
</li>
<li>
<p>但是依然<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>未遵循让权等待</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}未遵循让权等待</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">未遵循让权等待</span></span></span></span>的原则。</p>
</li>
</ul>
<p><code>Peterson</code>  算法相较于之前三种软件解决方案来说，是最好的，但依然不够好。</p>
<h2 id="整体框架-10"><a class="anchor" href="#整体框架-10">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230129232806721.png" alt="image-20230129232806721" /></p>
<p>上述并不是概览，不同的算法应该相应的分析</p>
<h1 id="进程互斥的硬件实现方法"><a class="anchor" href="#进程互斥的硬件实现方法">#</a> 进程互斥的硬件实现方法</h1>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230201220123976.png" alt="image-20230201220123976" /></p>
<h2 id="中断屏蔽方法"><a class="anchor" href="#中断屏蔽方法">#</a> 中断屏蔽方法</h2>
<p>利用 “<strong>开 / 关中断指令</strong>” 实现（与原语的实现思想相同，即在某进程开始访问临界区到结束访问为止都不允许被中断，也就不能发生进程切换，因此也不可能发生两个同时访问临界区的情况）</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230201220233739.png" alt="image-20230201220233739" /></p>
<p>优点：简单、高效</p>
<p>缺点：</p>
<ul>
<li>
<p>不适用于多处理机（多个处理机访问同一个临界区，导致其中剩余的处理机会一值等待）；</p>
</li>
<li>
<p><strong>只适用于操作系统内核进程</strong>；</p>
</li>
<li>
<p>不适用于用户进程（因为开 / 关中断指令只能运行在内核态，这组指令如果能让用户随意使用会很危险）</p>
</li>
</ul>
<h2 id="testandset"><a class="anchor" href="#testandset">#</a> TestAndSet</h2>
<p>简称  <code>TS</code>  指令，也有地方称为  <code>TestAndSetLock</code>  指令，或  <code>TSL</code>  指令</p>
<p><code>TSL</code>  指令是用硬件实现的，执行的过程不允许被中断，只能一气呵成。以下是用 C 语言描述的逻辑</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230201221855703.png" alt="image-20230201221855703" /></p>
<p>若刚开始  <code>lock</code>  是 false，则  <code>TSL</code>  返回的  <code>old</code>  值为 false， <code>while</code>  循环条件不满足，直接跳过循环，进入临界区。若刚开始  <code>lock</code>  是  <code>true</code> ，则执行  <code>TLS</code>  后  <code>old</code>  返回的值为  <code>true</code> ， <code>while</code>  循环条件满足，会一直循环，直到当前访问临界区的进程在退出区进行 “解锁”。</p>
<p>相比软件实现方法， <code>TSL</code>  指令把 “上锁” 和 “检查” 操作用硬件的方式变成了<strong>一气呵成的原子操作</strong>。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>
<p>实现简单，无需像软件实现方法那样严格检查是否会有逻辑漏洞；</p>
</li>
<li>
<p>适用于多处理机环境</p>
<p>其他进程会卡在 ts 循环里面</p>
</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>不满足 “<strong>让权等待</strong>” 原则，暂时无法进入临界区的进程会占用  <code>CPU</code>  并循环执行  <code>TSL</code>  指令，从而导致 “忙等” 。</li>
</ul>
<h2 id="swap指令"><a class="anchor" href="#swap指令">#</a> Swap 指令</h2>
<p>有的地方也叫  <code>Exchange</code>  指令，或简称  <code>XCHG</code>  指令。<br />
 <code>Swap</code>  指令是用硬件实现的，执行的过程不允许被中断，只能一气呵成。以下是用 C 语言描述的逻辑</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230201222829718.png" alt="image-20230201222829718" /></p>
<p>逻辑上来看  <code>Swap</code>  和  <code>TSL</code>  并无太大区别，都是先记录下此时临界区是否已经被上锁（记录在  <code>old</code>  变量上)，再将上锁标记  <code>lock</code>  设置为 true，最后检查  <code>old</code> ，如果  <code>old</code>  为 false 则说明之前没有别的进程对临界区上锁，则可跳出循环，进入临界区。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>
<p>实现简单，无需像软件实现方法那样严格检查是否会有逻辑漏洞；</p>
</li>
<li>
<p>适用于多处理机环境</p>
<p>其他进程会卡在 ts 循环里面</p>
</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>不满足 “<strong>让权等待</strong>” 原则，暂时无法进入临界区的进程会占用  <code>CPU</code>  并循环执行  <code>Swap</code>  指令，从而导致 “忙等” 。</li>
</ul>
<h2 id="整体框架-11"><a class="anchor" href="#整体框架-11">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230201223231647.png" alt="image-20230201223231647" /></p>
<h1 id="信号量机制"><a class="anchor" href="#信号量机制">#</a> 信号量机制</h1>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230201224127062.png" alt="image-20230201224127062" /></p>
<p>复习回顾 + 思考：之前学习的这些进程互斥的解决方案分别存在哪些问题？</p>
<p>进程互斥的四种软件实现方式（单标志法、双标志先检查、双标志后检查、 <code>Peterson</code>  算法)</p>
<p>进程互斥的三种硬件实现方式（中断屏蔽方法、 <code>TS/TSL</code>  指令、 <code>Swap/XCHG</code>  指令)</p>
<ol>
<li>
<p>在双标志先检查法中，<strong>进入区的 “检查”、“上锁” 操作无法一气呵成</strong>，从而导致了两个进程有可能同时进入临界区的问题；</p>
</li>
<li>
<p>所有的解决方案都<strong>无法实现 “让权等待”</strong></p>
</li>
</ol>
<p>1965 年，荷兰学者  <code>Dijkstra</code>  提出了一种卓有成效的实现进程互斥、同步的方法――信号量机制</p>
<hr />
<p>用户进程可以通过使用操作系统提供的<strong>一对原语</strong>来对<strong>信号量</strong>进行操作，从而很方便的实现了进程互斥、进程同步。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>信号量</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}信号量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">信号量</span></span></span></span> ：</p>
<ul>
<li>
<p>其实就是一个变量（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="blue"><mtext>可以是一个整数，也可以是更复杂的记录型变量</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{blue}可以是一个整数，也可以是更复杂的记录型变量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:blue;">可以是一个整数，也可以是更复杂的记录型变量</span></span></span></span>)，</p>
</li>
<li>
<p>可以用一个信号量来<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>表示系统中某种资源的数量</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}表示系统中某种资源的数量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">表示系统中某种资源的数量</span></span></span></span></p>
<p>比如：系统中只有一台打印机，就可以设置一个初值为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 的信号量。</p>
</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>原语</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}原语</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">原语</span></span></span></span></p>
<ul>
<li>是一种特殊的程序段，其<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>执行只能一气呵成，不可被中断</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}执行只能一气呵成，不可被中断</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">执行只能一气呵成，不可被中断</span></span></span></span>。</li>
<li>原语是由<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>关中断</mtext><mi mathvariant="normal">/</mi><mtext>开中断指令</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}关中断/开中断指令</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord cjk_fallback" style="color:red;">关中断</span><span class="mord" style="color:red;">/</span><span class="mord cjk_fallback" style="color:red;">开中断指令</span></span></span></span>实现的。</li>
<li>软件解决方案的主要问题是由 “进入区的各种操作无法一气呵成” ，因此如果能把<strong>进入区、退出区的操作都用 “原语” 实现</strong>，使这些操作能 “一气呵成” 就能避免问题。</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>一对原语</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}一对原语</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">一对原语</span></span></span></span>:</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext mathvariant="monospace">wait(S)</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}\texttt{wait(S)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">wait(S)</span></span></span></span></span> 原语和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext mathvariant="monospace">signal(S)</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}\texttt{signal(S)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9167em;vertical-align:-0.2222em;"></span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">signal(S)</span></span></span></span></span> 原语</li>
<li>可以把原语理解为我们自己写的函数，函数名分别为  <code>wait</code>  和  <code>signal</code> ，</li>
<li>括号里的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>信号量</mtext><mtext mathvariant="monospace">S</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}信号量 \texttt{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">信号量</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">S</span></span></span></span></span> 其实就是函数调用时传入的一个参数。</li>
</ul>
<p><code>wait</code> 、 <code>signal</code>  原语常<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>简称为</mtext><mtext mathvariant="monospace">P、V</mtext><mtext>操作</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}简称为 \texttt{P、V}操作</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">简称为</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">P</span><span class="mord texttt cjk_fallback" style="color:red;">、</span><span class="mord texttt" style="color:red;">V</span></span><span class="mord cjk_fallback" style="color:red;">操作</span></span></span></span>（来自荷兰语 proberen ：<strong>尝试</strong> 和 verhogen ：<strong>增加</strong>）</p>
<ul>
<li>因此，做题的时候常把  <code>wait(S)</code> 、 <code>signal(S)</code>  两个操作分别写为  <code>P(S)</code> 、 <code>V(S)</code></li>
</ul>
<h2 id="整形信号量"><a class="anchor" href="#整形信号量">#</a> 整形信号量</h2>
<p>用一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>整数型的变量</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}整数型的变量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">整数型的变量</span></span></span></span>作为信号量，用来<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>表示系统中某种资源的数量</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}表示系统中某种资源的数量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">表示系统中某种资源的数量</span></span></span></span>。</p>
<p>与普通整数变量的区别：对信号量的操作只有三种，</p>
<ul>
<li>即初始化、 <code>P</code>  操作、 <code>V</code>  操作</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230201225118579.png" alt="image-20230201225118579" /></p>
<p><code>P</code>  操作中：“检查” 和 “上锁” 一气呵成，避免了并发、异步导致的问题</p>
<ul>
<li>因为这是原语</li>
</ul>
<p>存在的问题：不满足 “让权等待” 原则，会发生 “忙等”</p>
<ul>
<li>卡在  <code>while</code>  循环中，因为这是原语，不可中断，会一直卡在  <code>while</code>  循环中，除非有资源</li>
</ul>
<p>例如：<img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230201225128992.png" alt="image-20230201225128992" /></p>
<h2 id="记录型信号量"><a class="anchor" href="#记录型信号量">#</a> 记录型信号量</h2>
<p>整型信号量的缺陷是存在 “忙等” 问题，因此人们又提出了 “记录型信号量”，即用记录型数据结构表示的信号量。</p>
<p>Java 中典型的 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_67720621/article/details/127708498">AQS</a></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230201230543927.png" alt="image-20230201230543927" /></p>
<p>若剩余资源 &gt; 0 的话，说明没有进程在等待这种资源，就不需要唤醒了</p>
<hr />
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/PV-16752652694592.gif" alt="PV" /></p>
<hr />
<p>在考研题目中  <code>wait(S)</code> 、 <code>signal(S)</code>  也可以记为  <code>P(S)</code> 、 <code>V(S)</code>  ,</p>
<ul>
<li>这对原语可用于实现系统资源的 “申请” 和 “释放”。</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext mathvariant="monospace">S.value</mtext><mtext>的初值</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}\texttt{S.value} 的初值</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">S.value</span></span><span class="mord cjk_fallback" style="color:red;">的初值</span></span></span></span>表示系统中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>某种资源的数目</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}某种资源的数目</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">某种资源的数目</span></span></span></span></p>
<p>对信号量  <code>S</code>  的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>一次</mtext><mtext mathvariant="monospace">Р</mtext><mtext>操作</mtext></mstyle><mtext>意味着进程</mtext><mstyle mathcolor="red"><mtext>请求一个单位的该类资源</mtext></mstyle></mrow><annotation encoding="application/x-tex">\textcolor{red}{一次 \texttt{Р}操作}意味着进程\textcolor{red}{请求一个单位的该类资源}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">一次</span><span class="mord text" style="color:red;"><span class="mord texttt cyrillic_fallback" style="color:red;">Р</span></span><span class="mord cjk_fallback" style="color:red;">操作</span><span class="mord cjk_fallback">意味着进程</span><span class="mord cjk_fallback" style="color:red;">请求一个单位的该类资源</span></span></span></span></p>
<ul>
<li>
<p>因此需要执行  <code>S.value--</code> ，表示资源数减 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> ，</p>
</li>
<li>
<p>当  <code>S.value &lt; 0</code>  时表示该类资源已分配完毕，因此进程应调用  <code>block</code>  原语进行<strong>自我阻塞</strong>（当前运行的进程<strong>从运行态→阻塞态</strong>)，主动放弃处理机，并插入该类资源的等待队列  <code>S.L</code>  中。</p>
</li>
<li>
<p>可见，<strong>该机制遵循了 “让权等待” 原则</strong>，不会出现 “忙等” 现象。</p>
</li>
</ul>
<p>对信号量  <code>S</code>  的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>一次</mtext><mtext mathvariant="monospace">V</mtext><mtext>操作</mtext></mstyle><mtext>意味着进程</mtext><mstyle mathcolor="red"><mtext>释放一个单位的该类资源</mtext></mstyle></mrow><annotation encoding="application/x-tex">\textcolor{red}{一次 \texttt{V}操作}意味着进程\textcolor{red}{释放一个单位的该类资源}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">一次</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">V</span></span><span class="mord cjk_fallback" style="color:red;">操作</span><span class="mord cjk_fallback">意味着进程</span><span class="mord cjk_fallback" style="color:red;">释放一个单位的该类资源</span></span></span></span></p>
<ul>
<li>因此需要执行  <code>S.value++</code> ，表示资源数加 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，</li>
<li>若加 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 后仍是  <code>S.value &lt;=0</code> ，表示依然有进程在等待该类资源，因此应调用  <code>wakeup</code>  原语<strong>唤醒等待队列中的第一个进程</strong>（被唤醒进程<strong>从阻塞态→就绪态</strong>）。</li>
</ul>
<h2 id="整体框架-12"><a class="anchor" href="#整体框架-12">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230201233812333.png" alt="image-20230201233812333" /></p>
<p>注：若考试中出现  <code>P(S)</code> 、 <code>V(S)</code>  的操作，除非特别说明，否则默认  <code>S</code>  为记录型信号量。</p>
<h1 id="用信号量机制实现进程互斥-同步-前驱关系"><a class="anchor" href="#用信号量机制实现进程互斥-同步-前驱关系">#</a> 用信号量机制实现进程互斥、同步、前驱关系</h1>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230201234139626.png" alt="image-20230201234139626" /></p>
<h2 id="信号量机制实现进程互斥"><a class="anchor" href="#信号量机制实现进程互斥">#</a> 信号量机制实现进程互斥</h2>
<ol>
<li>
<p>分析并发进程的关键活动，划定临界区（如：对临界资源打印机的访问就应放在临界区)</p>
</li>
<li>
<p>设置<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>互斥信号量</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}互斥信号量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">互斥信号量</span></span></span></span>  <code>mutex</code> ，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>初值为</mtext><mn>1</mn></mstyle></mrow><annotation encoding="application/x-tex">\color{red}初值为 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">初值为</span><span class="mord" style="color:red;">1</span></span></span></span></p>
</li>
<li>
<p>在临界区之前执行  <code>P(mutex)</code></p>
</li>
<li>
<p>在临界区之后执行  <code>V(mutex)</code></p>
</li>
</ol>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202001741953.png" alt="image-20230202001741953" /></p>
<p>要会自己定义记录型信号量，但如果题目中没特别说明，可以把信号量的声明简写成这种形式</p>
<ul>
<li><code>semaphore mytex = 1</code></li>
</ul>
<hr />
<p><strong>注意</strong>：对不同的临界资源需要设置不同的互斥信号量</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202001958999.png" alt="image-20230202001958999" /></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext mathvariant="monospace">P、V</mtext><mtext>操作必须成对出现</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}\texttt{P、V} 操作必须成对出现</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">P</span><span class="mord texttt cjk_fallback" style="color:red;">、</span><span class="mord texttt" style="color:red;">V</span></span><span class="mord cjk_fallback" style="color:red;">操作必须成对出现</span></span></span></span></p>
<ul>
<li>缺少  <code>P(mutex)</code>  就不能保证临界资源的互斥访问</li>
<li>缺少  <code>V(mutex)</code>  会导致资源用不被释放，等待进程永不被唤醒</li>
</ul>
<h2 id="用信号量机制实现进程同步"><a class="anchor" href="#用信号量机制实现进程同步">#</a> 用信号量机制实现进程同步</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202002411247.png" alt="image-20230202002411247" /></p>
<p>比如， <code>P1</code> 、 <code>P2</code>  并发执行，由于存在异步性，因此二者交替推进的次序是不确定的。</p>
<p>若  <code>P2</code>  的 “代码 4” 要基于  <code>P1</code>  的 “代码 1” 和 “代码 2 ” 的运行结果才能执行，</p>
<ul>
<li>那么我们就必须保证 “代码 4” 一定是在 “代码 2 ” 之后才会执行。</li>
</ul>
<p>这就是进程同步问题，让本来异步并发的进程互相配合，有序推进。</p>
<hr />
<p>用信号量实现进程同步</p>
<ol>
<li>
<p>分析什么地方需要实现 “同步关系” ，即必须保证 “一前一后” 执行的两个操作（或两句代码）</p>
</li>
<li>
<p>设置<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>同步信号量</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}同步信号量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">同步信号量</span></span></span></span> S，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>初始为</mtext><mn>0</mn></mstyle></mrow><annotation encoding="application/x-tex">\color{red}初始为0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">初始为</span><span class="mord" style="color:red;">0</span></span></span></span></p>
</li>
<li>
<p>在 “<strong>前操作</strong>” <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>之后</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}之后</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">之后</span></span></span></span>执行  <code>V(S)</code></p>
</li>
<li>
<p>在 “<strong>后操作</strong>” <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>之前</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}之前</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">之前</span></span></span></span>执行  <code>P(S)</code></p>
</li>
</ol>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202003110757.png" alt="image-20230202003110757" /></p>
<p>若先执行到  <code>V(S)</code>  操作，则  <code>S++</code>  后  <code>S=1</code> 。</p>
<ul>
<li>之后当执行到  <code>P(S)</code>  操作时，由于  <code>S=1</code>  ，表示有可用资源，会执行  <code>S--</code>  ， <code>S</code>  的值变回  <code>0</code> ， <code>P2</code>  进程不会执行  <code>block</code>  原语，而是继续往下执行代码 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span>。</li>
<li>说明代码 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> 肯定是先于代码 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span> 执行的</li>
</ul>
<p>若先执行到  <code>P(S)</code>  操作，由于  <code>S=0</code> ， <code>S--</code>  后  <code>S=-1</code> ，表示此时没有可用资源，</p>
<ul>
<li>因此  <code>P</code>  操作中会执行  <code>block</code>  原语，主动请求阻塞。之后当执行完代码 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>，继而执行  <code>V(S)</code>  操作， <code>S++</code> ，使 S 变回 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>，由于此时有进程在该信号量对应的阻塞队列中，因此会在  <code>V</code>  操作中执行  <code>wakeup</code>  原语，唤醒  <code>P2</code>  进程。这样  <code>P2</code>  就可以继续执行代码 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span> 了</li>
</ul>
<p>可以理解为  <code>Java</code>  中的  <code>LockSupport.park()</code>  与  <code>LockSupport.unpark(...)</code></p>
<ul>
<li><code>LockSupport.park()</code>  对应  <code>P(S)</code></li>
<li><code>LockSupport.unpark(...)</code>   对应  <code>V(S)</code></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_67720621/article/details/127681204">LockSupport 与线程中断</a></p>
<hr />
<h2 id="用信号量机制实现前驱关系"><a class="anchor" href="#用信号量机制实现前驱关系">#</a> 用信号量机制实现前驱关系！！</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202005301540.png" alt="image-20230202005301540" /></p>
<h2 id="整体框架-13"><a class="anchor" href="#整体框架-13">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202005851995.png" alt="image-20230202005851995" /></p>
<p>除了互斥、同步问题外，还会考察有多个资源的问题，有多少资源就把信号量初值设为多少。</p>
<ul>
<li>申请资源时进行  <code>P</code>  操作，释放资源时进行  <code>V</code>  操作即可</li>
</ul>
<h1 id="生产者-消费者问题"><a class="anchor" href="#生产者-消费者问题">#</a> 生产者 - 消费者问题</h1>
<p>系统中有一组生产者进程和一组消费者进程，生产者进程每次生产一个产品放入缓冲区，消费者进程每次从缓冲区中取出一个产品并使用。（注：这里的 “产品” 理解为某种数据）</p>
<p>生产者、消费者共享一个初始为空、大小为 n 的缓冲区。</p>
<p>只有<strong>缓冲区没满</strong>时，生产者才能把产品放入缓冲区，否则必须等待。</p>
<ul>
<li>同步关系。缓冲区满时，生产者要等待消费者取走产品</li>
</ul>
<p>只有<strong>缓冲区不空</strong>时，消费者才能从中取出产品，否则必须等待。</p>
<ul>
<li>同步关系。缓冲区为空时，消费者要等待生产者放入产品</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202165415248.png" alt="image-20230202165415248" /></p>
<p><strong>缓冲区是临界资源，各进程必须互斥地访问</strong></p>
<ul>
<li>若其他进程并发地向缓冲区放入数据，会导致之前的数据会被覆盖</li>
</ul>
<hr />
<p>如何用信号量机制（ <code>P</code>  、 <code>V</code>  操作）实现生产者、消费者进程的这些功能呢？</p>
<p>信号量机制可实现互斥、同步、对一类系统资源的申请和释放。</p>
<ul>
<li>
<p>设置初值为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 的互斥信号量</p>
</li>
<li>
<p>设置初值为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> 的同步信号量（实现 “一前一后”）</p>
</li>
<li>
<p>设置一个信号量，初始值即为资源的数量（本质上也属于 “同步问题”，若无空闲资源，则申请资源的进程需要等待别的进程释放资源后才能继续往下执行)</p>
</li>
</ul>
<hr />
<h2 id="pv-操作题目分析步骤"><a class="anchor" href="#pv-操作题目分析步骤">#</a> PV 操作题目分析步骤</h2>
<ol>
<li>
<p>关系分析。找出题目中描述的各个进程，分析它们之间的同步</p>
</li>
<li>
<p>整理思路。根据各进程的操作流程确定  <code>P</code> 、 <code>V</code>  操作的大致顺序。</p>
</li>
<li>
<p>设置信号量。设置需要的信号量，并根据题目条件确定信号量初值。</p>
<p>(互斥信号量初值一般为 1，同步信号量的初始值要看对应资源的初始值是多少）</p>
</li>
</ol>
<p>生产者每次要消耗（P）一个空闲缓冲区，并生产（V）一个产品</p>
<p>消费者每次要消耗（P）一个产品，并且释放一个空闲缓冲区（V）</p>
<p>往缓冲区中放入 / 取走产品需要互斥</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202171357580.png" alt="image-20230202171357580" /></p>
<h2 id="能否改变相邻-p-v-操作的顺序"><a class="anchor" href="#能否改变相邻-p-v-操作的顺序">#</a> 能否改变相邻 P、V 操作的顺序？</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202171529210.png" alt="image-20230202171529210" /></p>
<p>若此时缓冲区内已经放满产品，则  <code>empty=0</code> ， <code>full=n</code> 。</p>
<p>则生产者进程执行 ① 使  <code>mutex</code>  变为 0 ，再执行 ② ，由于已没有空闲缓冲区，因此生产者被阻塞。由于生产者阻塞，因此切换回消费者进程。消费者进程执行 ③ ，由于  <code>mutex</code>  为 0，即生产者还没释放对临界资源的 “锁”，因此消费者也被阻塞。</p>
<p>这就造成了生产者等待消费者释放空闲缓冲区，而消费者又等待生产者释放临界区的情况，生产者和消费者循环等待被对方唤醒，出现 “<strong>死锁</strong>”。</p>
<p>同样的，若缓冲区中没有产品，即  <code>full=0</code> ， <code>empty=n</code> 。按③④①的顺序执行就会发生死锁。</p>
<p>因此，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>实现互斥的</mtext><mtext mathvariant="monospace">P</mtext><mtext>操作一定要在实现同步的</mtext><mtext mathvariant="monospace">P</mtext><mtext>操作之后</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}实现互斥的\texttt{P}操作一定要在实现同步的\texttt{P}操作之后</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">实现互斥的</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">P</span></span><span class="mord cjk_fallback" style="color:red;">操作一定要在实现同步的</span><span class="mord text" style="color:red;"><span class="mord texttt" style="color:red;">P</span></span><span class="mord cjk_fallback" style="color:red;">操作之后</span></span></span></span>。</p>
<p><code>V</code>  操作不会导致进程阻塞，因此<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>两个V操作顺序可以交换</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}两个\text{V}操作顺序可以交换</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">两个</span><span class="mord text" style="color:red;"><span class="mord" style="color:red;">V</span></span><span class="mord cjk_fallback" style="color:red;">操作顺序可以交换</span></span></span></span></p>
<hr />
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202172147588.png" alt="image-20230202172147588" /></p>
<p>若放到  <code>PV</code>  操作之间会导致并发度降低，消费者花费更多的时间去使用产品，此时还没有释放临界资源，会导致生产者不断地等待消费者。</p>
<ul>
<li>例如：业务代码放入核心代码里</li>
</ul>
<h2 id="java-案例"><a class="anchor" href="#java-案例">#</a> Java 案例</h2>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Deque</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">LinkedList</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Condition</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantLock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">ProducerConsumerByLock</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 互斥资源</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 最大容量</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> maxSize <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Condition</span> full <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Condition</span> empty <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">//CompletableFuture.runAsync (new Consumer ()); 产生的进程默认是守护进程</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">// 生产者</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> maxSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"产品已满, 等待消费者进行消费, 当前生产者: "</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                        <span class="token comment">// 阻塞生产者，并释放当前线程的锁</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                            full<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>                    <span class="token comment">// 生产产品</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                    queue<span class="token punctuation">.</span><span class="token function">offerLast</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                    <span class="token comment">// 日志打印，业务逻辑尽量放在锁外面，这里只是为了顺序打印到控制台</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前生产者生产产品 "</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token string">", 当前生产者: "</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                    <span class="token comment">// 唤醒其他所有的消费者与生产者</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                    empty<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                    full<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 并发，让其他生产者也参与竞争</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token comment">// 消费者</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token comment">// 消费产品</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                <span class="token keyword">int</span> x<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"产品为空, 等待生产者进行生产, 当前消费者: "</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                        <span class="token comment">// 阻塞消费者者，并释放当前线程的锁</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                            empty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>                    <span class="token comment">// 从缓冲区获取资源</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                    x <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                    <span class="token comment">// 日志打印，业务逻辑尽量放在锁外面，这里只是为了顺序打印到控制台</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者消费产品 "</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">", 当前消费者: "</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                    <span class="token comment">// 唤醒其他所有的消费者与生产者</span></pre></td></tr><tr><td data-num="98"></td><td><pre>                    empty<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 并发，让其他消费者也参与竞争</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                    full<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre>                <span class="token comment">// 防止一瞬间消费完成</span></pre></td></tr><tr><td data-num="105"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="114"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>            <span class="token function">consume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="118"></td><td><pre></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>stdout</strong>：</p>
<pre><code>当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-9
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-11
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-2
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-4
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-6
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-13
产品为空, 等待生产者进行生产, 当前消费者: ForkJoinPool.commonPool-worker-6
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-2
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-6
产品为空, 等待生产者进行生产, 当前消费者: ForkJoinPool.commonPool-worker-4
产品为空, 等待生产者进行生产, 当前消费者: ForkJoinPool.commonPool-worker-13
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-2
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-4
产品为空, 等待生产者进行生产, 当前消费者: ForkJoinPool.commonPool-worker-13
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-9
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-13
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-11
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-6
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-9
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-13
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-9
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-4
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-2
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-4
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-11
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-2
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-6
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-9
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-4
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-9
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-13
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-13
产品为空, 等待生产者进行生产, 当前消费者: ForkJoinPool.commonPool-worker-4
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-2
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-4
产品为空, 等待生产者进行生产, 当前消费者: ForkJoinPool.commonPool-worker-13
当前生产者生产产品 1, 当前生产者: ForkJoinPool.commonPool-worker-11
消费者消费产品 1, 当前消费者: ForkJoinPool.commonPool-worker-13
</code></pre>
<h2 id="总结-3"><a class="anchor" href="#总结-3">#</a> 总结</h2>
<p><code>PV</code>  操作题目的解题思路</p>
<ol>
<li>
<p>关系分析。找出题目中描述的各个进程，分析它们之间的同步</p>
</li>
<li>
<p>整理思路。根据各进程的操作流程确定  <code>P</code> 、 <code>V</code>  操作的大致顺序。</p>
</li>
<li>
<p>设置信号量。设置需要的信号量，并根据题目条件确定信号量初值。</p>
<p>(互斥信号量初值一般为 1，同步信号量的初始值要看对应资源的初始值是多少）</p>
</li>
</ol>
<p>生产者消费者问题是一个互斥、同步的综合问题。</p>
<p>对于初学者来说最难的是发现题目中隐含的两对同步关系。</p>
<p>有时候是消费者需要等待生产者生产，有时候是生产者要等待消费者消费，这是两个不同的 “一前一后问题”，因此也需要设置两个同步信号量。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202200259479.png" alt="image-20230202200259479" /></p>
<p><strong>易错点</strong>：实现互斥和实现同步的两个  <code>P</code>  操作的先后顺序</p>
<ul>
<li>实现互斥的操作要在实现同步的操作之后，否则会产生 &quot;死锁&quot;</li>
</ul>
<h1 id="多生产者-多消费者进程"><a class="anchor" href="#多生产者-多消费者进程">#</a> 多生产者 - 多消费者进程</h1>
<p>桌子上有一只盘子，每次只能向其中放入一个水果。爸爸专向盘子中放苹果，妈妈专向盘子中放橘子，儿子专等着吃盘子中的橘子，女儿专等着吃盘子中的苹果。只有盘子空时，爸爸或妈妈才可向盘子中放一个水果。仅当盘子中有自己需要的水果时，儿子或女儿可以从盘子中取出水果。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202201249516.png" alt="image-20230202201249516" /></p>
<p>生产者生产不同的产品，消费者消费相应的产品</p>
<hr />
<h2 id="问题分析"><a class="anchor" href="#问题分析">#</a> 问题分析</h2>
<p>① 关系分析。找出题目中描述的各个进程，分析它们之间的同步、互斥关系。</p>
<p><strong>互斥关系</strong>:</p>
<ul>
<li>对缓冲区（盘子）的访问要互斥地进行同步关系（一前一后）:</li>
</ul>
<p><strong>同步关系（一前一后）</strong></p>
<ol>
<li>
<p>父亲将苹果放入盘子后，女儿才能取苹果</p>
</li>
<li>
<p>母亲将橘子放入盘子后，儿子才能取橘子</p>
</li>
<li>
<p>只有盘子为空时，父亲或母亲才能放入水果</p>
<ul>
<li>“盘子为空” 这个事件可以由儿子或女儿触发，事件发生后才允许父亲或母亲放水果</li>
</ul>
</li>
</ol>
<p>② 整理思路。根据各进程的操作流程确定  <code>P</code> 、 <code>V</code>  操作的大致顺序。</p>
<p><strong>互斥</strong>：在临界资源前后分别  <code>PV</code></p>
<p><strong>同步</strong>：前  <code>V</code>  后  <code>P</code></p>
<ul>
<li>在前操作后面进行  <code>V</code>  操作</li>
<li>在后操作前面进行  <code>P</code>  操作</li>
</ul>
<p>③ 设置信号量。设置需要的信号量，并根据题目条件确定信号量初值。</p>
<ul>
<li>(互斥信号量初值一般为 1，同步信号量的初始值要看对应资源的初始值是多少)</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202202128592.png" alt="image-20230202202128592" /></p>
<h2 id="具体实现"><a class="anchor" href="#具体实现">#</a> 具体实现</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202202128592.png" alt="image-20230202202128592" /></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202202510021.png" alt="image-20230202202510021" /></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202203401161.png" alt="image-20230202203401161" /></p>
<hr />
<p><strong>问题：可不可以不用互斥信号量？</strong></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202203942261.png" alt="image-20230202203942261" /></p>
<p><strong>分析</strong>：刚开始，儿子、女儿进程即使上处理机运行也会被阻塞。如果刚开始是父亲进程先上处理机运行，则：<br />
父亲  <code>P(plate)</code> ，可以访问盘子 → 母亲  <code>P(plate)</code> ，阻塞等待盘子 → 父亲放入苹果  <code>V(apple)</code> ，女儿进程被唤醒，其他进程即使运行也都会阻塞，暂时不可能访问临界资源（盘子) → 女儿  <code>P(apple)</code>  ，访问盘子， <code>V(plate)</code>  ，等待盘子的母亲进程被唤醒→母亲进程访问盘子（其他进程暂时都无法进入临界区）&gt;...</p>
<p><strong>结论</strong>：即使不设置专门的互斥变量  <code>mutex</code> ，也不会出现多个进程同时访问盘子的现象</p>
<p><strong>原因在于</strong>：</p>
<ul>
<li>
<p>本题中的缓冲区大小为 1，在任何时刻， <code>apple</code> 、 <code>orange</code> 、 <code>plate</code>  三个同步信号量中最多只有一个是 1。</p>
</li>
<li>
<p>因此在任何时刻，最多只有一个进程的 P 操作不会被阻塞，并顺利地进入临界区...</p>
</li>
</ul>
<hr />
<p><strong>若盘子容量设置为 2</strong></p>
<p>父亲  <code>P(plate)</code> ，可以访问盘子 → 母亲  <code>P(plate)</code> ，可以访问盘子 → 父亲在往盘子里放苹果，同时母亲也可以往盘子里放橘子。</p>
<ul>
<li>于是就出现了两个进程<strong>同时访问缓冲区</strong>的情况，有可能导致两个进程写入缓冲区的<strong>数据相互覆盖</strong>的情况。</li>
</ul>
<hr />
<p>因此，如果缓冲区大小大于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，就必须专门设置一个互斥信号量  <code>mutex</code>  来保证互斥访问缓冲区。</p>
<h2 id="java-案例-2"><a class="anchor" href="#java-案例-2">#</a> Java 案例</h2>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Deque</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">LinkedList</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Condition</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantLock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">ProducerConsumerByLock</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 互斥资源</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> queueApple <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> queueOrange <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> maxSize <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Condition</span> apple <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Condition</span> orange <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Condition</span> plate <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Dad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Mom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Daughter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">//CompletableFuture.runAsync (new Consumer ()); 产生的进程默认是守护进程</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Dad</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token comment">// 放入苹果</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>queueApple<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> maxSize <span class="token operator">||</span> queueOrange<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> maxSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"盘子不为空, 父亲阻塞"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                            plate<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                    <span class="token comment">// 放入苹果</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                    queueApple<span class="token punctuation">.</span><span class="token function">offerLast</span><span class="token punctuation">(</span><span class="token string">"apple"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"父亲放入了 1 个苹果"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                    <span class="token comment">// 通知苹果的所有消费者</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                    apple<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Mom</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token comment">// 放入橘子</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>queueOrange<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> maxSize <span class="token operator">||</span> queueApple<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> maxSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"盘子不为空, 母亲阻塞"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                            plate<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                    <span class="token comment">// 放入橘子</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                    queueOrange<span class="token punctuation">.</span><span class="token function">offerLast</span><span class="token punctuation">(</span><span class="token string">"orange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"母亲放入了 1 个橘子"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                    <span class="token comment">// 通知橘子的所有消费者</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                    orange<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="100"></td><td><pre></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="102"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>            <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Son</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token comment">// 获取橘子</span></pre></td></tr><tr><td data-num="111"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>                <span class="token class-name">String</span> v <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>queueOrange<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"盘子为空或者没有橘子，儿子阻塞"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>                            orange<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>                    <span class="token comment">// 获取橘子</span></pre></td></tr><tr><td data-num="125"></td><td><pre>                    v <span class="token operator">=</span> queueOrange<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"儿子吃了一个橘子: "</span> <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>                    <span class="token comment">// 通知所有生产者，父亲和母亲</span></pre></td></tr><tr><td data-num="128"></td><td><pre>                    plate<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>                <span class="token comment">// 防止一瞬间消费完成</span></pre></td></tr><tr><td data-num="133"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="140"></td><td><pre></pre></td></tr><tr><td data-num="141"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="142"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>            <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="146"></td><td><pre></pre></td></tr><tr><td data-num="147"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Daughter</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="148"></td><td><pre></pre></td></tr><tr><td data-num="149"></td><td><pre>        <span class="token comment">// 获取苹果</span></pre></td></tr><tr><td data-num="150"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>            <span class="token class-name">String</span> v <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>queueApple<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"盘子为空或者没有苹果，女儿阻塞"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="157"></td><td><pre>                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="158"></td><td><pre>                            apple<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="159"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>                    <span class="token comment">// 获取橘子</span></pre></td></tr><tr><td data-num="164"></td><td><pre>                    v <span class="token operator">=</span> queueApple<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"女儿吃了一个苹果: "</span> <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>                    <span class="token comment">// 通知所有生产者，父亲和母亲</span></pre></td></tr><tr><td data-num="167"></td><td><pre>                    plate<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>                <span class="token comment">// 防止一瞬间消费完成</span></pre></td></tr><tr><td data-num="172"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="173"></td><td><pre>                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="174"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="176"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="177"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="178"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="179"></td><td><pre></pre></td></tr><tr><td data-num="180"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="181"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="182"></td><td><pre>            <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="183"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="185"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>stdout：</strong></p>
<pre><code>父亲放入了 1 个苹果
盘子不为空, 母亲阻塞
女儿吃了一个苹果: apple
母亲放入了 1 个橘子
儿子吃了一个橘子: orange
父亲放入了 1 个苹果
盘子为空或者没有橘子，儿子阻塞
女儿吃了一个苹果: apple
母亲放入了 1 个橘子
儿子吃了一个橘子: orange
盘子为空或者没有橘子，儿子阻塞
盘子为空或者没有苹果，女儿阻塞
父亲放入了 1 个苹果
女儿吃了一个苹果: apple
母亲放入了 1 个橘子
儿子吃了一个橘子: orange
母亲放入了 1 个橘子
盘子不为空, 父亲阻塞
儿子吃了一个橘子: orange
父亲放入了 1 个苹果
女儿吃了一个苹果: apple
盘子为空或者没有橘子，儿子阻塞
母亲放入了 1 个橘子
儿子吃了一个橘子: orange
盘子为空或者没有苹果，女儿阻塞
</code></pre>
<h2 id="总结-4"><a class="anchor" href="#总结-4">#</a> 总结</h2>
<p><strong>总结</strong>：在生产者 - 消费者问题中，如果缓冲区大小为 1 ，那么有可能不需要设置互斥信号量就可以实现互斥访问缓冲区的功能。</p>
<ul>
<li>当然，这不是绝对的，要具体问题具体分析。</li>
</ul>
<p><strong>建议</strong>：在考试中如果来不及仔细分析，可以加上互斥信号量，保证各进程一定会互斥地访问缓冲区。</p>
<ul>
<li>但需要注意的是，实现互斥的 P 操作一定要在实现同步的  <code>P</code>  操作之后，否则可能引起 “死锁” 。</li>
</ul>
<hr />
<p>解决 “多生产者 - 多消费者问题” 的关键在于理清复杂的同步关系。</p>
<p>在分析同步问题（一前一后问题）的时候不能从单个进程行为的角度来分析，要把 “一前一后” 发生的事看做是两种 “事件” 的前后关系。</p>
<p>比如，如果从单个进程行为的角度来考虑的话，我们会有以下结论:</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>如果盘子里装有苹果，那么一定要女儿取走苹果后父亲或母亲才能再放入水果</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}如果盘子里装有苹果，那么一定要女儿取走苹果后父亲或母亲才能再放入水果</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">如果盘子里装有苹果，那么一定要女儿取走苹果后父亲或母亲才能再放入水果</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>如果盘子里装有橘子，那么一定要儿子取走橘子后父亲或母亲才能再放入水果</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}如果盘子里装有橘子，那么一定要儿子取走橘子后父亲或母亲才能再放入水果</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">如果盘子里装有橘子，那么一定要儿子取走橘子后父亲或母亲才能再放入水果</span></span></span></span></li>
<li>这么看是否就意味着要设置四个同步信号量分别实现这四个 “一前一后” 的关系了？</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202205304014.png" alt="image-20230202205304014" /></p>
<p>正确的分析方法应该从 “<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>事件</mtext></mstyle></mrow><annotation encoding="application/x-tex">\textcolor{red}{事件}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">事件</span></span></span></span>” 的角度来考虑</p>
<ul>
<li>我们可以把上述四对 “进程行为的前后关系” 抽象为一对 “<strong>事件的前后关系</strong>”</li>
<li><strong>盘子变空事件 → 放入水果事件</strong>。“盘子变空事件” 既可由儿子引发，也可由女儿引发；“放水果事件”&quot; 既可能是父亲执行，也可能是母亲执行。这样的话，就可以用一个同步信号量解决问题了</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202205319716.png" alt="image-20230202205319716" /></p>
<h1 id="吸烟者问题"><a class="anchor" href="#吸烟者问题">#</a> 吸烟者问题</h1>
<p>假设一个系统有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>三个抽烟者进程和一个供应者进程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}三个抽烟者进程和一个供应者进程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">三个抽烟者进程和一个供应者进程</span></span></span></span>。</p>
<p>每个抽烟者不停地卷烟并抽掉它，但是要卷起并抽掉一支烟，抽烟者需要有三种材料：烟草、纸和胶水。三个抽烟者中，<strong>第一个拥有烟草、第二个拥有纸、第三个拥有胶水</strong>。供应者进程无限地提供三种材料，供应者每次将两种材料放桌子上，<strong>拥有剩下那种材料的抽烟者卷一根烟并抽掉它，并给供应者进程一个信号告诉完成了</strong>，供应者就会放另外两种材料再桌上，这个过程一直重复（<strong>让三个抽烟者轮流地抽烟</strong>)</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/smoking.gif" alt="smoking" /></p>
<hr />
<h2 id="问题分析-2"><a class="anchor" href="#问题分析-2">#</a> 问题分析</h2>
<p>本质上这题也属于 “生产者 - 消费者” 问题，更详细的说应该是 “可生产多种产品的单生产者 - 多消费者”。</p>
<p>① 关系分析。找出题目中描述的各个进程，分析它们之间的同步、互斥关系。</p>
<p>桌子可以抽象为容量为 1 的缓冲区，要互斥访问</p>
<ul>
<li>组合一：纸 + 胶水</li>
<li>组合二：烟草 + 胶水</li>
<li>组合三：烟草 + 纸</li>
</ul>
<p>同步关系（从事件的角度来分析）:</p>
<ul>
<li>
<p>桌上有组合一：第一个抽烟者取走东西</p>
</li>
<li>
<p>桌上有组合二：第二个抽烟者取走东西</p>
</li>
<li>
<p>桌上有组合三：第三个抽烟者取走东西</p>
</li>
<li>
<p>发出完成信号：供应者将下一个组合放到桌上</p>
</li>
</ul>
<p>② 整理思路。根据各进程的操作流程确定  <code>P</code> 、 <code>V</code>  操作的大致顺序</p>
<ul>
<li>同步关系：前  <code>V</code>  后  <code>P</code></li>
</ul>
<p>③ 设置信号量。设置需要的信号量，并根据题目条件确定信号量初值。</p>
<ul>
<li>(互斥信号量初值一般为 1，同步信号量的初始值要看对应资源的初始值是多少)</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202225729675.png" alt="image-20230202225729675" /></p>
<hr />
<h2 id="具体实现-2"><a class="anchor" href="#具体实现-2">#</a> 具体实现</h2>
<p>由于互斥资源只有一个，所以上述案例可以不需要互斥量</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230202230639098.png" alt="image-20230202230639098" /></p>
<p>上述所示，若  <code>P(finish)</code>  放在  <code>if</code>  前面，则需要设置  <code>finish</code>  初值为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，否则会产生死锁</p>
<ul>
<li>放在  <code>if</code>  前面就跟之前案例中的盘子互斥资源一样了</li>
</ul>
<p>缓冲区大小为 1，同一时刻，四个同步信号量中至多有一个的值为 1</p>
<h2 id="java-案例-3"><a class="anchor" href="#java-案例-3">#</a> Java 案例</h2>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Condition</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantLock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">ProducerConsumerByLock</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 互斥资源，由于直接在修改 i 的时候加锁了，所以不需要设置为原子类</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 最大容量</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> capacity <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 产品个数</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">//flag</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Condition</span> offer1 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Condition</span> offer2 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Condition</span> offer3 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Condition</span> finish <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// 三个吸烟者</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Smokers</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 一个生产者</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">//CompletableFuture.runAsync (new Consumer ()); 产生的进程默认是守护进程</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">// 生产者</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>capacity <span class="token operator">==</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"产品 "</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">" 还没有被消费,阻塞"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                        finish<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                    count<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                    <span class="token comment">// 根据 i 的值不同唤醒不同的进程</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                    <span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                            offer1<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                            offer2<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                            offer3<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                        <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                    i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">3</span> <span class="token operator">:</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"生产当前一个产品: "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>            <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token comment">// 吸烟者</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token annotation punctuation">@AllArgsConstructor</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Smokers</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token keyword">private</span> <span class="token keyword">int</span> number<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">smoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                    <span class="token comment">// 如果当前吸烟者对应的材料不同，阻塞</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">!=</span> number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"吸烟者"</span> <span class="token operator">+</span> number <span class="token operator">+</span> <span class="token string">"阻塞, 材料为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"吸烟者"</span> <span class="token operator">+</span> number <span class="token operator">+</span> <span class="token string">"阻塞, 当前材料: "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>                        <span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>                            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="104"></td><td><pre>                                offer1<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>                                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>                            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="107"></td><td><pre>                                offer2<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>                                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>                            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="110"></td><td><pre>                                offer3<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>                                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>                            <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="113"></td><td><pre>                                <span class="token comment">// 刚开始默认全部阻塞</span></pre></td></tr><tr><td data-num="114"></td><td><pre>                                <span class="token keyword">switch</span> <span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>                                    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="116"></td><td><pre>                                        offer1<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>                                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>                                    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="119"></td><td><pre>                                        offer2<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>                                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>                                    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="122"></td><td><pre>                                        offer3<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>                                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>                                    <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="125"></td><td><pre>                                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>                    count<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>                    <span class="token comment">// 进行吸烟</span></pre></td></tr><tr><td data-num="130"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"吸烟者"</span> <span class="token operator">+</span> number <span class="token operator">+</span> <span class="token string">"吸烟 "</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">", 吸烟完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>                    <span class="token comment">// 唤醒生产者进行生产下一个吸烟者</span></pre></td></tr><tr><td data-num="132"></td><td><pre>                    finish<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="138"></td><td><pre></pre></td></tr><tr><td data-num="139"></td><td><pre>                <span class="token comment">// 防止一瞬间消费完成</span></pre></td></tr><tr><td data-num="140"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="147"></td><td><pre></pre></td></tr><tr><td data-num="148"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="149"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>            <span class="token function">smoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="153"></td><td><pre></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>stdout:</strong></p>
<pre><code>吸烟者1阻塞, 材料为空
吸烟者2阻塞, 材料为空
吸烟者3阻塞, 材料为空
生产当前一个产品: 2
吸烟者1阻塞, 当前材料: 2
吸烟者2吸烟 2, 吸烟完成
吸烟者3阻塞, 材料为空
生产当前一个产品: 3
吸烟者1阻塞, 当前材料: 3
吸烟者3吸烟 3, 吸烟完成
吸烟者2阻塞, 材料为空
吸烟者3阻塞, 材料为空
生产当前一个产品: 1
吸烟者1吸烟 1, 吸烟完成
吸烟者2阻塞, 材料为空
吸烟者3阻塞, 材料为空
生产当前一个产品: 2
吸烟者2吸烟 2, 吸烟完成
吸烟者3阻塞, 材料为空
吸烟者2阻塞, 材料为空
生产当前一个产品: 3
吸烟者3吸烟 3, 吸烟完成
吸烟者2阻塞, 材料为空
吸烟者1阻塞, 材料为空
生产当前一个产品: 1
吸烟者2阻塞, 当前材料: 1
吸烟者1吸烟 1, 吸烟完成
吸烟者3阻塞, 材料为空
生产当前一个产品: 2
吸烟者2吸烟 2, 吸烟完成
吸烟者3阻塞, 材料为空
生产当前一个产品: 3
吸烟者3吸烟 3, 吸烟完成
生产当前一个产品: 1
吸烟者1吸烟 1, 吸烟完成
吸烟者3阻塞, 材料为空
吸烟者2阻塞, 材料为空
吸烟者1阻塞, 材料为空
生产当前一个产品: 2
吸烟者3阻塞, 当前材料: 2
吸烟者2吸烟 2, 吸烟完成
吸烟者1阻塞, 材料为空
生产当前一个产品: 3
吸烟者3吸烟 3, 吸烟完成
吸烟者1阻塞, 材料为空
吸烟者2阻塞, 材料为空
生产当前一个产品: 1
吸烟者1吸烟 1, 吸烟完成
吸烟者2阻塞, 材料为空
吸烟者3阻塞, 材料为空
生产当前一个产品: 2
吸烟者2吸烟 2, 吸烟完成
吸烟者3阻塞, 材料为空
吸烟者2阻塞, 材料为空
生产当前一个产品: 3
吸烟者3吸烟 3, 吸烟完成
吸烟者2阻塞, 材料为空
吸烟者1阻塞, 材料为空
吸烟者3阻塞, 材料为空
生产当前一个产品: 1
吸烟者2阻塞, 当前材料: 1
吸烟者1吸烟 1, 吸烟完成
吸烟者3阻塞, 材料为空
吸烟者1阻塞, 材料为空
生产当前一个产品: 2
吸烟者2吸烟 2, 吸烟完成
吸烟者3阻塞, 材料为空
吸烟者1阻塞, 材料为空
生产当前一个产品: 3
吸烟者3吸烟 3, 吸烟完成
吸烟者1阻塞, 材料为空
吸烟者2阻塞, 材料为空
生产当前一个产品: 1
吸烟者1吸烟 1, 吸烟完成
吸烟者2阻塞, 材料为空
吸烟者3阻塞, 材料为空
吸烟者1阻塞, 材料为空
生产当前一个产品: 2
吸烟者2吸烟 2, 吸烟完成
吸烟者3阻塞, 材料为空
吸烟者1阻塞, 材料为空
</code></pre>
<hr />
<h2 id="总结-5"><a class="anchor" href="#总结-5">#</a> 总结</h2>
<p>吸烟者问题可以为我们解决 “可以生产多个产品的单生产者” 问题提供一个思路。</p>
<p>值得吸取的精华是：“轮流让各个吸烟者吸烟” 必然需要 “轮流的在桌上放上组合一、二、三”，注意体会我们是如何用一个整型变量 i 实现这个 “轮流” 过程的。</p>
<p>如果题目改为 “每次随机地让一个吸烟者吸烟”，我们有应该如何用代码写出这个逻辑呢？</p>
<ul>
<li><code>random</code>  变量即可</li>
</ul>
<hr />
<p>若一个生产者要生产多种产品（或者说会引发多种前驱事件），那么各个  <code>V</code>  操作应该放在各自对应的 “<strong>前驱事件</strong>” 发生之后的位置。</p>
<h1 id="读者-写者问题"><a class="anchor" href="#读者-写者问题">#</a> 读者 - 写者问题</h1>
<p>有读者和写者两组并发进程，共享一个文件，当两个或两个以上的读进程同时访问共享数据时不会产生副作用，</p>
<ul>
<li>但若某个写进程和其他进程（读进程或写进程）同时访问共享数据时则可能导致数据不一致的错误。</li>
</ul>
<p>因此要求:</p>
<ul>
<li>①允许多个读者可以同时对文件执行读操作；</li>
<li>②只允许一个写者往文件中写信息；</li>
<li>③任一写者在完成写操作之前不允许其他读者或写者工作；</li>
<li>④写者执行写操作前，应让已有的读者和写者全部退出。</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230203211117170.png" alt="image-20230203211117170" /></p>
<h2 id="问题分析-3"><a class="anchor" href="#问题分析-3">#</a> 问题分析</h2>
<p>两类进程：写进程、读进程</p>
<p>互斥关系：写进程一写进程、写进程一读进程。读进程与读进程不存在互斥问题。</p>
<p>写者进程和任何进程都互斥，设置一个互斥信号量  <code>rw</code> ，在写者访问共享文件前后分别执行  <code>P</code> 、 <code>V</code>  操作。</p>
<p>读者进程和写者进程也要互斥，因此读者访问共享文件前后也要对  <code>rw</code>  执行  <code>P</code> 、 <code>V</code>  操作。</p>
<p>如果所有读者进程在访问共享文件之前都执行  <code>P(rw)</code>  操作，那么会导致各个读进程之间也无法同时访问文件。</p>
<hr />
<p><strong>Key</strong>：读者写者问题的核心思想――怎么处理该问题呢？</p>
<p><code>P(rw)</code>  和  <code>V(rw)</code>  其实就是对共享文件的 “加锁” 和 “解锁”。既然各个读进程需要同时访问，而读进程与写进程又必须互斥访问，那么我们可以让第一个访问文件的读进程 “加锁”，让最后一个访问完文件的读进程 “解锁”。</p>
<p>可以设置一个整数变量  <code>count</code>  来记录当前有几个读进程在访问文件。</p>
<h2 id="具体实现-3"><a class="anchor" href="#具体实现-3">#</a> 具体实现</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230203212211954.png" alt="image-20230203212211954" /></p>
<p>潜在的问题：只要有读进程还在读，写进程就要一直阻塞等待，可能 “饿死”。</p>
<ul>
<li>因此，这种算法中，读进程是优先的</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230203233530865.png" alt="image-20230203233530865" /></p>
<h2 id="总结-6"><a class="anchor" href="#总结-6">#</a> 总结</h2>
<p>读者 - 写者问题为我们解决复杂的互斥问题提供了一个参考思路。</p>
<p>其<strong>核心思想</strong>在于设置了一个计数器  <code>count</code>  用来记录当前正在访问共享文件的读进程数。我们可以用  <code>count</code>  的值来判断当前进入的进程是否是第一个 / 最后一个读进程，从而做出不同的处理。</p>
<p>另外，对  <code>count</code>  变量的检查和赋值不能一气呵成导致了一些错误，</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>如果需要实现一气呵成，自然应该想到用互斥信号量</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}如果需要实现一气呵成，自然应该想到用互斥信号量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">如果需要实现一气呵成，自然应该想到用互斥信号量</span></span></span></span></li>
</ul>
<p>最后，还要认真体会我们是如何解决 “写进程饥饿” 问题的。</p>
<p>绝大多数的考研  <code>PV</code>  操作大题都可以用之前介绍的几种生产者 - 消费者问题的思想来解决，如果遇到更复杂的问题，可以想想能否用读者写者问题的这几个思想来解决。</p>
<h1 id="哲学家进餐问题"><a class="anchor" href="#哲学家进餐问题">#</a> 哲学家进餐问题</h1>
<p>一张圆桌上坐着 5 名哲学家，每两个哲学家之间的桌上摆一根筷子，桌子的中间是一碗米饭。</p>
<p>哲学家们倾注毕生的精力用于思考和进餐，哲学家在思考时，并不影响他人。</p>
<p>只有当哲学家饥饿时，才试图拿起左、右两根筷子（一根一根地拿起)。如果筷子已在他人手上，则需等待。</p>
<p>饥饿的哲学家只有同时拿起两根筷子才可以开始进餐，当进餐完毕后，放下筷子继续思考。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230204003023792.png" alt="image-20230204003023792" /></p>
<h2 id="问题分析-4"><a class="anchor" href="#问题分析-4">#</a> 问题分析</h2>
<ol>
<li>
<p>关系分析。系统中有 5 个哲学家进程，5 位哲学家与左右邻居对其中间筷子的访问是互斥关系。</p>
</li>
<li>
<p>整理思路。这个问题中只有互斥关系，但与之前遇到的问题不同的事，每个哲学家进程需要<strong>同时持有两个临界资源</strong>才能开始吃饭。如何避免临界资源分配不当造成的<strong>死锁现象</strong>，是哲学家问题的精髓。</p>
</li>
<li>
<p>信号量设置。定义互斥信号量数组  <code>chopstick[5]=&#123;1,1,1,1,1&#125;</code>  用于实现对 5 个筷子的互斥访问。</p>
<p>并对哲学家按 0~4 编号，哲学家 i 左边的筷子编号为  <code>i</code>  ，右边的筷子编号为  <code>(i+1)%5</code> 。</p>
</li>
</ol>
<p><strong>错误</strong></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230204003436560.png" alt="image-20230204003436560" /></p>
<p><strong>循环的等待</strong></p>
<hr />
<h2 id="如何避免死锁的发生呢附-java-实现"><a class="anchor" href="#如何避免死锁的发生呢附-java-实现">#</a> 如何避免死锁的发生呢？（附 Java 实现）</h2>
<p>① 可以对哲学家进程施加一些限制条件，比如最多允许四个哲学家同时进餐。（<strong>破坏循环等待条件</strong>，本来 5 个哲学家对应 5 个筷子，现在 4 个哲学家对应 5 个筷子）</p>
<p>这样可以保证至少有一个哲学家是可以拿到左右两只筷子的</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230204003718420.png" alt="image-20230204003718420" /></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>semaphore chopstick <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>semaphore mutex <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// 只允许 4 个哲学家进行争抢</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">pi</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function">P</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token function">P</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 拿左</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token function">P</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 拿右</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">V</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//V 顺序无所谓</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        吃饭<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">V</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 放左</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token function">V</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 放右</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        思考<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Java 实现</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * 最多允许四个哲学家同时进餐</pre></td></tr><tr><td data-num="3"></td><td><pre> */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">DiningPhilosophers</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">DiningPhilosophers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">Lock</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chopstick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token class-name">Semaphore</span> mutex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// call the run() method of any runnable to execute its code</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wantsToEat</span><span class="token punctuation">(</span><span class="token keyword">int</span> philosopher<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                           <span class="token class-name">Runnable</span> pickLeftFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                           <span class="token class-name">Runnable</span> pickRightFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                           <span class="token class-name">Runnable</span> eat<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                           <span class="token class-name">Runnable</span> putLeftFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                           <span class="token class-name">Runnable</span> putRightFork<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 信号量 -1</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        mutex<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 拿起左右筷子</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        chopstick<span class="token punctuation">[</span>philosopher<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>philosopher <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        pickLeftFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        pickRightFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">//eat</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        eat<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token comment">// 放下左右筷子</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        putLeftFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        putRightFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        chopstick<span class="token punctuation">[</span>philosopher<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>philosopher <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// 信号量 + 1</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        mutex<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>② 要求<strong>奇数号</strong>哲学家<strong>先拿左边</strong>的筷子，然后<strong>再拿右边</strong>的筷子，而偶数号哲学家刚好相反。（<strong>破坏循环等待</strong>，分为奇偶数，给上编号）</p>
<p>用这种方法可以保证如果相邻的两个奇偶号哲学家都想吃饭，那么只会有其中一个可以拿起第一只筷子，另一个会直接阻塞。这就避免了占有一支后再等待另一只的情况。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>semaphore chopstick <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>semaphore mutex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 互斥地取筷子</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">pi</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function">P</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">// 偶数</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	        <span class="token function">P</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 拿右   </span></pre></td></tr><tr><td data-num="9"></td><td><pre>	        <span class="token function">P</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 拿左</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token function">P</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 拿左</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	        <span class="token function">P</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 拿右   </span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function">V</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//V 顺序无所谓</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        吃饭<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token function">V</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 放左</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token function">V</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 放右</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        思考<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230204004009243.png" alt="image-20230204004009243" /></p>
<p>Java 实现</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * 奇数号哲学家先左后右，偶数号哲学家先右后左</pre></td></tr><tr><td data-num="3"></td><td><pre> */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">DiningPhilosophers</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">DiningPhilosophers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">Lock</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chopstick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// call the run() method of any runnable to execute its code</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wantsToEat</span><span class="token punctuation">(</span><span class="token keyword">int</span> philosopher<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                           <span class="token class-name">Runnable</span> pickLeftFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                           <span class="token class-name">Runnable</span> pickRightFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                           <span class="token class-name">Runnable</span> eat<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                           <span class="token class-name">Runnable</span> putLeftFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                           <span class="token class-name">Runnable</span> putRightFork<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// 尝试拿起左右筷子</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>philosopher <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            chopstick<span class="token punctuation">[</span>philosopher<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>philosopher <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>philosopher <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            chopstick<span class="token punctuation">[</span>philosopher<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>        pickLeftFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        pickRightFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">//eat</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        eat<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        putLeftFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        putRightFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// 放下左右筷子</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        chopstick<span class="token punctuation">[</span>philosopher<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>philosopher <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>③ 仅当一个哲学家左右两支筷子都可用时才允许他抓起筷子。（<strong>破坏请求和保持条件</strong>，预先分配 2 个筷子）</p>
<p>如下所示：</p>
<ol>
<li>
<p>若 0 号哲学家正在  <code>P(chopstick[i])</code>  中，此时 2 号哲学家也想拿筷子，将会阻塞在  <code>P(mutex)</code>  ，直到等待 0 号哲学家  <code>V(mutex)</code></p>
</li>
<li>
<p>若 0 号哲学家正在吃饭，0, 1 号筷子被使用；此时 1 号哲学家将会阻塞  <code>P(chopstick[i])</code> ;（0 号筷子），  <code>mutex = 0</code> ; 若 2 号哲学家也想拿筷子，则会被阻塞到  <code>P(mutex)</code></p>
<ul>
<li>即使 2 号左右两边的筷子都在，也暂时无法取得</li>
</ul>
</li>
<li>
<p>若 0 号哲学家正在吃饭，0, 1 号筷子被使用；此时 4 号哲学家将拿起左边筷子，但是阻塞在  <code>P(chopstick[(i + 1) % 5])</code>  ，直到等待 0 号哲学家吃完饭  <code>V(chopstick[i]);</code></p>
<ul>
<li>此时 4 号右边的筷子不可用，但 4 号仍然会拿起左边的筷子</li>
</ul>
</li>
</ol>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>semaphore chopstick <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>semaphore mutex <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 互斥地取筷子</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">Pi</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>				<span class="token comment">//i 号哲学家的进程</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function">P</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token function">P</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 拿左</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token function">P</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 拿右</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">V</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        吃饭<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">V</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 放左</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token function">V</span><span class="token punctuation">(</span>chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 放右</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        思考<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span>	</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>因此上述方法并不能保证只有两边的筷子都可用时，才允许哲学家拿起筷子</p>
<ul>
<li>例如上述的情况 1 和 2 都会导致 2 号哲学家两边的筷子都可以用，但是却被阻塞</li>
</ul>
<p><strong>更准确的说法应该是</strong>：</p>
<ul>
<li>
<p>各哲学家拿筷子这件事必须互斥的执行。</p>
<p>这就保证了即使一个哲学家在拿筷子拿到一半时被阻塞，也不会有别的哲学家会继续尝试拿筷子。</p>
<p>这样的话，当前正在吃饭的哲学家放下筷子后，被阻塞的哲学家就可以获得等待的筷子了。</p>
</li>
</ul>
<p>Java 实现</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">DiningPhilosophers</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">DiningPhilosophers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">Lock</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chopstick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">Lock</span> mutex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// call the run() method of any runnable to execute its code</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wantsToEat</span><span class="token punctuation">(</span><span class="token keyword">int</span> philosopher<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                           <span class="token class-name">Runnable</span> pickLeftFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                           <span class="token class-name">Runnable</span> pickRightFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                           <span class="token class-name">Runnable</span> eat<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                           <span class="token class-name">Runnable</span> putLeftFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                           <span class="token class-name">Runnable</span> putRightFork<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 由于要同时持有，所以要互斥</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        chopstick<span class="token punctuation">[</span>philosopher<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>philosopher <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>        pickLeftFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        pickRightFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">//eat</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        eat<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        putLeftFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        putRightFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// 放下左右筷子</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        chopstick<span class="token punctuation">[</span>philosopher<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        chopstick<span class="token punctuation">[</span><span class="token punctuation">(</span>philosopher <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><hr />
<h2 id="位运算-cas-优化"><a class="anchor" href="#位运算-cas-优化">#</a> 位运算 + CAS 优化</h2>
<p>方式① 最多允许四个哲学家同时进餐</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * 最多允许四个哲学家同时进餐</pre></td></tr><tr><td data-num="3"></td><td><pre> */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">DiningPhilosophers</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">DiningPhilosophers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 若 chopstick 等于 0, 表示筷子未被使用</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">AtomicInteger</span> chopstick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 00001, 00010, 00100, 01000, 10000</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chopstickMask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">Semaphore</span> mutex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// call the run() method of any runnable to execute its code</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wantsToEat</span><span class="token punctuation">(</span><span class="token keyword">int</span> philosopher<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                           <span class="token class-name">Runnable</span> pickLeftFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                           <span class="token class-name">Runnable</span> pickRightFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                           <span class="token class-name">Runnable</span> eat<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                           <span class="token class-name">Runnable</span> putLeftFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                           <span class="token class-name">Runnable</span> putRightFork<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 左右筷子</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">int</span> leftC <span class="token operator">=</span> chopstickMask<span class="token punctuation">[</span>philosopher<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">int</span> rightC <span class="token operator">=</span> chopstickMask<span class="token punctuation">[</span><span class="token punctuation">(</span>philosopher <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// 信号量 -1</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        mutex<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 尝试拿起左右筷子</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">//CAS</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">get</span><span class="token punctuation">(</span>leftC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">get</span><span class="token punctuation">(</span>rightC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        pickLeftFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        pickRightFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token comment">//eat</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        eat<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        putLeftFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        putRightFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">// 放下左右筷子</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">put</span><span class="token punctuation">(</span>leftC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">put</span><span class="token punctuation">(</span>rightC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token comment">// 信号量 + 1</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        mutex<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">int</span> expect <span class="token operator">=</span> chopstick<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">// 例如：1 号放下筷子 00001 和 00010</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token comment">// 左边的筷子 expect : 00011 ^ 00001 -> 00010</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token comment">// 右边的筷子 expect : 00010 ^ 00010 -> 00000</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token keyword">return</span> chopstick<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>expect<span class="token punctuation">,</span> expect <span class="token operator">^</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">// 尝试拿起左右筷子</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">int</span> expect <span class="token operator">=</span> chopstick<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token comment">// 只有当前筷子没有被拿起才返回 true, 并且更新筷子状态</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token comment">// 例如：1 号拿起筷子 00001 和 00010 , 更新后 : 00011 (说明 1, 2 号筷子被拿了)</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token comment">//  此时 2 号想拿起左边的筷子 : 00010 , &amp; 运算发现被拿了，返回 false</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span>expect <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> chopstick<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>expect<span class="token punctuation">,</span> expect <span class="token operator">^</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>方式② 奇数号哲学家先左后右，偶数号哲学家先右后左</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Semaphore</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Condition</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantLock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="8"></td><td><pre> * 奇数号哲学家先左后右，偶数号哲学家先右后左</pre></td></tr><tr><td data-num="9"></td><td><pre> */</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">DiningPhilosophers</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">DiningPhilosophers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 若 chopstick 等于 0, 表示筷子未被使用</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">AtomicInteger</span> chopstick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 00001, 00010, 00100, 01000, 10000</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chopstickMask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// call the run() method of any runnable to execute its code</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wantsToEat</span><span class="token punctuation">(</span><span class="token keyword">int</span> philosopher<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                           <span class="token class-name">Runnable</span> pickLeftFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                           <span class="token class-name">Runnable</span> pickRightFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                           <span class="token class-name">Runnable</span> eat<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                           <span class="token class-name">Runnable</span> putLeftFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                           <span class="token class-name">Runnable</span> putRightFork<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// 左右筷子</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">int</span> leftC <span class="token operator">=</span> chopstickMask<span class="token punctuation">[</span>philosopher<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">int</span> rightC <span class="token operator">=</span> chopstickMask<span class="token punctuation">[</span><span class="token punctuation">(</span>philosopher <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">// 信号量 -1</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>philosopher <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token comment">// 尝试拿起左右筷子</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">get</span><span class="token punctuation">(</span>leftC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">get</span><span class="token punctuation">(</span>rightC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token comment">// 尝试拿起右左筷子</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">get</span><span class="token punctuation">(</span>rightC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">get</span><span class="token punctuation">(</span>leftC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token comment">// 退出临界区</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>        pickLeftFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        pickRightFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">//eat</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        eat<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        putLeftFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        putRightFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token comment">// 放下左右筷子</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">put</span><span class="token punctuation">(</span>leftC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">put</span><span class="token punctuation">(</span>rightC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token comment">// 信号量 + 1</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token keyword">int</span> expect <span class="token operator">=</span> chopstick<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token comment">// 例如：1 号放下筷子 00001 和 00010</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token comment">// 左边的筷子 expect : 00011 ^ 00001 -> 00010</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token comment">// 右边的筷子 expect : 00010 ^ 00010 -> 00000</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token keyword">return</span> chopstick<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>expect<span class="token punctuation">,</span> expect <span class="token operator">^</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">// 尝试拿起左右筷子</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token keyword">int</span> expect <span class="token operator">=</span> chopstick<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token comment">// 只有当前筷子没有被拿起才返回 true, 并且更新筷子状态</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token comment">// 例如：1 号拿起筷子 00001 和 00010 , 更新后 : 00011 (说明 1, 2 号筷子被拿了)</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token comment">//  此时 2 号想拿起左边的筷子 : 00010 , &amp; 运算发现被拿了，返回 false</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span>expect <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> chopstick<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>expect<span class="token punctuation">,</span> expect <span class="token operator">^</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>方式③ 仅当一个哲学家左右两支筷子都可用时才允许他抓起筷子。</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Semaphore</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Condition</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantLock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="8"></td><td><pre> * 仅当一个哲学家左右两支筷子都可用时才允许他抓起筷子。</pre></td></tr><tr><td data-num="9"></td><td><pre> */</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">DiningPhilosophers</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">DiningPhilosophers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 若 chopstick 等于 0, 表示筷子未被使用</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">AtomicInteger</span> chopstick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 00001, 00010, 00100, 01000, 10000</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chopstickMask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 进入临界区</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token class-name">AtomicInteger</span> mutex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// call the run() method of any runnable to execute its code</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wantsToEat</span><span class="token punctuation">(</span><span class="token keyword">int</span> philosopher<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                           <span class="token class-name">Runnable</span> pickLeftFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                           <span class="token class-name">Runnable</span> pickRightFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                           <span class="token class-name">Runnable</span> eat<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                           <span class="token class-name">Runnable</span> putLeftFork<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                           <span class="token class-name">Runnable</span> putRightFork<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">// 左右筷子</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">int</span> leftC <span class="token operator">=</span> chopstickMask<span class="token punctuation">[</span>philosopher<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">int</span> rightC <span class="token operator">=</span> chopstickMask<span class="token punctuation">[</span><span class="token punctuation">(</span>philosopher <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// 信号量 -1</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token comment">// 进入临界区</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>mutex<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token comment">// 尝试拿起左右筷子</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">get</span><span class="token punctuation">(</span>leftC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">get</span><span class="token punctuation">(</span>rightC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token comment">// 退出临界区</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>mutex<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>        pickLeftFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        pickRightFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token comment">//eat</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        eat<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        putLeftFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        putRightFork<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token comment">// 放下左右筷子</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">put</span><span class="token punctuation">(</span>leftC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">put</span><span class="token punctuation">(</span>rightC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token comment">// 信号量 + 1</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">int</span> expect <span class="token operator">=</span> chopstick<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token comment">// 例如：1 号放下筷子 00001 和 00010</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token comment">// 左边的筷子 expect : 00011 ^ 00001 -> 00010</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token comment">// 右边的筷子 expect : 00010 ^ 00010 -> 00000</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token keyword">return</span> chopstick<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>expect<span class="token punctuation">,</span> expect <span class="token operator">^</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token comment">// 尝试拿起左右筷子</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token keyword">int</span> expect <span class="token operator">=</span> chopstick<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token comment">// 只有当前筷子没有被拿起才返回 true, 并且更新筷子状态</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token comment">// 例如：1 号拿起筷子 00001 和 00010 , 更新后 : 00011 (说明 1, 2 号筷子被拿了)</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token comment">//  此时 2 号想拿起左边的筷子 : 00010 , &amp; 运算发现被拿了，返回 false</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span>expect <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> chopstick<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>expect<span class="token punctuation">,</span> expect <span class="token operator">^</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="总结-7"><a class="anchor" href="#总结-7">#</a> 总结</h2>
<p>哲学家进餐问题的关键在于<strong>解决进程死锁</strong>。</p>
<p>这些进程之间只存在互斥关系，但是与之前接触到的互斥关系不同的是，每个进程都需要<strong>同时持有两个临界资源，因此就有 “死锁” 问题的隐患。</strong></p>
<hr />
<p>如果在考试中遇到了一个进程需要<strong>同时持有多个临界资源的情况，应该参考哲学家问题的思想</strong>，分析题中给出的进程之间是否会发生循环等待，是否会发生死锁。</p>
<p>可以参考哲学家就餐问题解决死锁的三种思路。</p>
<h1 id="管程"><a class="anchor" href="#管程">#</a> 管程</h1>
<p><strong>管程就是一个软件模块，里面封装了实现同步，互斥的函数</strong></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230204224328863.png" alt="image-20230204224328863" /></p>
<h2 id="为什么要引入管程"><a class="anchor" href="#为什么要引入管程">#</a> 为什么要引入管程</h2>
<p>信号量机制存在的<strong>问题</strong>：编写程序困难、易出错</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230204224513867.png" alt="image-20230204224513867" /></p>
<hr />
<p>能不能设计一种机制，让程序员写程序时不需要再关注复杂的  <code>PV</code>  操作，让写代码更轻松呢？</p>
<p>1973 年， <code>Brinch Hansen</code>  首次在程序设计语言（ <code>Pascal</code> ）中引入了 “管程” 成分 —―一种高级同步机制</p>
<h2 id="管程的定义和基本特征"><a class="anchor" href="#管程的定义和基本特征">#</a> 管程的定义和基本特征</h2>
<p>管程是一种<strong>特殊的软件模块</strong>，有这些部分组成：</p>
<ol>
<li>
<p>局部于管程的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>共享数据结构</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}共享数据结构</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">共享数据结构</span></span></span></span>说明；</p>
</li>
<li>
<p>对该数据结构进行操作的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>一组过程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}一组过程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">一组过程</span></span></span></span></p>
</li>
<li>
<p>对局部于管程的共享数据设置初始值的语句；</p>
</li>
<li>
<p>管程有一个名字。</p>
</li>
</ol>
<p><code>Tips</code>  ：&quot;过程&quot; 其实就是 &quot;函数&quot;</p>
<hr />
<p>管程的基本特征：</p>
<ol>
<li>局部于管程的数据只能被局部于管程的过程所访问；</li>
<li>一个进程<strong>只有通过调用管程内的过程</strong>才能进入管程访问共享数据；
<ul>
<li>类似于 Java 中 private，要访问私有变量的数据，需要提供 public 方法才可以访问</li>
</ul>
</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>每次仅允许一个进程在管程内执行某个内部过程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}每次仅允许一个进程在管程内执行某个内部过程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">每次仅允许一个进程在管程内执行某个内部过程</span></span></span></span></li>
</ol>
<p>例：若想访问这些数据结构的话，需要调用管程中的<strong>函数间接</strong>的访问这些数据</p>
<hr />
<h2 id="拓展1用管程解决生产者消费者问题"><a class="anchor" href="#拓展1用管程解决生产者消费者问题">#</a> 拓展 1∶用管程解决生产者消费者问题</h2>
<p>如下所示的伪代码：</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230204225925741.png" alt="image-20230204225925741" /></p>
<p>除了由编译器负责实现各进程互斥地进管程中的过程之外</p>
<ul>
<li>
<p>可以在管程中设置条件变量和等待 / 唤醒操作，已解决同步问题</p>
</li>
<li>
<p>例 2 ：两个消费者进程先执行，生产者进程后执行...</p>
</li>
</ul>
<hr />
<p>引入管程的目的无非就是要更方便地<strong>实现进程互斥和同步。</strong></p>
<ol>
<li>
<p>需要在管程中<strong>定义共享数据</strong>（如生产者消费者问题的缓冲区)</p>
</li>
<li>
<p>需要在管程中定义用于<strong>访问这些共享数据的 “入口”</strong> ――其实就是一些函数（如生产者消费者问题中，可以定义一个函数用于将产品放入缓冲区，再定义一个函数用于从缓冲区取出产品)</p>
</li>
<li>
<p>只有<strong>通过这些特定的 “入口” 才能访问共享数据</strong></p>
</li>
<li>
<p>管程中有很多 “入口”，但是<strong>每次只能开放其中一个 “入口”</strong>，并且只能让<strong>一个进程或线程进入</strong></p>
<p>（如生产者消费者问题中，各进程需要互斥地访问共享缓冲区。管程的这种特性即可保证一个时间段内最多只会有一个进程在访问缓冲区。)</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>注意</mtext><mo>:</mo><mtext>这种互斥特性是由编译器负责实现的，程序员不用关心</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}注意:这种互斥特性是由编译器负责实现的，程序员不用关心</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">注意</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel" style="color:red;">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">这种互斥特性是由编译器负责实现的，程序员不用关心</span></span></span></span></p>
</li>
<li>
<p>可在管程中设置<strong>条件变量</strong>及<strong>等待 / 唤醒操作</strong>以解决同步问题。可以让一个进程或线程在条件变量上等待</p>
<p>（<strong>此时，该进程应先释放管程的使用权，也就是让出 “入口”</strong>)；可以通过唤醒操作将等待在条件变量上的进程或线程唤醒。</p>
</li>
</ol>
<p>程序员可以用某种特殊的语法定义一个管程（比如:  <code>monitor ProducerConsumer .....end monitor</code> 😉</p>
<ul>
<li>之后其他程序员就可以使用这个管程提供的特定 “入口” 很方便地使用实现进程同步 / 互斥了。</li>
<li><strong>&quot;封装&quot; 思想</strong></li>
</ul>
<h2 id="拓展2java-中类似于管程的机制"><a class="anchor" href="#拓展2java-中类似于管程的机制">#</a> 拓展 2：Java 中类似于管程的机制</h2>
<p><code>Java</code>  中，如果用关键字  <code>synchronized</code>  来描述一个函数，那么这个函数同一时间段内只能被一个线程调用</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230204231246024.png" alt="image-20230204231246024" /></p>
<p>每次只能有一个线程进入  <code>insert</code>  函数，如果多个线程同时调用  <code>insert</code>  函数，则后来者需要排队等待</p>
<h2 id="整体框架-14"><a class="anchor" href="#整体框架-14">#</a> 整体框架</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230204232019688.png" alt="image-20230204232019688" /></p>
<h1 id="死锁"><a class="anchor" href="#死锁">#</a> 死锁</h1>
<h2 id="死锁的概念"><a class="anchor" href="#死锁的概念">#</a> 死锁的概念</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230204233612922.png" alt="image-20230204233612922" /></p>
<h3 id="什么是死锁"><a class="anchor" href="#什么是死锁">#</a> 什么是死锁</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205190745487.png" alt="image-20230205190745487" /></p>
<p>我等待你，你等待他，他等待她，她等待我..... 这世界每个人都爱别人.....</p>
<ul>
<li>我们从资源占有的角度来分析，这段关系为什么看起来那么纠结...</li>
</ul>
<hr />
<p>在并发环境下，各进程因竞争资源而造成的一种<strong>互相等待对方手里的资源</strong>，导致各进程都阻塞，都无法向前推进的现象，就是 &quot;死锁&quot;。</p>
<ul>
<li>发生死锁后若无外力干涉，这些进程都将无法向前推进。</li>
</ul>
<h3 id="死锁-饥饿-死循环的区别"><a class="anchor" href="#死锁-饥饿-死循环的区别">#</a> 死锁、饥饿、死循环的区别</h3>
<p><code>死锁</code> ：各进程互相等待对方手里的资源，导致各进程都阻塞，无法向前推进的现象。</p>
<p><code>饥饿</code> ：由于长期得不到想要的资源，某进程无法向前推进的现象。</p>
<ul>
<li>比如：在短进程优先（ <code>SPF</code> ）算法中，若有源源不断的短进程到来，则长进程将一直得不到处理机，从而发生长进程 “饥饿”。</li>
</ul>
<p><code>死循环</code> ：某进程执行过程中一直跳不出某个循环的现象。有时是因为程序逻辑  <code>bug</code>  导致的，有时是程序员故意设计的。</p>
<p>

<table height="100" width="100" border="1" >
	<thead>
        <tr>
            <th></th>
            <th>相同点</th>
            <th>不同点</th>
            </tr>
    </thead>
<tbody>
    <tr>
        <td>死锁</td>
        <td  rowspan="3" style = "width : 120px">都是进程无法顺利向前推进的现象<br>(故意设计的死循环除外)</br></td>
<td>死锁一定是 “循环等待对方手里的资源” 导致的，因此如果有死锁现象，那<span style = "color : red">至少有两个或两个以上的进程同时发生死锁</span>。另外，发生死锁的进程一定处于阻塞态。</td>
    </tr>
    <tr>
        <td>饥饿</td>
        <td><span style = "color : red">可能只有一个进程发生饥饿</span>。发生饥饿的进程既可能是阻塞态(如长期得不到需要的 I/O 设备)，也可能是就绪态(长期得不到处理机)</td>
    </tr>
    <tr>
        <td>死循环</td>
        <td>可能只有一个进程发生死循环。死循环的进程可以上处理机运行（可以是运行态），只不过无法像期待的那样顺利推进。死锁和饥饿问题是由于操作系统分配资源的策略不合理导致的，而死循环是由代码逻辑的错误导致的。<span style = "color : red">死锁和饥饿是管理者（操作系统）的问题,死循环是被管理者的问题</span>。</td>
    </tr>
</tbody>
    </table>
</p>
<h3 id="死锁产生的必要条件"><a class="anchor" href="#死锁产生的必要条件">#</a> 死锁产生的必要条件</h3>
<p>产生死锁必须同时满足一下四个条件，只要其中任一条件不成立，死锁就不会发生。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>互斥条件</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}互斥条件</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">互斥条件</span></span></span></span>：只有对必须互斥使用的资源的争抢才会导致死锁（如哲学家的筷子、打印机设备）。</p>
<ul>
<li>像内存、扬声器这样可以同时让多个进程使用的资源是不会导致死锁的（因为进程不用阻塞等待这种资源）。</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不剥夺条件</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不剥夺条件</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不剥夺条件</span></span></span></span>：进程所获得的资源在未使用完之前，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不能由其他进程强行夺走</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不能由其他进程强行夺走</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不能由其他进程强行夺走</span></span></span></span>，只能主动释放。</p>
<ul>
<li>例如：哲学家进程问题中，若每一个哲学家都持有一只筷子，则需要等待某一个哲学家释放该筷子，而不是强行夺走筷子</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>请求和保持条件</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}请求和保持条件</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">请求和保持条件</span></span></span></span>：进程已经<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>保持了至少一个资源</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}保持了至少一个资源</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">保持了至少一个资源</span></span></span></span>，但又提出了新的资源<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>请求</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}请求</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">请求</span></span></span></span>，而该资源又被其他进程占有，此时请求进程被阻塞，但又对自己已有的资源<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>保持</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}保持</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">保持</span></span></span></span>不放。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>循环等待条件</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}循环等待条件</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">循环等待条件</span></span></span></span>：存在一种进程<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>资源的循环等待链</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}资源的循环等待链</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">资源的循环等待链</span></span></span></span>，链中的每一个进程已获得的资源同时被下一个进程所请求。</p>
<hr />
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>注意！发生死锁时一定有循环等待，但是发生循环等待时未必死锁</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}注意！发生死锁时一定有循环等待，但是发生循环等待时未必死锁</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">注意！发生死锁时一定有循环等待，但是发生循环等待时未必死锁</span></span></span></span>（循环等待是死锁的必要不充分条件)</p>
<p>如果同类资源数大于 1 ，则即使有循环等待，也未必发生死锁。</p>
<ul>
<li>但如果系统中每类资源都只有一个，那循环等待就是死锁的充分必要条件了。</li>
</ul>
<h3 id="什么时候会发生死锁"><a class="anchor" href="#什么时候会发生死锁">#</a> 什么时候会发生死锁</h3>
<p>① <strong>对系统资源的竞争</strong>。各进程对不可剥夺的资源（如打印机）的竞争可能引起死锁，对可剥夺的资源（CPU）的竞争是不会引起死锁的。</p>
<p>② <strong>进程推进顺序非法</strong>。请求和释放资源的顺序不当，也同样会导致死锁。</p>
<ul>
<li>例如，并发执行的进程  <code>P1</code> 、 <code>P2</code>  分别申请并占有了资源  <code>R1</code> 、 <code>R2</code>  ，之后进程  <code>P1</code>  又紧接着申请资源  <code>R2</code> ，而进程  <code>P2</code>  又申请资源  <code>R1</code> ，两者会因为申请的资源被对方占有而阻塞，从而发生死锁。</li>
</ul>
<p>③ <strong>信号量的使用不当</strong>也会造成死锁。</p>
<ul>
<li>如生产者 - 消费者问题中，如果实现互斥的 P 操作在实现同步的  <code>P</code>  操作之前，就有可能导致死锁。(可以把互斥信号量、同步信号量也看做是一种抽象的系统资源）</li>
</ul>
<hr />
<p><code>总之</code> ，对不可剥夺资源的不合理分配，可能导致死锁。</p>
<h3 id="死锁的处理策略"><a class="anchor" href="#死锁的处理策略">#</a> 死锁的处理策略</h3>
<p><strong>预防死锁</strong>。</p>
<ul>
<li>破坏死锁产生的四个必要条件中的一个或几个。</li>
</ul>
<p><strong>避免死锁</strong>。</p>
<ul>
<li>用某种方法防止系统进入不安全状态，从而避免死锁（银行家算法)</li>
</ul>
<p><strong>死锁的检测和解除</strong>。</p>
<ul>
<li>允许死锁的发生，不过操作系统会负责检测出死锁的发生，然后采取某种措施解除死锁。</li>
</ul>
<h3 id="整体框架-15"><a class="anchor" href="#整体框架-15">#</a> 整体框架</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205195304249.png" alt="image-20230205195304249" /></p>
<h2 id="死锁的处理策略-2"><a class="anchor" href="#死锁的处理策略-2">#</a> 死锁的处理策略</h2>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205200435716.png" alt="image-20230205200435716" /></p>
<h3 id="预防死锁"><a class="anchor" href="#预防死锁">#</a> 预防死锁</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205205302564.png" alt="image-20230205205302564" /></p>
<h4 id="破坏互斥条件"><a class="anchor" href="#破坏互斥条件">#</a> 破坏互斥条件</h4>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>互斥条件</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}互斥条件</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">互斥条件</span></span></span></span>：只有对必须互斥使用的资源的争抢才会导致死锁。</p>
<p>如果把只能互斥使用的资源改造为允许共享使用，则系统不会进入死锁状态。</p>
<ul>
<li>比如：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mi>S</mi><mi>P</mi><mi>O</mi><mi>O</mi><mi>L</mi><mi>i</mi><mi>n</mi><mi>g</mi></mstyle></mrow><annotation encoding="application/x-tex">\color{red}SPOOLing</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;color:red;">SPOO</span><span class="mord mathnormal" style="color:red;">L</span><span class="mord mathnormal" style="color:red;">in</span><span class="mord mathnormal" style="margin-right:0.03588em;color:red;">g</span></span></span></span> 技术。操作系统可以采用  <code>SPOOLing</code>  技术把独占设备在逻辑上改造成共享设备。</li>
<li>比如，用  <code>SPOOLing</code>  技术将打印机改造为共享设备...</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205202413625.png" alt="image-20230205202413625" /></p>
<p>如上右所示：进程 1 和进程 2 将作业交给输出进程即可，不需要阻塞，具体的打印操作由输出进程操作即可</p>
<ul>
<li>可以理解为菜鸟驿站</li>
</ul>
<hr />
<p>该策略的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>缺点</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}缺点</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">缺点</span></span></span></span>：<strong>并不是所有的资源都可以改造成可共享使用的资源</strong>。</p>
<ul>
<li>
<p>并且为了系统安全，很多地方还必须保护这种互斥性。</p>
</li>
<li>
<p>因此，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>很多时候都无法破坏互斥条件</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}很多时候都无法破坏互斥条件</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">很多时候都无法破坏互斥条件</span></span></span></span>。</p>
</li>
</ul>
<h4 id="破坏不剥夺条件"><a class="anchor" href="#破坏不剥夺条件">#</a> 破坏不剥夺条件</h4>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不剥夺条件</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不剥夺条件</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不剥夺条件</span></span></span></span>：进程所获得的资源在未使用完之前，不能由其他进程强行夺走，只能主动释放。</p>
<p>破坏不剥夺条件:</p>
<p>① 方案一：当某个进程请求新的资源得不到满足时，它必须<strong>立即释放保持的所有资源</strong>，待以后需要时再重新申请。也就是说，即使某些资源尚未使用完，也需要主动释放，从而破坏了不可剥夺条件。</p>
<p>② 方案二：当某个进程需要的资源被其他进程所占有的时候，可以由操作系统协助，将想要的资源强行剥夺。这种方式一般需要考虑各进程的<strong>优先级</strong>（比如：剥夺调度方式，就是将处理机资源强行剥夺给优先级更高的进程使用)</p>
<hr />
<p>该策略的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>缺点</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}缺点</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">缺点</span></span></span></span></p>
<ul>
<li>
<p>实现起来比较复杂</p>
</li>
<li>
<p>释放已获得的资源可能造成前一阶段工作的失效。</p>
</li>
<li>
<p>因此这种方法一般只适用于<strong>易保存和恢复状态的资源</strong>，如  <code>CPU</code> 。</p>
</li>
<li>
<p>反复地申请和释放资源会增加系统开销，降低系统吞吐量。</p>
</li>
<li>
<p>若采用方案一，意味着只要暂时得不到某个资源、之前获得的那些资源就都需要放弃，以后再重新申请。<strong>如果一直发生这样的情况，就会导致进程饥饿。</strong></p>
</li>
</ul>
<h4 id="破坏请求和保持条件"><a class="anchor" href="#破坏请求和保持条件">#</a> 破坏请求和保持条件</h4>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>请求和保持条件</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}请求和保持条件</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">请求和保持条件</span></span></span></span>：进程<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>已经保持了至少一个资源</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}已经保持了至少一个资源</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">已经保持了至少一个资源</span></span></span></span>，但又提出了新的资源<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>请求</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}请求</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">请求</span></span></span></span>，而该资源又被其他进程占有，此时请求进程被阻塞，但又对自己已有的资源<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>保持</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}保持</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">保持</span></span></span></span>不放。</p>
<p>可以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>采用静态分配方法</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}采用静态分配方法</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">采用静态分配方法</span></span></span></span>，即进程在<strong>运行前一次申请完它所需要的全部资源</strong>，在它的资源未满足前，不让它投入运行。一旦投入运行后，这些资源就一直归它所有，该进程就不会再请求别的任何资源了。</p>
<hr />
<p>该策略实现起来简单，但也有明显的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>缺点</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}缺点</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">缺点</span></span></span></span>:</p>
<ul>
<li>
<p>有些资源可能只需要用很短的时间，因此如果进程的整个运行期间都一直保持着所有资源，就会造成严重的资源浪费，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>资源利用率极低</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}资源利用率极低</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">资源利用率极低</span></span></span></span>。</p>
</li>
<li>
<p>另外，该策略也有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>可能导致某些进程饥饿</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}可能导致某些进程饥饿</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">可能导致某些进程饥饿</span></span></span></span>。</p>
</li>
</ul>
<p>如下所示：若有源源不断地  <code>A</code>  类进程进来，资源 1 一直被分配给  <code>A</code>  类进程，会导致  <code>C</code>  类进程饥饿</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205203845412.png" alt="image-20230205203845412" /></p>
<h4 id="破坏循环等待条件"><a class="anchor" href="#破坏循环等待条件">#</a> 破坏循环等待条件</h4>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>循环等待条件</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}循环等待条件</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">循环等待条件</span></span></span></span>：存在一种进程资源的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>循环等待链</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}循环等待链</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">循环等待链</span></span></span></span>，链中的每一个进程已获得的资源同时被下一个进程所请求。</p>
<p>可采用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>顺序资源分配法</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}顺序资源分配法</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">顺序资源分配法</span></span></span></span>。首先给系统中的资源编号，规定每个进程必<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>须按编号递增的顺序请求资源</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}须按编号递增的顺序请求资源</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">须按编号递增的顺序请求资源</span></span></span></span>，同类资源（即编号相同的资源）一次申请完。</p>
<p>原理分析：一个进程只有已占有小编号的资源时，才有资格申请更大编号的资源。按此规则，已持有大编号资源的进程不可能逆向地回来申请小编号的资源，从而就不会产生循环等待的现象。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205204611090.png" alt="image-20230205204611090" /></p>
<hr />
<p>该策略的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>缺点</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}缺点</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">缺点</span></span></span></span>:</p>
<ul>
<li>不方便增加新的设备，因为可能需要重新分配所有的编号；</li>
<li>进程实际使用资源的顺序可能和编号递增<strong>顺序不一致，会导致资源浪费</strong>；</li>
</ul>
<p>例如：5 号资源为打印机，7 号资源为扫描仪。 <code>P3</code>  进程应该先使用扫描仪，在使用打印机，但是实际上缺失先使用打印机，再使用扫描仪，导致打印机<strong>空闲</strong>了很长一段时间，等到扫描仪使用完了在使用打印机资源。因此导致系统资源的浪费</p>
<ul>
<li>必须按规定次序申请资源，用户编程麻烦。</li>
</ul>
<h3 id="避免死锁银行家算法"><a class="anchor" href="#避免死锁银行家算法">#</a> 避免死锁（银行家算法）</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205212214871.png" alt="image-20230205212214871" /></p>
<h4 id="什么是安全序列"><a class="anchor" href="#什么是安全序列">#</a> 什么是安全序列</h4>
<p>你是一位成功的银行家，手里掌握着 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn></mrow><annotation encoding="application/x-tex">100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">100</span></span></span></span> 个亿的资金...<br />
 有三个企业想找你贷款，分别是企业  <code>B</code> 、企业  <code>A</code> 、企业  <code>T</code> ，为描述方便，简称  <code>BAT</code>  。</p>
<p><code>B</code>  表示:“大哥，我最多会跟你借 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>70</mn></mrow><annotation encoding="application/x-tex">70</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">70</span></span></span></span> 亿...”</p>
<p><code>A</code>  表示:“大哥，我最多会跟你借 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>40</mn></mrow><annotation encoding="application/x-tex">40</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">40</span></span></span></span> 亿..”</p>
<p><code>T</code>  表示:“大哥，我最多会跟你借 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>50</mn></mrow><annotation encoding="application/x-tex">50</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">50</span></span></span></span> 亿..”</p>
<p><strong>然而... 江湖中有个不成文的规矩：如果你借给企业的钱总数达不到企业提出的最大要求，那么不管你之前给企业借了多少钱，那些钱都拿不回来了....</strong></p>
<p>刚开始， <code>BAT</code>  三个企业分别从你这儿借了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn></mrow><annotation encoding="application/x-tex">20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">20</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>30</mn></mrow><annotation encoding="application/x-tex">30</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">30</span></span></span></span> 亿....</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205212604852.png" alt="image-20230205212604852" /></p>
<p>① 先给  <code>B</code>  借 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>30</mn></mrow><annotation encoding="application/x-tex">30</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">30</span></span></span></span> 亿</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205212946136.png" alt="image-20230205212946136" /></p>
<p>所以给  <code>B</code>  借 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>30</mn></mrow><annotation encoding="application/x-tex">30</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">30</span></span></span></span> 亿是不安全的...</p>
<hr />
<p>② 先给  <code>A</code>  借 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn></mrow><annotation encoding="application/x-tex">20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">20</span></span></span></span> 亿，再借给  <code>B</code>  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>50</mn></mrow><annotation encoding="application/x-tex">50</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">50</span></span></span></span> 亿</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205213233137.png" alt="image-20230205213233137" /></p>
<hr />
<p>③ 先给  <code>A</code>  借 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn></mrow><annotation encoding="application/x-tex">20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">20</span></span></span></span> 亿，再借给  <code>T</code>  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn></mrow><annotation encoding="application/x-tex">20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">20</span></span></span></span> 亿</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205213358083.png" alt="image-20230205213358083" /></p>
<hr />
<h4 id="安全序列-不安全状态-死锁的联系"><a class="anchor" href="#安全序列-不安全状态-死锁的联系">#</a> 安全序列、不安全状态、死锁的联系</h4>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205213527877.png" alt="image-20230205213527877" /></p>
<p>所谓<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>安全序列</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}安全序列</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">安全序列</span></span></span></span>，就是指如果系统按照这种序列分配资源，则每个进程都能顺利完成。只要能找出一个安全序列，系统就是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>安全状态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}安全状态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">安全状态</span></span></span></span>。当然，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>安全序列可能有多个</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}安全序列可能有多个</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">安全序列可能有多个</span></span></span></span>。</p>
<p>如果分配了资源之后，系统中<strong>找不出任何一个安全序列</strong>，系统就进入了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不安全状态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不安全状态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不安全状态</span></span></span></span>。这就意味着之后<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>可能</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}可能</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">可能</span></span></span></span>所有进程都无法顺利的执行下去。当然，如果有进程提前归还了一些资源，那<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>系统也有可能重新回到安全状态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}系统也有可能重新回到安全状态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">系统也有可能重新回到安全状态</span></span></span></span>，不过我们在分配资源之前总是要考虑到最坏的情况。</p>
<p>如果系统处于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>安全状态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}安全状态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">安全状态</span></span></span></span>，就<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>一定不会</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}一定不会</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">一定不会</span></span></span></span>发生<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>死锁</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}死锁</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">死锁</span></span></span></span>。如果系统进入<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不安全状态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不安全状态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不安全状态</span></span></span></span>，就<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>可能</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}可能</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">可能</span></span></span></span>发生<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>死锁</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}死锁</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">死锁</span></span></span></span>（处于不安全状态未必就是发生了死锁，但发生死锁时一定是在不安全状态)</p>
<hr />
<p>因此可以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>在资源分配之前预先判断这次分配是否会导致系统进入不安全状态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}在资源分配之前预先判断这次分配是否会导致系统进入不安全状态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">在资源分配之前预先判断这次分配是否会导致系统进入不安全状态</span></span></span></span>，以此决定是否答应资源分配请求。这也是 “<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>银行家算法</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}银行家算法</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">银行家算法</span></span></span></span>” 的核心思想。</p>
<h4 id="银行家算法"><a class="anchor" href="#银行家算法">#</a> 银行家算法</h4>
<p>银行家算法是荷兰学者  <code>Dijkstra</code>  为银行系统设计的，以确保银行在发放现金贷款时，不会发生不能满足所有客户需要的情况。后来该算法被用在操作系统中，用于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>避免死锁</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}避免死锁</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">避免死锁</span></span></span></span>。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>核心思想</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}核心思想</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">核心思想</span></span></span></span>：在进程提出资源申请时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>先预判此次分配是否会导致系统进入不安全状态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}先预判此次分配是否会导致系统进入不安全状态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">先预判此次分配是否会导致系统进入不安全状态</span></span></span></span></p>
<ul>
<li>如果会进入不安全状态，就暂时不答应这次请求，让该进程先阻塞等待。</li>
</ul>
<hr />
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205214319141.png" alt="image-20230205214319141" /></p>
<hr />
<p>此时系统是否处于安全状态？</p>
<p>思路：尝试找出一个安全序列...<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mrow><mi>P</mi><mn>1</mn></mrow></mstyle></mrow><annotation encoding="application/x-tex">\color{red}{P1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord" style="color:red;"><span class="mord mathnormal" style="margin-right:0.13889em;color:red;">P</span><span class="mord" style="color:red;">1</span></span></span></span></span></p>
<p>依次检查剩余可用资源  <code>(3,3,2)</code>  是否能满足各进程的需求</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205214812187.png" alt="image-20230205214812187" /></p>
<p>① 可满足  <code>P1</code>  需求，将  <code>P1</code>  加入安全序列，并更新剩余可用资源值为 <code>(5,3,2)</code></p>
<p>依次检查剩余可用资源  <code>(5,3,2)</code>  是否能满足剩余进程（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不包括已加入安全序列的进程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不包括已加入安全序列的进程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不包括已加入安全序列的进程</span></span></span></span>）的需求</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205215001648.png" alt="image-20230205215001648" /></p>
<p>说明如果优先把资源分配给  <code>P3</code>  , 那  <code>P3</code>  一定是可以顺利执行结束的。等  <code>P3</code>  结束了就会归还资源。</p>
<ul>
<li>于是，资源数就可以增加到  <code>(2,1,1)+(5,3,2)=(7,4,3)</code></li>
</ul>
<p>② 可满足  <code>P3</code>  需求，将  <code>P3</code>  加入安全序列，并更新剩余可用资源值为 <code>(7,4,3)</code></p>
<p>依次检查剩余可用资源  <code>(7,4,3)</code>  是否能满足剩余进程（不包括已加入安全序列的进程）的需求.....</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205215208268.png" alt="image-20230205215208268" /></p>
<p>……….</p>
<p>以此类推，共五次循环检查即可将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 个进程都加入安全序列中，最终可得一个安全序列。</p>
<p>该算法称为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>安全性算法</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}安全性算法</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">安全性算法</span></span></span></span>。可以很方便地用代码实现以上流程，每一轮检查都从编号较小的进程开始检查实际做题时可以更快速的得到安全序列。</p>
<hr />
<p><strong>对于手算</strong></p>
<p>① 可以找到安全序列的例子</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205215627709.png" alt="image-20230205215627709" /></p>
<p>实际做题（手算）时可用更快速的方法找到一个安全序列:<br />
 经对比发现， <code>(3,3,2)</code>  可满足  <code>P1</code>  、 <code>P3</code>  ，说明无论如何，这两个进程的资源需求一定是可以依次被满足的，因此  <code>P1</code> 、 <code>P3</code>  一定可以顺利的执行完，并归还资源。可把  <code>P1</code> 、 <code>P3</code>  先加入安全序列。<br />
 <code>(2,0,0)+(2,1,1)+(3,3,2)= (7,4,3)</code></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205215722103.png" alt="image-20230205215722103" /></p>
<p>剩下的  <code>P0</code> 、 <code>P2</code>  、 <code>P4</code>  都可被满足。同理，这些进程都可以加入安全序列。</p>
<p>于是，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> 个进程全部加入安全序列，说明此时系统<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>处于安全状态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}处于安全状态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">处于安全状态</span></span></span></span>，暂<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不可能发生死锁</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不可能发生死锁</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不可能发生死锁</span></span></span></span></p>
<p>② 找不到安全序列的例子</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205215938160.png" alt="image-20230205215938160" /></p>
<p>经对比发现， <code>(3,3,2)</code>  可满足  <code>P1</code> 、 <code>P3</code> ，说明无论如何，这两个进程的资源需求一定是可以依次被满足的，因此 <code>P1</code> 、 <code>P3</code>  一定可以顺利的执行完，并归还资源。可把  <code>P1</code> 、 <code>P3</code>  先加入安全序列。</p>
<ul>
<li><code>(2,0,0)+(2,1,1)+(3,3,2)= (7,4,3)</code></li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205220040671.png" alt="image-20230205220040671" /></p>
<p>剩下的  <code>P0</code>  需要  <code>(8,4,3)</code> ， <code>P2</code>  需要  <code>(6,5,0)</code> ， <code>P4</code>  需要  <code>(4,3,4)</code>  任何一个进程都不能被完全满足</p>
<p>于是，无法找到任何一个安全序列，说明此时系统处于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不安全状态</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不安全状态</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不安全状态</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>有可能发生死锁</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}有可能发生死锁</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">有可能发生死锁</span></span></span></span>。</p>
<h4 id="java-实现银行家算法"><a class="anchor" href="#java-实现银行家算法">#</a> Java 实现银行家算法</h4>
<p><code>BankerAlgorithm.class</code></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BankerAlgorithm</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="8"></td><td><pre>     * @param maximumDemands 最大需求，第 i 个进程的最大需求为数组 j</pre></td></tr><tr><td data-num="9"></td><td><pre>     * @param assigneds      已分配，第 i 个进程的已分配的数量为数组 j</pre></td></tr><tr><td data-num="10"></td><td><pre>     * @param totalResource  可用资源数</pre></td></tr><tr><td data-num="11"></td><td><pre>     * @return 是否是安全序列</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSafeSequence</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> maximumDemands<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> assigneds<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> totalResource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 预处理，获取当前进程最多还需要的需求</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mostNeededs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>maximumDemands<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">[</span>maximumDemands<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> remainResource <span class="token operator">=</span> totalResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maximumDemands<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// 最多还需要</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> curNeed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>maximumDemands<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token comment">// 最大需求</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> curMaxDemand <span class="token operator">=</span> maximumDemands<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token comment">// 已分配</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> curAssigned <span class="token operator">=</span> assigneds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> curMaxDemand<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                curNeed<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>curMaxDemand<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">-</span> curAssigned<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token keyword">int</span> total <span class="token operator">=</span> remainResource<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                remainResource<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> total <span class="token operator">-</span> curAssigned<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            mostNeededs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> curNeed<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">dfs</span><span class="token punctuation">(</span>assigneds<span class="token punctuation">,</span> mostNeededs<span class="token punctuation">,</span> remainResource<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span>maximumDemands<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> assigneds<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mostNeededs<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> remainResource<span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> isVisited<span class="token punctuation">,</span> <span class="token keyword">int</span> cnt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// 被分配完了</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">==</span> mostNeededs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mostNeededs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token comment">// 被访问过了</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isVisited<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token comment">// 满足需求</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> check <span class="token operator">=</span> <span class="token function">check</span><span class="token punctuation">(</span>assigneds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> mostNeededs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> remainResource<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>check <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> temp <span class="token operator">=</span> remainResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                remainResource <span class="token operator">=</span> check<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token comment">// 移除当前进程</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                isVisited<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dfs</span><span class="token punctuation">(</span>assigneds<span class="token punctuation">,</span> mostNeededs<span class="token punctuation">,</span> remainResource<span class="token punctuation">,</span> isVisited<span class="token punctuation">,</span> cnt <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                isVisited<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                remainResource <span class="token operator">=</span> temp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token comment">// 检查是否满足需求，并且重新计算剩余资源数</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> assigned<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mostNeeded<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> remainResource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>mostNeeded<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mostNeeded<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token keyword">int</span> diff <span class="token operator">=</span> remainResource<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> mostNeeded<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            ans<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> assigned<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> remainResource<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>Test.class</code></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">BankerAlgorithm</span> bankerAlgorithm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BankerAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">//int[][] maximumDemands = new int[][]&#123; &#123;7, 5, 3&#125;, &#123;3, 2, 2&#125;, &#123;9, 0, 2&#125;, &#123;2, 2, 2&#125;, &#123;4, 3, 3&#125;&#125;;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token comment">//int[][] assigneds = new int[][]&#123; &#123;0, 1, 0&#125;, &#123;2, 0, 0&#125;, &#123;3, 0, 2&#125;, &#123;2, 1, 1&#125;, &#123;0, 0, 2&#125;&#125;;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">//true</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> maximumDemands <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#123;</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> assigneds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">//false</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        </pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> totalResource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bankerAlgorithm<span class="token punctuation">.</span><span class="token function">isSafeSequence</span><span class="token punctuation">(</span>maximumDemands<span class="token punctuation">,</span> assigneds<span class="token punctuation">,</span> totalResource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="总结-8"><a class="anchor" href="#总结-8">#</a> 总结</h4>
<p>银行家算法步骤:</p>
<p>① 检查此次申请是否超过了之前声明的最大需求数</p>
<p>② 检查此时系统剩余的可用资源是否还能满足这次请求</p>
<p>③ 试探着分配，更改各数据结构</p>
<p>④ 用安全性算法检查此次分配是否会导致系统进入不安全状态</p>
<p>安全性算法步骤:</p>
<ul>
<li>检查当前的剩余可用资源是否能满足某个进程的最大需求，如果可以，就把该进程加入安全序列，并把该进程持有的资源全部回收。</li>
</ul>
<p>系统处于不安全状态未必死锁，但死锁时一定处于不安全状态。系统处于安全状态一定不会死锁。</p>
<h3 id="检测和解除"><a class="anchor" href="#检测和解除">#</a> 检测和解除</h3>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205232424000.png" alt="image-20230205232424000" /></p>
<p>如果系统中既不采取预防死锁的措施，也不采取避免死锁的措施，系统就很<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>可能发生死锁</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}可能发生死锁</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">可能发生死锁</span></span></span></span>。在这种情况下，系统应当提供两个算法:</p>
<p>① 死锁检测算法：用于检测系统状态，以确定系统中是否发生了死锁。<br />
② 死锁解除算法：当认定系统中已经发生了死锁，利用该算法可将系统从死锁状态中解脱出来。</p>
<h4 id="死锁的检测"><a class="anchor" href="#死锁的检测">#</a> 死锁的检测</h4>
<p>为了能对系统是否已发生了死锁进行检测，必须:</p>
<p>① 用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>某种数据结构</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}某种数据结构</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">某种数据结构</span></span></span></span>来保存资源的请求和分配信息；</p>
<p>② 提供<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>一种算法</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}一种算法</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">一种算法</span></span></span></span>，利用上述信息来检测系统是否已进入死锁状态。</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205232953003.png" alt="image-20230205232953003" /></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205232958501.png" alt="image-20230205232958501" /></p>
<h5 id="java-定义该数据结构资源分配图"><a class="anchor" href="#java-定义该数据结构资源分配图">#</a> Java 定义该数据结构（资源分配图）</h5>
<p><strong>① map 构造邻接表</strong></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceAllocationGraph</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="3"></td><td><pre>     * 对于 Map&lt;Node, List&lt;Pair>> map</pre></td></tr><tr><td data-num="4"></td><td><pre>     * 若 Node 为进程则 List&lt;Pair> 为申请某些资源数量，</pre></td></tr><tr><td data-num="5"></td><td><pre>     * 例如：P1 (false, 1) : [Pair (R1, 1)]</pre></td></tr><tr><td data-num="6"></td><td><pre>     * 表示 p1 请求资源的总数量为 1, 申请资源 R1 的数量为 1</pre></td></tr><tr><td data-num="7"></td><td><pre>     * 若 Node 为资源则 List&lt;Pair> 为分配给进程的资源数量</pre></td></tr><tr><td data-num="8"></td><td><pre>     * 例如：R1 (true, 0) : [Pair (P1, 2), Pair (P2, 1)]</pre></td></tr><tr><td data-num="9"></td><td><pre>     * 表示 R1 剩余资源为 0, 分配给 P1, p2 的资源数分别为 2, 1</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> processes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> resources<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 是否是资源的标志， true : 资源， false : 进程</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">boolean</span> isResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 若为资源：当前剩余资源的总数量</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 若为进程：当前进程请求资源的总数量</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">int</span> val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 进程: pi 被分配的资源的节点 + 相应的分配数</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 资源: ri 被请求的进程节点 + 相应的请求数</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> inDegreeNodes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 进程：pi 申请的资源节点 + 相应的申请数</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 资源: ri 分配出去的进程节点 + 相应的分配数</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> outDegreeNodes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isResource<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>isResource <span class="token operator">=</span> isResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>② 双向链表</strong></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceAllocationGraph</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">Node</span> prevProcess<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">Node</span> nextProcess<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">Node</span> prevResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">Node</span> nextResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">int</span> <span class="token function">pSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">int</span> <span class="token function">rSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 是否是资源的标志， true : 资源， false : 进程</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">boolean</span> isResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 若为资源：当前剩余资源的总数量</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 若为进程：当前进程请求资源的总数量</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">int</span> val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 进程: pi 被分配的资源的节点 + 相应的分配数</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 资源: ri 被请求的进程节点 + 相应的请求数</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> inDegreeNodes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 进程：pi 申请的资源节点 + 相应的申请数</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 资源: ri 分配出去的进程节点 + 相应的分配数</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> outDegreeNodes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isResource<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>isResource <span class="token operator">=</span> isResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><hr />
<h5 id="死锁检测的流程"><a class="anchor" href="#死锁检测的流程">#</a> 死锁检测的流程</h5>
<p>① 如果系统中剩余的可用资源数足够满足进程的需求，那么这个进程暂时是不会阻塞的，可以顺利地执行下去。</p>
<p>② 如果这个进程执行结束了把资源归还系统，就可能使某些正在等待资源的进程被激活，并顺利地执行下去。</p>
<p>③ 相应的，这些被激活的进程执行完了之后又会归还一些资源，这样可能又会激活另外一些阻塞的进程..</p>
<p>如果按上述过程分析，最终<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>能消除所有边</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}能消除所有边</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">能消除所有边</span></span></span></span>，就称这个图是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mo>&lt;</mo><mi>i</mi><mo>&gt;</mo><mtext>可完全简化的</mtext><mo>&lt;</mo><mi mathvariant="normal">/</mi><mi>i</mi><mo>&gt;</mo></mstyle></mrow><annotation encoding="application/x-tex">\color{red}&lt;i&gt;可完全简化的&lt;/i&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel" style="color:red;">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="color:red;">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel" style="color:red;">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord cjk_fallback" style="color:red;">可完全简化的</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel" style="color:red;">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord" style="color:red;">/</span><span class="mord mathnormal" style="color:red;">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel" style="color:red;">&gt;</span></span></span></span>。此时一定<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>没有发生死锁</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}没有发生死锁</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">没有发生死锁</span></span></span></span>（相当于能找到一个安全序列)</p>
<p>如果最终<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不能消除所有边</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不能消除所有边</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不能消除所有边</span></span></span></span>，那么此时就是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>发生了死锁</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}发生了死锁</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">发生了死锁</span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>最终还连着边的那些进程就是处于死锁状态的进程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}最终还连着边的那些进程就是处于死锁状态的进程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">最终还连着边的那些进程就是处于死锁状态的进程</span></span></span></span>。</p>
<hr />
<p><strong>安全序列的情况</strong></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230205232958501.png" alt="image-20230205232958501" /></p>
<p>上述所示：</p>
<ul>
<li>
<p>对于  <code>P2</code>  来说，若  <code>P2</code>  想申请  <code>R1</code>  资源，但是  <code>R1</code>  已经分配出去 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span> 个，因此  <code>P2</code>  的申请请求不能被满足</p>
</li>
<li>
<p>对于  <code>P1</code>  来说，若  <code>P1</code>  想申请  <code>R2</code>  资源， <code>R2</code>  已经分给  <code>P2</code>  一个，还剩余 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 个，所以  <code>P1</code>  可以得到满足。然后等待  <code>P1</code>  运行完毕之后， <code>P1</code>  会释放自己所拥有的资源（即： <code>R1</code>  ：0 -&gt; 2）。之后  <code>P2</code>  也可以得到满足...</p>
<p>具体流程如下所示：</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/p.gif" alt="p" /></p>
</li>
</ul>
<hr />
<p><strong>产生死锁的情况</strong></p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230206000001043.png" alt="image-20230206000001043" /></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>最终还连着边的那些进程就是处于死锁状态的进程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}最终还连着边的那些进程就是处于死锁状态的进程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">最终还连着边的那些进程就是处于死锁状态的进程</span></span></span></span></p>
<p>如下所示</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230206000131594.png" alt="image-20230206000131594" /></p>
<hr />
<h5 id="死锁检测的算法"><a class="anchor" href="#死锁检测的算法">#</a> 死锁检测的算法</h5>
<p>1）在资源分配图中，找出 <code>既不阻塞又不是孤点的进程 Pi</code> （即找出一条有向边与它相连，<strong>且该有向边对应资源的申请数量小于等于系统中已有空闲资源数量</strong>。</p>
<ul>
<li>如下图中， <code>R1</code>  没有空闲资源， <code>R2</code>  有一个空闲资源。若所有的连接该进程的边均满足上述条件，则这个进程能继续运行直至完成，然后释放它所占有的所有资源）。消去它所有的请求边和分配变，使之称为孤立的结点。在下图中， <code>P1</code>  是满足这一条件的进程结点，于是将  <code>P1</code>  的所有边消去。</li>
</ul>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230206000520318.png" alt="image-20230206000520318" /></p>
<hr />
<p>2）进程  <code>Pi</code>  所释放的资源，可以唤醒某些因等待这些资源而阻塞的进程，原来的阻塞进程可能变为非阻塞进程。</p>
<ul>
<li>在下图中， <code>P2</code>  就满足这样的条件。根据 1) 中的方法进行一系列简化后，若能消去途中所有的边，则称该图是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>可完全简化的</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}可完全简化的</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">可完全简化的</span></span></span></span>。</li>
</ul>
<p><code>P1</code>  的所有边消去后的资源分配图</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230206000620976.png" alt="image-20230206000620976" /></p>
<p><code>P2</code>  的所有边消去后的可完全简化的资源分配图</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230206000738761.png" alt="image-20230206000738761" /></p>
<hr />
<h5 id="java-实现死锁检测的算法"><a class="anchor" href="#java-实现死锁检测的算法">#</a> Java 实现死锁检测的算法</h5>
<p>资源分配图</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 资源分配图</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">ResourceAllocationGraph</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="4"></td><td><pre>     * 对于 Map&lt;Node, List&lt;Pair>> map</pre></td></tr><tr><td data-num="5"></td><td><pre>     * 若 Node 为进程则 List&lt;Pair> 为申请某些资源数量，</pre></td></tr><tr><td data-num="6"></td><td><pre>     * 例如：P1 (false, 1) : [Pair (R1, 1)]</pre></td></tr><tr><td data-num="7"></td><td><pre>     * 表示 p1 请求资源的总数量为 1, 申请资源 R1 的数量为 1</pre></td></tr><tr><td data-num="8"></td><td><pre>     * 若 Node 为资源则 List&lt;Pair> 为分配给进程的资源数量</pre></td></tr><tr><td data-num="9"></td><td><pre>     * 例如：R1 (true, 0) : [Pair (P1, 2), Pair (P2, 1)]</pre></td></tr><tr><td data-num="10"></td><td><pre>     * 表示 R1 剩余资源为 0, 分配给 P1, p2 的资源数分别为 2, 1</pre></td></tr><tr><td data-num="11"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> processes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> resources<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 是否是资源的标志， true : 资源， false : 进程</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">boolean</span> isResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 若为资源：当前剩余资源的总数量</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 若为进程：当前进程请求资源的总数量</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">int</span> val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 进程: pi 被分配的资源的节点 + 相应的分配数</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// 资源: ri 被请求的进程节点 + 相应的请求数</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> inDegreeNodes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 进程：pi 申请的资源节点 + 相应的申请数</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 资源: ri 分配出去的进程节点 + 相应的分配数</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> outDegreeNodes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isResource<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>isResource <span class="token operator">=</span> isResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>step 1 : 构建资源分配图</p>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230206000520318.png" alt="image-20230206000520318" /></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">ResourceAllocationGraph</span> <span class="token function">builderResourceGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 资源</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">Node</span> r1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">Node</span> r2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 进程</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">//        Node p1 = new Node(false, 1);</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">Node</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">Node</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">//r1 分配出去的资源和请求 r1 资源的进程</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    r1<span class="token punctuation">.</span>outDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    r1<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    r1<span class="token punctuation">.</span>inDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    r1<span class="token punctuation">.</span>inDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">//r2 分配出去的资源和请求 r1 资源的进程</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    r2<span class="token punctuation">.</span>outDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    r2<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    r2<span class="token punctuation">.</span>inDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">//        r2.inDegreeNodes.put(p1, 1);</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    r2<span class="token punctuation">.</span>inDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">//p1 申请的资源和被分配的资源</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    p1<span class="token punctuation">.</span>outDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">//        p1.outDegreeNodes.put(r2, 1);</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    p1<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r2<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    p1<span class="token punctuation">.</span>inDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    p1<span class="token punctuation">.</span>inDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">//p2 申请的资源和被分配的资源</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    p2<span class="token punctuation">.</span>outDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    p2<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    p2<span class="token punctuation">.</span>inDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    p2<span class="token punctuation">.</span>inDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// 建立资源分配图</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token class-name">ResourceAllocationGraph</span> graph <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceAllocationGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    graph<span class="token punctuation">.</span>processes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    graph<span class="token punctuation">.</span>processes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    graph<span class="token punctuation">.</span>processes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    graph<span class="token punctuation">.</span>resources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    graph<span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    graph<span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">return</span> graph<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>step 2 : 死锁检测，true : 死锁，false : 不产生死锁</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasDeadlock</span><span class="token punctuation">(</span><span class="token class-name">ResourceAllocationGraph</span> graph<span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> isolated<span class="token punctuation">,</span> <span class="token keyword">int</span> cnt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">//1. 找出即不阻塞又不是孤立的进程 pi</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">//  即找出一条有向边与它相连，且该有向边对应资源的申请数量小于等于系统中已有空闲资源数量</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> processes <span class="token operator">=</span> graph<span class="token punctuation">.</span>processes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 所有的 pi 都孤立了</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 可能有多个</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> pis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">//pi 申请的资源必须全部满足条件</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> processes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 说明 pi 已经被孤立了</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isolated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">Node</span> pi <span class="token operator">=</span> processes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">//pi 申请的资源节点剩余资源 >= pi 申请的资源</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> entry <span class="token operator">:</span> pi<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token class-name">Node</span> node <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>val <span class="token operator">&lt;</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            pis<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// 没有 pi , 产生了死锁</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pis<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">//2. pi 释放资源</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pis<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token class-name">Node</span> pi <span class="token operator">=</span> pis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token comment">//pi 对应申请的相应资源节点， 释放 pi</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        pi<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> integer<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            node<span class="token punctuation">.</span>inDegreeNodes<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token comment">// 分配给 pi 的相应资源节点 增加相应的资源数，并释放 pi</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        pi<span class="token punctuation">.</span>inDegreeNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> integer<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            node<span class="token punctuation">.</span>val <span class="token operator">+=</span> integer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            node<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token comment">// 让 pi 孤立</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        isolated<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        cnt<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">// 递归地检测， 没有死锁 false, 有死锁 true</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">hasDeadlock</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> isolated<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>整体代码</strong></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadlockDetection</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token comment">//1. 构建资源分配图</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">DeadlockDetection</span> deadlockDetection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeadlockDetection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">ResourceAllocationGraph</span> graph <span class="token operator">=</span> deadlockDetection<span class="token punctuation">.</span><span class="token function">builderResourceGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">//2. 死锁检测，true : 死锁，false : 不产生死锁</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>deadlockDetection<span class="token punctuation">.</span><span class="token function">hasDeadlock</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span>graph<span class="token punctuation">.</span>processes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> graph<span class="token punctuation">.</span>processes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasDeadlock</span><span class="token punctuation">(</span><span class="token class-name">ResourceAllocationGraph</span> graph<span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> isolated<span class="token punctuation">,</span> <span class="token keyword">int</span> cnt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">//1. 找出即不阻塞又不是孤立的进程 pi</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">//  即找出一条有向边与它相连，且该有向边对应资源的申请数量小于等于系统中已有空闲资源数量</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> processes <span class="token operator">=</span> graph<span class="token punctuation">.</span>processes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 所有的 pi 都孤立了</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 可能有多个</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> pis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">//pi 申请的资源必须全部满足条件</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> processes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token comment">// 说明 pi 已经被孤立了</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isolated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token class-name">Node</span> pi <span class="token operator">=</span> processes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token comment">//pi 申请的资源节点剩余资源 >= pi 申请的资源</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> entry <span class="token operator">:</span> pi<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token class-name">Node</span> node <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>val <span class="token operator">&lt;</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                    flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                pis<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// 没有 pi , 产生了死锁</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pis<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token comment">//2. pi 释放资源</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pis<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token class-name">Node</span> pi <span class="token operator">=</span> pis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token comment">//pi 对应申请的相应资源节点， 释放 pi</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            pi<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> integer<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                node<span class="token punctuation">.</span>inDegreeNodes<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token comment">// 分配给 pi 的相应资源节点 增加相应的资源数，并释放 pi</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            pi<span class="token punctuation">.</span>inDegreeNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> integer<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                node<span class="token punctuation">.</span>val <span class="token operator">+=</span> integer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                node<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token comment">// 让 pi 孤立</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            isolated<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            cnt<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token comment">// 递归地检测， 没有死锁 false, 有死锁 true</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">hasDeadlock</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> isolated<span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ResourceAllocationGraph</span> <span class="token function">builderResourceGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token comment">// 资源</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token class-name">Node</span> r1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token class-name">Node</span> r2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token comment">// 进程</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment">//        Node p1 = new Node(false, 1);</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token class-name">Node</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token class-name">Node</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token comment">//r1 分配出去的资源和请求 r1 资源的进程</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        r1<span class="token punctuation">.</span>outDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        r1<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        r1<span class="token punctuation">.</span>inDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        r1<span class="token punctuation">.</span>inDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token comment">//r2 分配出去的资源和请求 r1 资源的进程</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        r2<span class="token punctuation">.</span>outDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        r2<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        r2<span class="token punctuation">.</span>inDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token comment">//        r2.inDegreeNodes.put(p1, 1);</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        r2<span class="token punctuation">.</span>inDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token comment">//p1 申请的资源和被分配的资源</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        p1<span class="token punctuation">.</span>outDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token comment">//        p1.outDegreeNodes.put(r2, 1);</span></pre></td></tr><tr><td data-num="87"></td><td><pre>        p1<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r2<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        p1<span class="token punctuation">.</span>inDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        p1<span class="token punctuation">.</span>inDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token comment">//p2 申请的资源和被分配的资源</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        p2<span class="token punctuation">.</span>outDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        p2<span class="token punctuation">.</span>outDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        p2<span class="token punctuation">.</span>inDegreeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        p2<span class="token punctuation">.</span>inDegreeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>        <span class="token comment">// 建立资源分配图</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token class-name">ResourceAllocationGraph</span> graph <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceAllocationGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        graph<span class="token punctuation">.</span>processes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>        graph<span class="token punctuation">.</span>processes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        graph<span class="token punctuation">.</span>processes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>        graph<span class="token punctuation">.</span>resources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        graph<span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>        graph<span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>        <span class="token keyword">return</span> graph<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token comment">// 资源分配图</span></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">ResourceAllocationGraph</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="110"></td><td><pre>     * 对于 Map&lt;Node, List&lt;Pair>> map</pre></td></tr><tr><td data-num="111"></td><td><pre>     * 若 Node 为进程则 List&lt;Pair> 为申请某些资源数量，</pre></td></tr><tr><td data-num="112"></td><td><pre>     * 例如：P1 (false, 1) : [Pair (R1, 1)]</pre></td></tr><tr><td data-num="113"></td><td><pre>     * 表示 p1 请求资源的总数量为 1, 申请资源 R1 的数量为 1</pre></td></tr><tr><td data-num="114"></td><td><pre>     * 若 Node 为资源则 List&lt;Pair> 为分配给进程的资源数量</pre></td></tr><tr><td data-num="115"></td><td><pre>     * 例如：R1 (true, 0) : [Pair (P1, 2), Pair (P2, 1)]</pre></td></tr><tr><td data-num="116"></td><td><pre>     * 表示 R1 剩余资源为 0, 分配给 P1, p2 的资源数分别为 2, 1</pre></td></tr><tr><td data-num="117"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="118"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> processes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> resources<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="121"></td><td><pre></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>    <span class="token comment">// 是否是资源的标志， true : 资源， false : 进程</span></pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token keyword">boolean</span> isResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre></pre></td></tr><tr><td data-num="126"></td><td><pre>    <span class="token comment">// 若为资源：当前剩余资源的总数量</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token comment">// 若为进程：当前进程请求资源的总数量</span></pre></td></tr><tr><td data-num="128"></td><td><pre>    <span class="token keyword">int</span> val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre></pre></td></tr><tr><td data-num="130"></td><td><pre>    <span class="token comment">// 进程: pi 被分配的资源的节点 + 相应的分配数</span></pre></td></tr><tr><td data-num="131"></td><td><pre>    <span class="token comment">// 资源: ri 被请求的进程节点 + 相应的请求数</span></pre></td></tr><tr><td data-num="132"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> inDegreeNodes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre></pre></td></tr><tr><td data-num="134"></td><td><pre>    <span class="token comment">// 进程：pi 申请的资源节点 + 相应的申请数</span></pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token comment">// 资源: ri 分配出去的进程节点 + 相应的分配数</span></pre></td></tr><tr><td data-num="136"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> outDegreeNodes<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isResource<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>isResource <span class="token operator">=</span> isResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="141"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="死锁定理"><a class="anchor" href="#死锁定理">#</a> 死锁定理</h5>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>死锁定理</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}死锁定理</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">死锁定理</span></span></span></span>：如果某时刻系统的资源分配图是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>不可完全简化</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}不可完全简化</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">不可完全简化</span></span></span></span>的，那么此时系统<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>死锁</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}死锁</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">死锁</span></span></span></span></p>
<hr />
<h4 id="死锁的解除"><a class="anchor" href="#死锁的解除">#</a> 死锁的解除</h4>
<p>一旦检测出死锁的发生，就应该立即解除死锁。</p>
<p><strong>补充</strong>：并不是系统中所有的进程都是死锁状态，用死锁检测算法<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>化简资源分配图后，还连着边的那些进程就是死锁进程</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}化简资源分配图后，还连着边的那些进程就是死锁进程</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">化简资源分配图后，还连着边的那些进程就是死锁进程</span></span></span></span></p>
<hr />
<h5 id="资源剥夺法"><a class="anchor" href="#资源剥夺法">#</a> 资源剥夺法</h5>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>资源剥夺法</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}资源剥夺法</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">资源剥夺法</span></span></span></span>：</p>
<ul>
<li><strong>挂起（暂时放到外存上）某些死锁进程，并抢占它的资源，将这些资源分配给其他的死锁进程。</strong></li>
<li>但是应防止被挂起的进程长时间得不到资源而 <code>饥饿</code> 。</li>
</ul>
<hr />
<h5 id="撤销进程法终止进程法"><a class="anchor" href="#撤销进程法终止进程法">#</a> 撤销进程法 (终止进程法)</h5>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>撤销进程法</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}撤销进程法</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">撤销进程法</span></span></span></span>（或称<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>终止进程法</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}终止进程法</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">终止进程法</span></span></span></span>）：</p>
<ul>
<li><strong>强制撤销部分、甚至全部死锁进程，并剥夺这些进程的资源。</strong></li>
</ul>
<p>这种方式的优点是实现简单，但所付出的代价可能会很大。</p>
<ul>
<li>因为有些进程可能已经运行了很长时间，已经接近结束了，一旦被终止可谓 <code>功亏一篑</code> ，以后还得从头再来。</li>
</ul>
<hr />
<h5 id="进程回退法"><a class="anchor" href="#进程回退法">#</a> 进程回退法</h5>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="red"><mtext>进程回退法</mtext></mstyle></mrow><annotation encoding="application/x-tex">\color{red}进程回退法</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord cjk_fallback" style="color:red;">进程回退法</span></span></span></span>：</p>
<ul>
<li><strong>让一个或多个死锁进程回退到足以避免死锁的地步。</strong></li>
<li>这就要求系统要记录进程的历史信息，设置 <code>还原点</code> 。</li>
</ul>
<hr />
<h5 id="如何决定-对谁动手"><a class="anchor" href="#如何决定-对谁动手">#</a> 如何决定 &quot;对谁动手&quot;</h5>
<p><strong>① 进程优先级</strong></p>
<ul>
<li>例如：进程优先级低的对其下手</li>
</ul>
<p><strong>② 已执行多长时间</strong></p>
<ul>
<li>例如：执行时间更少的进程，让其牺牲</li>
</ul>
<p><strong>③ 还要多久能完成</strong></p>
<ul>
<li>例如：牺牲掉还需要更长的时间完成，优先让即将完成的进程获得资源</li>
</ul>
<p><strong>④ 进程已经使用了多少资源</strong></p>
<ul>
<li>例如：优先牺牲掉已经使用更多资源的进程</li>
</ul>
<p><strong>⑤ 进程是交互式的还是批处理式的</strong></p>
<ul>
<li>
<p>若牺牲掉交互式的（即：正在与用户交互的进程），则用户不满意</p>
</li>
<li>
<p>批处理式的无非就是在做一些计算，对用户的及时反馈并不那么在意</p>
</li>
<li>
<p>所以优先牺牲掉批处理式的</p>
</li>
</ul>
<h4 id="整体框架-16"><a class="anchor" href="#整体框架-16">#</a> 整体框架</h4>
<p><img loading="lazy" data-src="https://gitcode.net/qq_67720621/img/-/raw/master/typora-user-images-new/image-20230206011904751.png" alt="image-20230206011904751" /></p>
</div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2023-06-13 21:31:07" itemprop="dateModified" datetime="2023-06-13T21:31:07+08:00">2023-06-13</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.png" alt="htired 微信支付"/><p>微信支付</p></div><div><img loading="lazy" data-src="/assets/alipay.png" alt="htired 支付宝"/><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>htired：</strong>htired<i class="ic i-at"><em>@</em></i>何必要叹气呢？</li><li class="link"><strong>本文链接：</strong><a href="https://www.htired.top/2023/06/02/os/2%E3%80%81%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/" title="2、进程管理">https://www.htired.top/2023/06/02/os/2、进程管理/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2023/06/02/os/1%E3%80%81%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;github.com&#x2F;htired&#x2F;MyPic&#x2F;blob&#x2F;main&#x2F;img&#x2F;4fc551ee880a11ebb6edd017c2d2eca2.jpg?raw&#x3D;true" title="1、操作系统概述"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>操作系统</span><h3>1、操作系统概述</h3></a></div><div class="item right"><a href="/2023/06/02/os/3%E3%80%81%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;github.com&#x2F;htired&#x2F;MyPic&#x2F;blob&#x2F;main&#x2F;img&#x2F;81d1da7e1ba142629967fea196c73e0e.jpg?raw&#x3D;true" title="3、内存管理"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>操作系统</span><h3>3、内存管理</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%AE%9A%E4%B9%89-%E7%BB%84%E6%88%90-%E7%BB%84%E7%BB%87%E6%96%B9%E5%BC%8F-%E7%89%B9%E5%BE%81"><span class="toc-number">1.</span> <span class="toc-text"> 进程的定义、组成、组织方式、特征</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.</span> <span class="toc-text"> 进程的定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%BB%84%E6%88%90"><span class="toc-number">1.2.</span> <span class="toc-text"> 进程的组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%BB%84%E7%BB%87"><span class="toc-number">1.3.</span> <span class="toc-text"> 进程的组织</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 链接方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 索引方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%89%B9%E5%BE%81"><span class="toc-number">1.4.</span> <span class="toc-text"> 进程的特征</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6"><span class="toc-number">1.5.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%8A%B6%E6%80%81%E4%B8%8E%E8%BD%AC%E6%8D%A2"><span class="toc-number">2.</span> <span class="toc-text"> 进程的状态与转换</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E5%9F%BA%E6%9C%AC%E7%8A%B6%E6%80%81"><span class="toc-number">2.1.</span> <span class="toc-text"> 三种基本状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%A6%E5%A4%96%E4%B8%A4%E7%A7%8D%E7%8A%B6%E6%80%81"><span class="toc-number">2.2.</span> <span class="toc-text"> 另外两种状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="toc-number">2.3.</span> <span class="toc-text"> 进程状态的转换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-2"><span class="toc-number">2.4.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="toc-number">3.</span> <span class="toc-text"> 进程控制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="toc-number">3.1.</span> <span class="toc-text"> 什么是进程控制？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="toc-number">3.2.</span> <span class="toc-text"> 如何实现进程控制？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6-2"><span class="toc-number">3.2.1.</span> <span class="toc-text"> 进程控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E8%AF%AD"><span class="toc-number">3.2.2.</span> <span class="toc-text"> 原语</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6%E7%9B%B8%E5%85%B3%E7%9A%84%E5%8E%9F%E8%AF%AD"><span class="toc-number">3.2.3.</span> <span class="toc-text"> 进程控制相关的原语</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA%E5%8E%9F%E8%AF%AD"><span class="toc-number">3.2.3.1.</span> <span class="toc-text"> 进程的创建原语</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%BB%88%E6%AD%A2%E5%8E%9F%E8%AF%AD"><span class="toc-number">3.2.3.2.</span> <span class="toc-text"> 进程的终止原语</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E9%98%BB%E5%A1%9E%E5%92%8C%E5%94%A4%E9%86%92%E5%8E%9F%E8%AF%AD"><span class="toc-number">3.2.3.3.</span> <span class="toc-text"> 进程的阻塞和唤醒原语</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%88%87%E6%8D%A2%E5%8E%9F%E8%AF%AD"><span class="toc-number">3.2.3.4.</span> <span class="toc-text"> 进程的切换原语</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-3"><span class="toc-number">3.3.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1"><span class="toc-number">4.</span> <span class="toc-text"> 进程通信</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1"><span class="toc-number">4.1.</span> <span class="toc-text"> 什么是进程通信？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8"><span class="toc-number">4.2.</span> <span class="toc-text"> 共享存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E9%81%93%E9%80%9A%E4%BF%A1"><span class="toc-number">4.3.</span> <span class="toc-text"> 管道通信</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92"><span class="toc-number">4.4.</span> <span class="toc-text"> 消息传递</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F"><span class="toc-number">4.4.1.</span> <span class="toc-text"> 直接通信方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%B4%E6%8E%A5%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F"><span class="toc-number">4.4.2.</span> <span class="toc-text"> 间接通信方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-4"><span class="toc-number">4.5.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%A6%82%E5%BF%B5%E5%92%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text"> 线程概念和多线程模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BC%95%E5%85%A5%E7%BA%BF%E7%A8%8B"><span class="toc-number">5.1.</span> <span class="toc-text"> 什么是线程，为什么要引入线程？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E7%BA%BF%E7%A8%8B%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-number">5.2.</span> <span class="toc-text"> 引入线程带来的变化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">5.3.</span> <span class="toc-text"> 线程的属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">5.4.</span> <span class="toc-text"> 线程的实现方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%BA%A7%E7%BA%BF%E7%A8%8Buser-level-threadult"><span class="toc-number">5.4.1.</span> <span class="toc-text"> 用户级线程 (User-Level Thread,ULT)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E7%BA%A7%E7%BA%BF%E7%A8%8Bkernel-level-thread-klt"><span class="toc-number">5.4.2.</span> <span class="toc-text"> 内核级线程 (Kernel-Level Thread, KLT)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E8%80%85%E7%BB%84%E5%90%88"><span class="toc-number">5.4.3.</span> <span class="toc-text"> 二者组合</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.5.</span> <span class="toc-text"> 多线程模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E4%B8%80%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.5.1.</span> <span class="toc-text"> 多对一模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.5.2.</span> <span class="toc-text"> 一对一模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.5.3.</span> <span class="toc-text"> 多对多模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-5"><span class="toc-number">5.6.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%9C%BA%E8%B0%83%E5%BA%A6%E7%9A%84%E6%A6%82%E5%BF%B5-%E5%B1%82%E6%AC%A1"><span class="toc-number">6.</span> <span class="toc-text"> 处理机调度的概念、层次</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">6.1.</span> <span class="toc-text"> 调度的基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E7%9A%84%E4%B8%89%E4%B8%AA%E5%B1%82%E6%AC%A1"><span class="toc-number">6.2.</span> <span class="toc-text"> 调度的三个层次</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E8%B0%83%E5%BA%A6"><span class="toc-number">6.2.1.</span> <span class="toc-text"> 高级调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E7%BA%A7%E8%B0%83%E5%BA%A6"><span class="toc-number">6.2.2.</span> <span class="toc-text"> 中级调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%8C%82%E8%B5%B7%E6%80%81%E4%B8%8E%E4%B8%83%E7%8A%B6%E6%80%81%E6%A8%A1%E5%9E%8B"><span class="toc-number">6.2.3.</span> <span class="toc-text"> 进程的挂起态与七状态模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%8E%E7%BA%A7%E8%B0%83%E5%BA%A6"><span class="toc-number">6.2.4.</span> <span class="toc-text"> 低级调度</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E5%B1%82%E8%B0%83%E5%BA%A6%E7%9A%84%E8%81%94%E7%B3%BB-%E5%AF%B9%E6%AF%94"><span class="toc-number">6.3.</span> <span class="toc-text"> 三层调度的联系、对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-6"><span class="toc-number">6.4.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA-%E5%88%87%E6%8D%A2%E4%B8%8E%E8%BF%87%E7%A8%8B-%E6%96%B9%E5%BC%8F"><span class="toc-number">7.</span> <span class="toc-text"> 进程调度的时机、切换与过程、方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="toc-number">7.1.</span> <span class="toc-text"> 进程调度的时机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">7.2.</span> <span class="toc-text"> 进程调度的方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E5%89%A5%E5%A4%BA%E6%96%B9%E5%BC%8F%E9%9D%9E%E6%8A%A2%E5%8D%A0%E6%96%B9%E5%BC%8F"><span class="toc-number">7.2.1.</span> <span class="toc-text"> 非剥夺方式（非抢占方式）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%A5%E5%A4%BA%E8%B0%83%E5%BA%A6%E6%96%B9%E5%BC%8F%E6%8A%A2%E5%8D%A0%E6%96%B9%E5%BC%8F"><span class="toc-number">7.2.2.</span> <span class="toc-text"> 剥夺调度方式（抢占方式）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%88%87%E6%8D%A2%E4%B8%8E%E8%BF%87%E7%A8%8B"><span class="toc-number">7.3.</span> <span class="toc-text"> 进程的切换与过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8B%AD%E4%B9%89%E7%9A%84%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6-%E4%B8%8E-%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">7.3.1.</span> <span class="toc-text"> &quot;狭义的进程调度&quot; 与 &quot;进程切换&quot; 的区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-7"><span class="toc-number">7.4.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95%E7%9A%84%E8%AF%84%E4%BB%B7%E6%8C%87%E6%A0%87"><span class="toc-number">8.</span> <span class="toc-text"> 调度算法的评价指标</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#cpu-%E5%88%A9%E7%94%A8%E7%8E%87"><span class="toc-number">8.1.</span> <span class="toc-text"> CPU 利用率</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%90%9E%E5%90%90%E9%87%8F"><span class="toc-number">8.2.</span> <span class="toc-text"> 系统吞吐量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%A8%E8%BD%AC%E6%97%B6%E9%97%B44%E4%B8%AA%E6%8C%87%E6%A0%87"><span class="toc-number">8.3.</span> <span class="toc-text"> 周转时间 (4 个指标)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%89%E5%BE%85%E6%97%B6%E9%97%B4"><span class="toc-number">8.4.</span> <span class="toc-text"> 等待时间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4"><span class="toc-number">8.5.</span> <span class="toc-text"> 响应时间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-8"><span class="toc-number">8.6.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#fcfs-sjf-hrrn-%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="toc-number">9.</span> <span class="toc-text"> FCFS、SJF、HRRN 调度算法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#fcfs"><span class="toc-number">9.1.</span> <span class="toc-text"> FCFS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sjf"><span class="toc-number">9.2.</span> <span class="toc-text"> SJF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E6%8A%A2%E5%8D%A0%E5%BC%8F%E7%9A%84-sjf"><span class="toc-number">9.2.1.</span> <span class="toc-text"> 非抢占式的 SJF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A2%E5%8D%A0%E5%BC%8F%E7%9A%84-sjf%E6%9C%80%E7%9F%AD%E5%89%A9%E4%BD%99%E6%97%B6%E9%97%B4%E4%BC%98%E5%85%88%E7%AE%97%E6%B3%95srtn"><span class="toc-number">9.2.2.</span> <span class="toc-text"> 抢占式的 SJF（最短剩余时间优先算法 SRTN）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F"><span class="toc-number">9.2.3.</span> <span class="toc-text"> 注意</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E8%80%85%E6%80%9D%E8%80%83"><span class="toc-number">9.3.</span> <span class="toc-text"> 二者思考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hrrn"><span class="toc-number">9.4.</span> <span class="toc-text"> HRRN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">9.5.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%89%87%E8%BD%AE%E8%BD%AC-%E4%BC%98%E5%85%88%E7%BA%A7%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95-%E5%A4%9A%E7%BA%A7%E5%8F%8D%E9%A6%88%E9%98%9F%E5%88%97%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="toc-number">10.</span> <span class="toc-text"> 时间片轮转、优先级调度算法、多级反馈队列调度算法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%89%87%E8%BD%AE%E8%BD%ACrr-round-robin"><span class="toc-number">10.1.</span> <span class="toc-text"> 时间片轮转（RR, Round-Robin）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">10.1.1.</span> <span class="toc-text"> 例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%89%87%E5%A4%AA%E5%A4%A7%E5%B0%8F%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">10.1.2.</span> <span class="toc-text"> 时间片太大 &#x2F; 小的影响</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%85%88%E7%BA%A7%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="toc-number">10.2.</span> <span class="toc-text"> 优先级调度算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E6%8A%A2%E5%8D%A0%E5%BC%8F%E7%9A%84"><span class="toc-number">10.2.1.</span> <span class="toc-text"> 非抢占式的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A2%E5%8D%A0%E5%BC%8F%E7%9A%84"><span class="toc-number">10.2.2.</span> <span class="toc-text"> 抢占式的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%8A%A8%E6%80%81%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">10.2.3.</span> <span class="toc-text"> 静态 &#x2F; 动态优先级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E5%8F%8D%E9%A6%88%E9%98%9F%E5%88%97%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="toc-number">10.3.</span> <span class="toc-text"> 多级反馈队列调度算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-number">10.4.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5%E4%B8%8E%E4%BA%92%E6%96%A5"><span class="toc-number">11.</span> <span class="toc-text"> 进程同步与互斥</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5"><span class="toc-number">11.1.</span> <span class="toc-text"> 什么是进程同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E9%A1%BE%E5%BC%82%E6%AD%A5%E6%80%A7"><span class="toc-number">11.1.1.</span> <span class="toc-text"> 回顾异步性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E9%A1%BE%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1-%E7%AE%A1%E9%81%93%E9%80%9A%E4%BF%A1"><span class="toc-number">11.1.2.</span> <span class="toc-text"> 回顾进程通信 -- 管道通信</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E7%9B%B4%E6%8E%A5%E5%88%B6%E7%BA%A6%E5%85%B3%E7%B3%BB"><span class="toc-number">11.1.3.</span> <span class="toc-text"> 同步（直接制约关系）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%BA%92%E6%96%A5%E9%97%B4%E6%8E%A5%E5%88%B6%E7%BA%A6%E5%85%B3%E7%B3%BB"><span class="toc-number">11.2.</span> <span class="toc-text"> 进程互斥（间接制约关系）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E4%B8%B4%E7%95%8C%E8%B5%84%E6%BA%90%E7%9A%84%E4%BA%92%E6%96%A5%E8%AE%BF%E9%97%AE%E5%9B%9B%E4%B8%AA%E9%83%A8%E5%88%86"><span class="toc-number">11.2.1.</span> <span class="toc-text"> 对临界资源的互斥访问（四个部分）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%B5%E5%BE%AA%E7%9A%84%E5%8E%9F%E5%88%99"><span class="toc-number">11.2.2.</span> <span class="toc-text"> 遵循的原则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-9"><span class="toc-number">11.3.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%BA%92%E6%96%A5%E7%9A%84%E8%BD%AF%E4%BB%B6%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95"><span class="toc-number">12.</span> <span class="toc-text"> 进程互斥的软件实现方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E6%A0%87%E5%BF%97%E6%B3%95"><span class="toc-number">12.1.</span> <span class="toc-text"> 单标志法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E6%A0%87%E5%BF%97%E5%85%88%E6%A3%80%E6%9F%A5%E6%B3%95"><span class="toc-number">12.2.</span> <span class="toc-text"> 双标志先检查法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E6%A0%87%E5%BF%97%E5%90%8E%E6%A3%80%E6%9F%A5%E6%B3%95"><span class="toc-number">12.3.</span> <span class="toc-text"> 双标志后检查法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#peterson-%E7%AE%97%E6%B3%95"><span class="toc-number">12.4.</span> <span class="toc-text"> Peterson 算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-10"><span class="toc-number">12.5.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%BA%92%E6%96%A5%E7%9A%84%E7%A1%AC%E4%BB%B6%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95"><span class="toc-number">13.</span> <span class="toc-text"> 进程互斥的硬件实现方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E5%B1%8F%E8%94%BD%E6%96%B9%E6%B3%95"><span class="toc-number">13.1.</span> <span class="toc-text"> 中断屏蔽方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#testandset"><span class="toc-number">13.2.</span> <span class="toc-text"> TestAndSet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#swap%E6%8C%87%E4%BB%A4"><span class="toc-number">13.3.</span> <span class="toc-text"> Swap 指令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-11"><span class="toc-number">13.4.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6"><span class="toc-number">14.</span> <span class="toc-text"> 信号量机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E5%BD%A2%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="toc-number">14.1.</span> <span class="toc-text"> 整形信号量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E5%9E%8B%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="toc-number">14.2.</span> <span class="toc-text"> 记录型信号量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-12"><span class="toc-number">14.3.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E8%BF%9B%E7%A8%8B%E4%BA%92%E6%96%A5-%E5%90%8C%E6%AD%A5-%E5%89%8D%E9%A9%B1%E5%85%B3%E7%B3%BB"><span class="toc-number">15.</span> <span class="toc-text"> 用信号量机制实现进程互斥、同步、前驱关系</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E8%BF%9B%E7%A8%8B%E4%BA%92%E6%96%A5"><span class="toc-number">15.1.</span> <span class="toc-text"> 信号量机制实现进程互斥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5"><span class="toc-number">15.2.</span> <span class="toc-text"> 用信号量机制实现进程同步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E5%89%8D%E9%A9%B1%E5%85%B3%E7%B3%BB"><span class="toc-number">15.3.</span> <span class="toc-text"> 用信号量机制实现前驱关系！！</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-13"><span class="toc-number">15.4.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98"><span class="toc-number">16.</span> <span class="toc-text"> 生产者 - 消费者问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#pv-%E6%93%8D%E4%BD%9C%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90%E6%AD%A5%E9%AA%A4"><span class="toc-number">16.1.</span> <span class="toc-text"> PV 操作题目分析步骤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%BD%E5%90%A6%E6%94%B9%E5%8F%98%E7%9B%B8%E9%82%BB-p-v-%E6%93%8D%E4%BD%9C%E7%9A%84%E9%A1%BA%E5%BA%8F"><span class="toc-number">16.2.</span> <span class="toc-text"> 能否改变相邻 P、V 操作的顺序？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#java-%E6%A1%88%E4%BE%8B"><span class="toc-number">16.3.</span> <span class="toc-text"> Java 案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-3"><span class="toc-number">16.4.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E7%94%9F%E4%BA%A7%E8%80%85-%E5%A4%9A%E6%B6%88%E8%B4%B9%E8%80%85%E8%BF%9B%E7%A8%8B"><span class="toc-number">17.</span> <span class="toc-text"> 多生产者 - 多消费者进程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">17.1.</span> <span class="toc-text"> 问题分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">17.2.</span> <span class="toc-text"> 具体实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#java-%E6%A1%88%E4%BE%8B-2"><span class="toc-number">17.3.</span> <span class="toc-text"> Java 案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-4"><span class="toc-number">17.4.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%B8%E7%83%9F%E8%80%85%E9%97%AE%E9%A2%98"><span class="toc-number">18.</span> <span class="toc-text"> 吸烟者问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-2"><span class="toc-number">18.1.</span> <span class="toc-text"> 问题分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">18.2.</span> <span class="toc-text"> 具体实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#java-%E6%A1%88%E4%BE%8B-3"><span class="toc-number">18.3.</span> <span class="toc-text"> Java 案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-5"><span class="toc-number">18.4.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%BB%E8%80%85-%E5%86%99%E8%80%85%E9%97%AE%E9%A2%98"><span class="toc-number">19.</span> <span class="toc-text"> 读者 - 写者问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-3"><span class="toc-number">19.1.</span> <span class="toc-text"> 问题分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0-3"><span class="toc-number">19.2.</span> <span class="toc-text"> 具体实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-6"><span class="toc-number">19.3.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%93%B2%E5%AD%A6%E5%AE%B6%E8%BF%9B%E9%A4%90%E9%97%AE%E9%A2%98"><span class="toc-number">20.</span> <span class="toc-text"> 哲学家进餐问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-4"><span class="toc-number">20.1.</span> <span class="toc-text"> 问题分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81%E7%9A%84%E5%8F%91%E7%94%9F%E5%91%A2%E9%99%84-java-%E5%AE%9E%E7%8E%B0"><span class="toc-number">20.2.</span> <span class="toc-text"> 如何避免死锁的发生呢？（附 Java 实现）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%8D%E8%BF%90%E7%AE%97-cas-%E4%BC%98%E5%8C%96"><span class="toc-number">20.3.</span> <span class="toc-text"> 位运算 + CAS 优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-7"><span class="toc-number">20.4.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%A1%E7%A8%8B"><span class="toc-number">21.</span> <span class="toc-text"> 管程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BC%95%E5%85%A5%E7%AE%A1%E7%A8%8B"><span class="toc-number">21.1.</span> <span class="toc-text"> 为什么要引入管程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%A8%8B%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%89%B9%E5%BE%81"><span class="toc-number">21.2.</span> <span class="toc-text"> 管程的定义和基本特征</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%93%E5%B1%951%E7%94%A8%E7%AE%A1%E7%A8%8B%E8%A7%A3%E5%86%B3%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98"><span class="toc-number">21.3.</span> <span class="toc-text"> 拓展 1∶用管程解决生产者消费者问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%93%E5%B1%952java-%E4%B8%AD%E7%B1%BB%E4%BC%BC%E4%BA%8E%E7%AE%A1%E7%A8%8B%E7%9A%84%E6%9C%BA%E5%88%B6"><span class="toc-number">21.4.</span> <span class="toc-text"> 拓展 2：Java 中类似于管程的机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-14"><span class="toc-number">21.5.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%AD%BB%E9%94%81"><span class="toc-number">22.</span> <span class="toc-text"> 死锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">22.1.</span> <span class="toc-text"> 死锁的概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E9%94%81"><span class="toc-number">22.1.1.</span> <span class="toc-text"> 什么是死锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E9%94%81-%E9%A5%A5%E9%A5%BF-%E6%AD%BB%E5%BE%AA%E7%8E%AF%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">22.1.2.</span> <span class="toc-text"> 死锁、饥饿、死循环的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E4%BA%A7%E7%94%9F%E7%9A%84%E5%BF%85%E8%A6%81%E6%9D%A1%E4%BB%B6"><span class="toc-number">22.1.3.</span> <span class="toc-text"> 死锁产生的必要条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BC%9A%E5%8F%91%E7%94%9F%E6%AD%BB%E9%94%81"><span class="toc-number">22.1.4.</span> <span class="toc-text"> 什么时候会发生死锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E7%9A%84%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-number">22.1.5.</span> <span class="toc-text"> 死锁的处理策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-15"><span class="toc-number">22.1.6.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E7%9A%84%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5-2"><span class="toc-number">22.2.</span> <span class="toc-text"> 死锁的处理策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E9%98%B2%E6%AD%BB%E9%94%81"><span class="toc-number">22.2.1.</span> <span class="toc-text"> 预防死锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A0%B4%E5%9D%8F%E4%BA%92%E6%96%A5%E6%9D%A1%E4%BB%B6"><span class="toc-number">22.2.1.1.</span> <span class="toc-text"> 破坏互斥条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A0%B4%E5%9D%8F%E4%B8%8D%E5%89%A5%E5%A4%BA%E6%9D%A1%E4%BB%B6"><span class="toc-number">22.2.1.2.</span> <span class="toc-text"> 破坏不剥夺条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A0%B4%E5%9D%8F%E8%AF%B7%E6%B1%82%E5%92%8C%E4%BF%9D%E6%8C%81%E6%9D%A1%E4%BB%B6"><span class="toc-number">22.2.1.3.</span> <span class="toc-text"> 破坏请求和保持条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A0%B4%E5%9D%8F%E5%BE%AA%E7%8E%AF%E7%AD%89%E5%BE%85%E6%9D%A1%E4%BB%B6"><span class="toc-number">22.2.1.4.</span> <span class="toc-text"> 破坏循环等待条件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81%E9%93%B6%E8%A1%8C%E5%AE%B6%E7%AE%97%E6%B3%95"><span class="toc-number">22.2.2.</span> <span class="toc-text"> 避免死锁（银行家算法）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%AE%89%E5%85%A8%E5%BA%8F%E5%88%97"><span class="toc-number">22.2.2.1.</span> <span class="toc-text"> 什么是安全序列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%BA%8F%E5%88%97-%E4%B8%8D%E5%AE%89%E5%85%A8%E7%8A%B6%E6%80%81-%E6%AD%BB%E9%94%81%E7%9A%84%E8%81%94%E7%B3%BB"><span class="toc-number">22.2.2.2.</span> <span class="toc-text"> 安全序列、不安全状态、死锁的联系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%B6%E8%A1%8C%E5%AE%B6%E7%AE%97%E6%B3%95"><span class="toc-number">22.2.2.3.</span> <span class="toc-text"> 银行家算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#java-%E5%AE%9E%E7%8E%B0%E9%93%B6%E8%A1%8C%E5%AE%B6%E7%AE%97%E6%B3%95"><span class="toc-number">22.2.2.4.</span> <span class="toc-text"> Java 实现银行家算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-8"><span class="toc-number">22.2.2.5.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E5%92%8C%E8%A7%A3%E9%99%A4"><span class="toc-number">22.2.3.</span> <span class="toc-text"> 检测和解除</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E7%9A%84%E6%A3%80%E6%B5%8B"><span class="toc-number">22.2.3.1.</span> <span class="toc-text"> 死锁的检测</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#java-%E5%AE%9A%E4%B9%89%E8%AF%A5%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%B5%84%E6%BA%90%E5%88%86%E9%85%8D%E5%9B%BE"><span class="toc-number">22.2.3.1.1.</span> <span class="toc-text"> Java 定义该数据结构（资源分配图）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">22.2.3.1.2.</span> <span class="toc-text"> 死锁检测的流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B%E7%9A%84%E7%AE%97%E6%B3%95"><span class="toc-number">22.2.3.1.3.</span> <span class="toc-text"> 死锁检测的算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#java-%E5%AE%9E%E7%8E%B0%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B%E7%9A%84%E7%AE%97%E6%B3%95"><span class="toc-number">22.2.3.1.4.</span> <span class="toc-text"> Java 实现死锁检测的算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E5%AE%9A%E7%90%86"><span class="toc-number">22.2.3.1.5.</span> <span class="toc-text"> 死锁定理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E7%9A%84%E8%A7%A3%E9%99%A4"><span class="toc-number">22.2.3.2.</span> <span class="toc-text"> 死锁的解除</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E5%89%A5%E5%A4%BA%E6%B3%95"><span class="toc-number">22.2.3.2.1.</span> <span class="toc-text"> 资源剥夺法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%92%A4%E9%94%80%E8%BF%9B%E7%A8%8B%E6%B3%95%E7%BB%88%E6%AD%A2%E8%BF%9B%E7%A8%8B%E6%B3%95"><span class="toc-number">22.2.3.2.2.</span> <span class="toc-text"> 撤销进程法 (终止进程法)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%9B%9E%E9%80%80%E6%B3%95"><span class="toc-number">22.2.3.2.3.</span> <span class="toc-text"> 进程回退法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%86%B3%E5%AE%9A-%E5%AF%B9%E8%B0%81%E5%8A%A8%E6%89%8B"><span class="toc-number">22.2.3.2.4.</span> <span class="toc-text"> 如何决定 &quot;对谁动手&quot;</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6-16"><span class="toc-number">22.2.3.3.</span> <span class="toc-text"> 整体框架</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li ><a href="/2023/06/02/os/1%E3%80%81%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/" rel="bookmark" title="1、操作系统概述">1、操作系统概述</a></li><li  class="active"><a href="/2023/06/02/os/2%E3%80%81%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/" rel="bookmark" title="2、进程管理">2、进程管理</a></li><li ><a href="/2023/06/02/os/3%E3%80%81%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="bookmark" title="3、内存管理">3、内存管理</a></li><li ><a href="/2023/06/02/os/4%E3%80%81%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86/" rel="bookmark" title="4、文件管理">4、文件管理</a></li><li ><a href="/2023/06/02/os/5%E3%80%81%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/" rel="bookmark" title="5、设备管理">5、设备管理</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="htired" src="/assets/avatar.jpg"/><p class="name" itemprop="name">htired</p><div class="description" itemprop="description">送君南浦，伤如之何？</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">54</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">3</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">40</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/yourname" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;yourname"><i class="ic i-github"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li><li class="item"><a href="/collect/" rel="section"><i class="ic i-shoucang"></i>收藏</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2023/06/02/os/3%E3%80%81%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2023/06/02/os/1%E3%80%81%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/algorithm/" title="分类于算法">算法</a></div><span><a href="/2023/05/23/algorithm/%E5%AD%90%E6%95%B0%E7%BB%84%E8%8C%83%E5%9B%B4%E5%92%8C/">子数组范围和</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/os/" title="分类于操作系统">操作系统</a></div><span><a href="/2023/06/02/os/4%E3%80%81%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86/">4、文件管理</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/algorithm/" title="分类于算法">算法</a></div><span><a href="/2023/04/26/algorithm/%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%A8%A1%E6%9D%BF/">线段树模板</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/algorithm/" title="分类于算法">算法</a></div><span><a href="/2023/10/05/algorithm/%E8%80%83%E7%A0%94%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">考研数据结构</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/algorithm/" title="分类于算法">算法</a></div><span><a href="/2023/05/23/algorithm/%E5%AD%90%E6%95%B0%E7%BB%84%E6%9C%80%E5%B0%8F%E4%B9%98%E7%A7%AF%E7%9A%84%E6%9C%80%E5%A4%A7%E5%80%BC/">子数组最小乘积的最大值</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/algorithm/" title="分类于算法">算法</a></div><span><a href="/2023/06/08/algorithm/%E6%95%B0%E7%BB%84%E7%9A%84%E6%9C%80%E5%A4%A7%E5%85%AC%E5%9B%A0%E6%95%B0%E6%8E%92%E5%BA%8F/">数组的最大公因数排序</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/os/" title="分类于操作系统">操作系统</a></div><span><a href="/2023/06/02/os/5%E3%80%81%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/">5、设备管理</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/os/" title="分类于操作系统">操作系统</a></div><span><a href="/2023/06/02/os/1%E3%80%81%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0/">1、操作系统概述</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/algorithm/" title="分类于算法">算法</a></div><span><a href="/2023/05/09/algorithm/%E5%AD%97%E5%85%B8%E5%BA%8F%E6%9C%80%E5%B0%8F%E7%9A%84%E7%BE%8E%E4%B8%BD%E5%AD%97%E7%AC%A6%E4%B8%B2/">字典序最小的美丽字符串</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/algorithm/" title="分类于算法">算法</a></div><span><a href="/2023/05/23/algorithm/%E5%B7%AB%E5%B8%88%E7%9A%84%E6%80%BB%E5%8A%9B%E9%87%8F%E5%92%8C/">巫师的总力量和</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2024</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">htired @ Htired Love</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">666k 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">10:05</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `2023/06/02/os/2、进程管理/`,
        favicon: {
        show: `好久不见`,
        hide: `顺其自然`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: true,
    katex: true,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.11" type="module" fetchpriority="high" defer></script></body></html>